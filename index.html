<!DOCTYPE html>
<html lang="es"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de DistribuciÃ³n - FerreterÃ­a Bruzzone</title>
    
    <!-- LibrerÃ­as principales -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        /* Responsive container general */
        @media (max-width: 768px) {
            .container {
                margin: 0;
                border-radius: 0;
                box-shadow: none;
            }
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }
        
        @media (max-width: 480px) {
            .header {
                padding: 15px;
            }
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 30px;
            margin-bottom: 10px;
        }
        
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 15px;
            }
        }

        .header-logo {
            width: 150px;
            height: auto;
            background: white;
            padding: 10px;
            border-radius: 10px;
        }
        
        @media (max-width: 480px) {
            .header-logo {
                width: 80px;
            }
        }

        .header-info {
            text-align: left;
        }
        
        @media (max-width: 768px) {
            .header-info {
                text-align: center;
            }
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 5px;
        }
        
        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.5em;
            }
        }
        
        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.2em;
            }
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
            margin: 3px 0;
        }
        
        @media (max-width: 480px) {
            .header p {
                font-size: 0.9em;
            }
        }

        .header-contact {
            font-size: 0.9em;
            opacity: 0.85;
            margin-top: 10px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            padding: 30px;
            background: #f8f9fa;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-card h3 {
            color: #667eea;
            font-size: 2em;
            margin-bottom: 10px;
        }

        .stat-card p {
            color: #666;
            font-size: 0.9em;
        }

        .tabs {
            display: flex;
            flex-wrap: wrap;
            background: #f8f9fa;
            border-bottom: 2px solid #e0e0e0;
            gap: 5px;
            padding: 5px;
        }

        .tab {
            padding: 12px 20px;
            text-align: center;
            cursor: pointer;
            border: none;
            background: white;
            font-size: 0.95em;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
            border-radius: 8px 8px 0 0;
            white-space: nowrap;
        }

        .tab.active {
            background: white;
            color: #667eea;
            border-bottom: 3px solid #667eea;
            box-shadow: 0 -2px 8px rgba(102, 126, 234, 0.2);
        }

        .tab:hover {
            background: rgba(102, 126, 234, 0.1);
        }

        .tab-content {
            display: none;
            padding: 30px;
        }

        .tab-content.active {
            display: block;
        }

        .upload-zone {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 60px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #f8f9ff;
        }

        .upload-zone:hover {
            border-color: #764ba2;
            background: #f0f2ff;
        }

        .upload-zone.dragover {
            border-color: #4caf50;
            background: #e8f5e9;
        }

        .upload-zone h3 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 1.5em;
        }

        .upload-zone p {
            color: #666;
            margin-bottom: 20px;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s;
            margin: 5px;
        }

        .btn-large {
            padding: 18px 40px !important;
            font-size: 1.2em !important;
            border-radius: 12px !important;
        }

        .btn-extra-large {
            padding: 22px 50px !important;
            font-size: 1.4em !important;
            border-radius: 15px !important;
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-success {
            background: #4caf50;
            color: white;
        }

        .btn-success:hover {
            background: #45a049;
        }

        .btn-warning {
            background: #ff9800;
            color: white;
        }

        .btn-warning:hover {
            background: #f57c00;
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(255, 152, 0, 0.3);
        }

        .btn-danger {
            background: #f44336;
            color: white;
        }

        .btn-danger:hover {
            background: #da190b;
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(244, 67, 54, 0.3);
        }

        .config-panel {
            display: grid;
            gap: 20px;
            margin-bottom: 30px;
        }

        .config-group {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
        }

        .config-group h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 600;
        }

        .input-group input, .input-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
        }

        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .input-group small {
            color: #666;
            font-size: 0.85em;
            display: block;
            margin-top: 5px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        th {
            background: #667eea;
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
        }

        tr:hover {
            background: #f8f9ff;
        }

        .table-container {
            max-height: 600px;
            overflow-y: auto;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .price-highlight {
            background: #e8f5e9;
            padding: 5px 10px;
            border-radius: 5px;
            font-weight: 600;
        }

        .supplier-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 5px;
            background: #667eea;
            color: white;
            font-size: 0.85em;
            margin: 2px;
        }

        .brand-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 5px;
            background: #ff9800;
            color: white;
            font-size: 0.85em;
            margin: 2px;
        }

        .profit-indicator {
            color: #4caf50;
            font-weight: 600;
        }

        input[type="file"] {
            display: none;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }

        .order-item {
            background: #f8f9fa;
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .order-item-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .quantity-input {
            width: 80px;
            padding: 5px;
            text-align: center;
        }

        .status-badge {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-confirmed {
            background: #d1ecf1;
            color: #0c5460;
        }

        .status-delivered {
            background: #d4edda;
            color: #155724;
        }

        .status-cancelled {
            background: #f8d7da;
            color: #721c24;
        }

        .order-summary {
            background: #e8f5e9;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .order-summary h3 {
            color: #2e7d32;
            margin-bottom: 10px;
        }

        .product-selector {
            max-height: 400px;
            overflow-y: auto;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 10px;
        }

        .product-card {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border: 2px solid #e0e0e0;
            transition: all 0.3s;
            cursor: pointer;
        }

        .product-card:hover {
            border-color: #667eea;
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.2);
        }

        .product-card.selected {
            border-color: #4caf50;
            background: #f1f8f4;
        }

        .search-box {
            width: 100%;
            padding: 15px;
            border: 2px solid #667eea;
            border-radius: 8px;
            font-size: 1em;
            margin-bottom: 15px;
        }

        .search-box:focus {
            outline: none;
            border-color: #764ba2;
            box-shadow: 0 0 10px rgba(102, 126, 234, 0.3);
        }

        .login-container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 80vh;
            padding: 20px;
        }
        
        @media (max-width: 480px) {
            .login-container {
                padding: 10px;
                min-height: auto;
            }
        }

        .login-box {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            max-width: 400px;
            width: 100%;
        }
        
        @media (max-width: 480px) {
            .login-box {
                padding: 20px;
                border-radius: 10px;
            }
        }

        .login-box h2 {
            color: #667eea;
            margin-bottom: 30px;
            text-align: center;
        }
        
        @media (max-width: 480px) {
            .login-box h2 {
                font-size: 1.3em;
                margin-bottom: 20px;
            }
        }

        .login-box .input-group {
            margin-bottom: 20px;
        }
        
        .login-box .input-group input {
            font-size: 16px; /* Evita zoom en iOS */
        }

        .user-info {
            background: rgba(255,255,255,0.2);
            padding: 10px 20px;
            border-radius: 8px;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            color: white;
        }

        .logout-btn {
            background: rgba(255,255,255,0.2);
            border: 2px solid white;
            color: white;
            padding: 8px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .logout-btn:hover {
            background: white;
            color: #667eea;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        /* ESTILOS PARA MAPEO MEJORADO */
        .column-mapping-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .column-preview {
            background: white;
            border: 2px solid #667eea;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .column-preview h4 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 0.9em;
        }

        .column-letter-input {
            width: 60px;
            padding: 8px;
            border: 2px solid #667eea;
            border-radius: 5px;
            font-size: 1.1em;
            font-weight: bold;
            text-align: center;
            text-transform: uppercase;
        }

        .column-letter-input:focus {
            outline: none;
            border-color: #764ba2;
            box-shadow: 0 0 5px rgba(102, 126, 234, 0.5);
        }

        .template-controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .column-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .column-item label {
            min-width: 120px;
            font-weight: 600;
            color: #333;
        }

        .saved-template-badge {
            display: inline-block;
            background: #4caf50;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.85em;
            margin-left: 10px;
        }

        .column-preview-grid {
            display: grid;
            grid-template-columns: 50px 1fr;
            gap: 5px;
            font-size: 0.85em;
            max-height: 150px;
            overflow-y: auto;
        }

        .column-preview-grid div {
            padding: 3px;
        }

        .column-preview-grid .col-letter {
            font-weight: bold;
            color: #667eea;
            text-align: center;
        }

        .column-preview-grid .col-name {
            color: #666;
        }

        .brands-display {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 5px;
        }

        /* ESTILOS PARA EDICIÃ“N DE PROVEEDOR */
        .edit-section {
            display: none;
            background: #fff3cd;
            border: 3px solid #ff9800;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
        }

        .edit-section.active {
            display: block;
        }

        .edit-section h3 {
            color: #ff9800;
            margin-bottom: 20px;
            font-size: 1.4em;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 0.85em;
        }

        /* ESTILOS PARA PORTAL DE CLIENTES */
        #clientPortal .btn-success {
            padding: 15px 25px;
            font-size: 1.1em;
            font-weight: 600;
        }

        #clientPortal .product-card .btn-success {
            padding: 12px 20px;
            font-size: 1em;
        }

        /* ESTILOS PARA ANUNCIOS/OFERTAS */
        .announcement-banner {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            animation: slideIn 0.5s ease-out;
        }

        .announcement-banner.promo {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .announcement-banner.info {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .announcement-banner.warning {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .announcement-banner h3 {
            margin: 0 0 10px 0;
            font-size: 1.5em;
        }

        .announcement-banner p {
            margin: 0;
            font-size: 1.1em;
            opacity: 0.95;
        }

        /* ESTILOS PARA ANUNCIOS/OFERTAS */
        .announcement-banner {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 25px;
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
            animation: slideIn 0.5s ease-out;
        }

        .announcement-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            border: 3px solid #667eea;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: all 0.3s;
        }

        .announcement-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .announcement-urgent {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            color: white;
            animation: pulse 2s infinite;
        }

        .announcement-offer {
            background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
            color: white;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.02);
            }
        }

        .carousel-container {
            position: relative;
            overflow: hidden;
            border-radius: 15px;
            margin-bottom: 25px;
        }

        .carousel-slide {
            display: none;
            animation: fadeIn 0.5s;
        }

        .carousel-slide.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .carousel-controls {
            position: absolute;
            bottom: 15px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
        }

        .carousel-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: rgba(255,255,255,0.5);
            cursor: pointer;
            transition: all 0.3s;
        }

        .carousel-dot.active {
            background: white;
            transform: scale(1.3);
        }

        /* Estilos para Portal de Clientes */
        #clientPortal .btn-success {
            padding: 18px 40px;
            font-size: 1.25em;
            border-radius: 12px;
            font-weight: 600;
        }

        #clientPortal .product-card .btn {
            padding: 18px 35px;
            font-size: 1.2em;
            font-weight: 700;
            border-radius: 10px;
            transition: all 0.3s ease;
        }

        #clientPortal .product-card .btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        #clientPortal .btn-success {
            padding: 20px 45px;
            font-size: 1.3em;
            font-weight: 700;
            border-radius: 12px;
        }

        #clientPortal .btn-warning {
            padding: 20px 45px;
            font-size: 1.3em;
            font-weight: 700;
            border-radius: 12px;
        }

        #clientPortal .btn-danger {
            padding: 12px 25px;
            font-size: 1em;
            font-weight: 600;
        }

        /* Banners de Avisos/Ofertas */
        .announcement-banner {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            color: white;
            padding: 25px 35px;
            border-radius: 15px;
            margin-bottom: 25px;
            box-shadow: 0 8px 25px rgba(238, 90, 111, 0.4);
            position: relative;
            overflow: hidden;
            animation: pulse 2s ease-in-out infinite;
        }

        .announcement-banner.promo {
            background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
            box-shadow: 0 8px 25px rgba(76, 175, 80, 0.4);
        }

        .announcement-banner.info {
            background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
            box-shadow: 0 8px 25px rgba(33, 150, 243, 0.4);
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.01); }
        }

        .announcement-banner::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: rotate 20s linear infinite;
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .announcement-content {
            position: relative;
            z-index: 1;
        }

        .announcement-title {
            font-size: 1.6em;
            font-weight: 700;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .announcement-text {
            font-size: 1.1em;
            line-height: 1.6;
            opacity: 0.95;
        }

        .announcement-badge {
            display: inline-block;
            background: rgba(255,255,255,0.3);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            margin-top: 10px;
        }

        .offer-banner {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .promo-banner {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .info-banner {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        }
    
        /* === CATÃLOGO VISUAL === */
        /* === CATÃLOGO VISUAL - RESPONSIVE === */
        .catalog-visual-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 25px;
            margin-top: 30px;
        }

        /* RESPONSIVE - Tablets */
        @media (max-width: 768px) {
            .catalog-visual-grid {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
                gap: 15px;
            }
        }

        /* RESPONSIVE - MÃ³viles */
        @media (max-width: 480px) {
            .catalog-visual-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
        }

        .product-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            overflow: hidden;
            transition: all 0.3s;
            cursor: pointer;
        }

        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        /* En mÃ³vil: menos hover effect */
        @media (max-width: 768px) {
            .product-card:hover {
                transform: translateY(-2px);
            }
        }

        .product-card-image {
            width: 100%;
            height: 220px;
            object-fit: cover;
            background: #f5f5f5;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
            font-size: 3em;
        }

        /* Imagen mÃ¡s pequeÃ±a en mÃ³vil */
        @media (max-width: 480px) {
            .product-card-image {
                height: 180px;
                font-size: 2.5em;
            }
        }

        .product-card-body {
            padding: 20px;
        }

        /* Menos padding en mÃ³vil */
        @media (max-width: 480px) {
            .product-card-body {
                padding: 15px;
            }
        }

        .product-card-title {
            font-size: 1.1em;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            height: 50px;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        /* TÃ­tulo mÃ¡s pequeÃ±o en mÃ³vil */
        @media (max-width: 480px) {
            .product-card-title {
                font-size: 1em;
                height: 45px;
            }
        }

        .product-card-code {
            color: #667eea;
            font-size: 0.9em;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .product-card-price {
            font-size: 1.5em;
            color: #4caf50;
            font-weight: bold;
            margin-top: 10px;
        }

        /* Precio mÃ¡s pequeÃ±o en mÃ³vil */
        @media (max-width: 480px) {
            .product-card-price {
                font-size: 1.3em;
            }
        }

        .brand-section {
            margin-bottom: 50px;
        }

        /* Menos margen en mÃ³vil */
        @media (max-width: 480px) {
            .brand-section {
                margin-bottom: 30px;
            }
        }

        .brand-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        /* Menos padding en mÃ³vil */
        @media (max-width: 480px) {
            .brand-header {
                padding: 15px;
                flex-direction: column;
                text-align: center;
            }
        }

        .brand-header h3 {
            font-size: 1.8em;
            margin: 0;
        }

        /* TÃ­tulo mÃ¡s pequeÃ±o en mÃ³vil */
        @media (max-width: 480px) {
            .brand-header h3 {
                font-size: 1.4em;
            }
        }

        .brand-count {
            background: rgba(255,255,255,0.2);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9em;
        }

        .image-upload-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
        }

        /* ========================================
           ESTILOS RESPONSIVE PORTAL DE CLIENTES
           ======================================== */
        
        /* ========================================
           ESTILOS RESPONSIVE PANTALLA LOGIN
           ======================================== */
        @media (max-width: 768px) {
            #loginScreen .header h1 {
                font-size: 1.3em !important;
            }
            
            #loginScreen .header p {
                font-size: 1em !important;
            }
            
            #loginScreen .header-content {
                flex-direction: column;
                text-align: center;
                gap: 10px;
            }
            
            #loginScreen .header-logo {
                width: 80px;
                height: 80px;
            }
            
            #loginScreen .login-container {
                padding: 15px !important;
                margin: 10px !important;
            }
            
            #loginScreen .login-container > div:first-child {
                flex-direction: column !important;
                gap: 10px !important;
            }
            
            #loginScreen .login-container .btn {
                width: 100%;
                padding: 12px 20px !important;
            }
            
            #loginScreen .login-box {
                padding: 20px !important;
            }
            
            #loginScreen .login-box h2 {
                font-size: 1.3em;
            }
            
            #loginScreen .input-group input {
                font-size: 16px !important; /* Evita zoom en iOS */
            }
        }
        
        @media (max-width: 480px) {
            #loginScreen .header {
                padding: 15px 10px !important;
            }
            
            #loginScreen .header h1 {
                font-size: 1.1em !important;
            }
            
            #loginScreen .header-logo {
                width: 60px;
                height: 60px;
            }
            
            #loginScreen .login-container {
                margin: 5px !important;
                padding: 10px !important;
            }
            
            #loginScreen .login-box {
                padding: 15px !important;
            }
            
            #loginScreen .login-box h2 {
                font-size: 1.1em;
            }
            
            #loginScreen .login-box p {
                font-size: 0.85em !important;
            }
            
            #loginScreen div[style*="display: flex"][style*="gap: 15px"] {
                flex-direction: column !important;
            }
            
            #loginScreen div[style*="display: flex"][style*="gap: 15px"] .btn {
                width: 100% !important;
            }
        }
        
        /* Tablets y mÃ³viles */
        @media (max-width: 768px) {
            #clientPortal .header h1 {
                font-size: 1.5em;
            }
            
            #clientPortal .header-content {
                flex-direction: column;
                gap: 15px;
            }
            
            #clientPortal .header-logo {
                width: 80px;
            }
            
            #clientPortal .tabs {
                flex-wrap: wrap;
                gap: 5px;
            }
            
            #clientPortal .tab-btn {
                padding: 10px 15px !important;
                font-size: 0.9em !important;
                flex: 1 1 45%;
            }
            
            #clientPortal .container {
                padding: 10px;
            }
            
            #clientPortal .product-card {
                grid-template-columns: 1fr !important;
                gap: 10px !important;
                text-align: center;
            }
            
            #clientPortal .product-card > div {
                text-align: center !important;
            }
            
            #clientPortal .product-card .btn {
                width: 100%;
                padding: 15px !important;
                font-size: 1.1em !important;
            }
            
            #clientPortal .search-box {
                font-size: 16px !important; /* Evita zoom en iOS */
            }
            
            #clientPortal #cartItems .product-card {
                grid-template-columns: 1fr !important;
            }
        }
        
        /* MÃ³viles pequeÃ±os */
        @media (max-width: 480px) {
            #clientPortal {
                padding: 10px;
            }
            
            #clientPortal .header {
                padding: 15px;
            }
            
            #clientPortal .header h1 {
                font-size: 1.2em;
            }
            
            #clientPortal .header p {
                font-size: 0.9em;
            }
            
            #clientPortal .tab-btn {
                padding: 8px 10px !important;
                font-size: 0.8em !important;
            }
            
            #clientPortal h2 {
                font-size: 1.3em;
            }
            
            #clientPortal .product-card {
                padding: 12px !important;
                margin-bottom: 8px !important;
            }
            
            #clientPortal .product-card strong {
                font-size: 1em !important;
            }
            
            #clientPortal .product-card .btn {
                padding: 12px !important;
                font-size: 1em !important;
            }
            
            #clientPortal .btn-success,
            #clientPortal .btn-warning {
                padding: 15px 20px !important;
                font-size: 1em !important;
                width: 100%;
                margin-bottom: 10px;
            }
            
            #clientPortal .alert {
                padding: 12px;
                font-size: 0.9em;
            }
            
            /* Precio mÃ¡s grande en mÃ³vil */
            #clientPortal .product-card div[style*="color: #4caf50"] {
                font-size: 1.4em !important;
            }
            
            /* Badge de bulto */
            #clientPortal .product-card span[style*="background: #ff9800"] {
                display: block;
                margin-top: 5px;
                margin-left: 0 !important;
            }
        }

    </style>
</head>
<body>
    <div class="container">
        <!-- PANTALLA DE LOGIN -->
        <div id="loginScreen" style="display: block;">
            <div class="header">
                <div class="header-content">
                    <!-- LOGO PLACEHOLDER - REEMPLAZAR CON EL LOGO REAL -->
                    <img src="data:image/svg+xml,%3Csvg xmlns=&#39;http://www.w3.org/2000/svg&#39; width=&#39;150&#39; height=&#39;150&#39; viewBox=&#39;0 0 150 150&#39;%3E%3Crect fill=&#39;%23667eea&#39; width=&#39;150&#39; height=&#39;150&#39;/%3E%3Ctext x=&#39;50%25&#39; y=&#39;50%25&#39; dominant-baseline=&#39;middle&#39; text-anchor=&#39;middle&#39; font-family=&#39;Arial&#39; font-size=&#39;60&#39; fill=&#39;white&#39; font-weight=&#39;bold&#39;%3EB%3C/text%3E%3C/svg%3E" class="header-logo" alt="Logo Bruzzone">
                    <div class="header-info">
                        <h1>ğŸ› ï¸ BRUZZONE DISTRIBUIDORA</h1>
                        <p style="font-size: 1.3em; font-weight: 600;">MAYORISTA</p>
                    </div>
                </div>
            </div>

            <div class="login-container">
                <!-- SELECTOR DE TIPO DE LOGIN -->
                <div style="display: flex; justify-content: center; gap: 20px; margin-bottom: 30px;">
                    <button onclick="showEmployeeLogin()" id="btnEmployeeLogin" class="btn btn-primary" style="padding: 15px 30px; font-size: 1.1em;">
                        ğŸ‘” Empleados
                    </button>
                    <button onclick="showClientLogin()" id="btnClientLogin" class="btn btn-success" style="padding: 15px 30px; font-size: 1.1em;">
                        ğŸ‘¥ Clientes
                    </button>
                </div>

                <!-- LOGIN EMPLEADOS -->
                <div id="employeeLoginBox" class="login-box">
                    <h2>ğŸ” Acceso Empleados</h2>
                    <p style="color: #666; margin-bottom: 20px; font-size: 0.95em;">Administradores y Vendedores</p>
                    <div class="input-group">
                        <label>Usuario</label>
                        <input type="text" id="loginUsername" placeholder="IngresÃ¡ tu usuario">
                    </div>
                    <div class="input-group">
                        <label>ContraseÃ±a</label>
                        <input type="password" id="loginPassword" placeholder="IngresÃ¡ tu contraseÃ±a" onkeypress="if(event.key===&#39;Enter&#39;) login()">
                    </div>
                    <button class="btn btn-success" onclick="login()" style="width: 100%; margin-top: 20px;">
                        ğŸ” Ingresar
                    </button>
                    <div id="loginError" style="color: #d32f2f; margin-top: 15px; text-align: center;"></div>
                </div>

                <!-- LOGIN CLIENTES -->
                <div id="clientLoginBox" class="login-box" style="display: none;">
                    <h2>ğŸ›’ Portal de Clientes</h2>
                    <p style="color: #666; margin-bottom: 20px; font-size: 0.95em;">IngresÃ¡ con tus credenciales</p>
                    <div class="input-group">
                        <label>Usuario</label>
                        <input type="text" id="clientLoginUsername" placeholder="Tu usuario">
                    </div>
                    <div class="input-group">
                        <label>ContraseÃ±a</label>
                        <input type="password" id="clientLoginPassword" placeholder="Tu contraseÃ±a" onkeypress="if(event.key===&#39;Enter&#39;) clientLogin()">
                    </div>
                    <button class="btn btn-success" onclick="clientLogin()" style="width: 100%; margin-top: 20px;">
                        ğŸ” Ingresar como Cliente
                    </button>
                    <div id="clientLoginError" style="color: #d32f2f; margin-top: 15px; text-align: center;"></div>
                    
                    <div style="margin-top: 25px; padding: 20px; background: #e3f2fd; border-radius: 10px; text-align: center;">
                        <p style="color: #1976d2; font-weight: 600; margin-bottom: 10px;">Â¿No tenÃ©s usuario?</p>
                        <p style="color: #666; font-size: 0.9em; margin-bottom: 15px;">
                            ContactÃ¡ a nuestro equipo para registrarte:
                        </p>
                        <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                            <a href="https://wa.me/5493585142098" target="_blank" class="btn btn-success" style="text-decoration: none; padding: 10px 20px;">
                                ğŸ“± WhatsApp
                            </a>
                            <a href="tel:3585142098" class="btn btn-primary" style="text-decoration: none; padding: 10px 20px;">
                                ğŸ“ Llamar
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- SISTEMA PRINCIPAL -->
        <div id="mainSystem" style="display: none;">
        <div class="header">
            <div class="header-top">
                <div></div>
                <div class="user-info">
                    <span>ğŸ‘¤ <strong id="currentUsername">Administrador</strong></span>
                    <span>|</span>
                    <span id="currentUserRole">ğŸ”‘ Administrador</span>
                    <button class="logout-btn" onclick="logout()">Cerrar SesiÃ³n</button>
                </div>
            </div>
            <div class="header-content">
                <!-- LOGO PLACEHOLDER - REEMPLAZAR CON EL LOGO REAL -->
                <img src="data:image/svg+xml,%3Csvg xmlns=&#39;http://www.w3.org/2000/svg&#39; width=&#39;150&#39; height=&#39;150&#39; viewBox=&#39;0 0 150 150&#39;%3E%3Crect fill=&#39;%23667eea&#39; width=&#39;150&#39; height=&#39;150&#39;/%3E%3Ctext x=&#39;50%25&#39; y=&#39;50%25&#39; dominant-baseline=&#39;middle&#39; text-anchor=&#39;middle&#39; font-family=&#39;Arial&#39; font-size=&#39;60&#39; fill=&#39;white&#39; font-weight=&#39;bold&#39;%3EB%3C/text%3E%3C/svg%3E" class="header-logo" alt="Logo Bruzzone">
                <div class="header-info">
                    <h1>ğŸ› ï¸ BRUZZONE DISTRIBUIDORA</h1>
                    <p style="font-size: 1.3em; font-weight: 600;">MAYORISTA</p>
                    <div class="header-contact">
                    <p>ğŸ“ Dr. Carlos Rocha 128 - Alejandro Roca, CÃ³rdoba</p>
                    <p>ğŸ“± 3585142098</p>
                </div>
                </div>
            </div>
            <p style="font-size: 1em; margin-top: 15px;">Sistema de GestiÃ³n Inteligente de Precios</p>
        </div>

        <div class="stats">
            <div class="stat-card" style="display: block;">
                <h3 id="totalProducts">0</h3>
                <p>Productos Totales</p>
            </div>
            <div class="stat-card" style="display: block;">
                <h3 id="totalSuppliers">0</h3>
                <p>Proveedores Activos</p>
            </div>
            <div class="stat-card" style="display: block;">
                <h3 id="totalClients">0</h3>
                <p>Clientes Registrados</p>
            </div>
            <div class="stat-card" style="display: block;">
                <h3 id="totalOrders">0</h3>
                <p>Pedidos Totales</p>
            </div>
            <div class="stat-card" style="display: block;">
                <h3 id="totalInvestment">$0.00</h3>
                <p>InversiÃ³n Total</p>
            </div>
            <div class="stat-card" style="display: block;">
                <h3 id="totalRevenue">$0.00</h3>
                <p>Ingresos Estimados</p>
            </div>
        </div>

        <div class="tabs">
            <button class="tab" onclick="switchTab(&#39;suppliers&#39;, event)" style="display: block;">ğŸ¢ Proveedores</button>
            <button class="tab" onclick="switchTab(&#39;import&#39;, event)" style="display: block;">ğŸ“¥ Importar Precios</button>
            <button class="tab" onclick="switchTab(&#39;catalog&#39;, event)" style="display: block;">ğŸ“‹ CatÃ¡logo</button>
            <button class="tab" onclick="switchTab(&#39;visual-catalog&#39;, event)" style="display: block;">ğŸ“¸ CatÃ¡logo Visual</button>
            <button class="tab" onclick="switchTab(&#39;orders&#39;, event)" style="display: block;">ğŸ“ Pedidos</button>
            <button class="tab" onclick="switchTab(&#39;factory-orders&#39;, event)" style="display: block;">ğŸ­ Pedidos a FÃ¡brica</button>
            <button class="tab" onclick="switchTab(&#39;sellers&#39;, event)" style="display: block;">ğŸ‘¥ Vendedores</button>
            <button class="tab" onclick="switchTab(&#39;clients&#39;, event)" style="display: block;">ğŸ›’ Clientes</button>
            <button class="tab" onclick="switchTab(&#39;banners&#39;, event)" style="display: block;">ğŸ“¢ Publicidades</button>
            <button class="tab" onclick="switchTab(&#39;company&#39;, event)" style="display: block;">ğŸ­ Mi Empresa</button>
            <button class="tab" onclick="switchTab(&#39;config&#39;, event)" style="display: block;">âš™ï¸ ConfiguraciÃ³n</button>
            <button class="tab" onclick="switchTab(&#39;backup&#39;, event)" style="display: block;">ğŸ’¾ Backup</button>
            <button class="tab" onclick="switchTab(&#39;catalogs&#39;, event)" style="display: block;">ğŸ“ CatÃ¡logos</button>
            <button class="tab" onclick="switchTab(&#39;export&#39;, event)" style="display: block;">ğŸ“¤ Exportar</button>
        </div>

        <!-- PESTAÃ‘A PROVEEDORES -->
        <div id="suppliers" class="tab-content active">
            <h2 style="margin-bottom: 20px;">ğŸ¢ GestiÃ³n de Proveedores</h2>
            
            <!-- DEBUG INFO -->
            <div style="background: #fff3cd; border: 2px solid #ff9800; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                <h4 style="color: #ff9800; margin-bottom: 10px;">ğŸ” Debug Info</h4>
                <div style="font-family: monospace; font-size: 0.9em;">
                    <div>Total Proveedores en Array: <strong id="debugSupplierCount">1</strong></div>
                    <div>localStorage presente: <strong id="debugLocalStorage">SÃ</strong></div>
                    <div>Ãšltima actualizaciÃ³n: <strong id="debugLastUpdate">05:19:12</strong></div>
                </div>
                <button class="btn btn-primary btn-small" onclick="updateDebugInfo()" style="margin-top: 10px;">
                    ğŸ”„ Actualizar Info
                </button>
                <button class="btn btn-warning btn-small" onclick="forceReloadTable()" style="margin-top: 10px;">
                    ğŸ”§ Forzar Recarga Tabla
                </button>
            </div>

            <!-- SECCIÃ“N DE ACTUALIZACIÃ“N DE PRECIOS -->
            <div style="background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); border: 3px solid #4caf50; border-radius: 15px; padding: 25px; margin-bottom: 30px;">
                <h3 style="color: #2e7d32; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                    ğŸ’° ActualizaciÃ³n de Precios
                </h3>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <!-- AUMENTO POR PORCENTAJE -->
                    <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                        <h4 style="color: #4caf50; margin-bottom: 15px;">ğŸ“ˆ Aumento por Porcentaje</h4>
                        <p style="color: #666; font-size: 0.9em; margin-bottom: 15px;">
                            AumentÃ¡ todos los precios de un proveedor/fÃ¡brica con un porcentaje.
                        </p>
                        
                        <div class="input-group" style="margin-bottom: 12px;">
                            <label style="font-weight: 600;">Seleccionar Proveedor/FÃ¡brica</label>
                            <select id="priceUpdateSupplier" style="width: 100%; padding: 10px; border: 2px solid #4caf50; border-radius: 8px;">
                                <option value="">-- Seleccionar proveedor --</option>
                            </select>
                        </div>
                        
                        <div class="input-group" style="margin-bottom: 12px;">
                            <label style="font-weight: 600;">Porcentaje de aumento (%)</label>
                            <input type="number" id="priceUpdatePercent" placeholder="Ej: 10" step="0.01" style="width: 100%; padding: 10px; border: 2px solid #4caf50; border-radius: 8px; font-size: 1.1em;">
                            <small style="color: #666;">Ejemplo: 10 = +10%, -5 = -5% (reducciÃ³n)</small>
                        </div>
                        
                        <div id="priceUpdatePreview" style="display: none; background: #fff3cd; padding: 12px; border-radius: 8px; margin-bottom: 12px;">
                            <strong style="color: #ff9800;">ğŸ“Š Vista previa:</strong>
                            <div id="priceUpdatePreviewContent" style="margin-top: 8px; font-size: 0.9em;"></div>
                        </div>
                        
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-primary" onclick="previewPriceUpdate()" style="flex: 1;">
                                ğŸ‘ï¸ Vista Previa
                            </button>
                            <button class="btn btn-success" onclick="applyPriceUpdate()" style="flex: 1;">
                                âœ… Aplicar Aumento
                            </button>
                        </div>
                    </div>
                    
                    <!-- EDICIÃ“N MANUAL -->
                    <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                        <h4 style="color: #2196F3; margin-bottom: 15px;">âœï¸ EdiciÃ³n Manual de Precios</h4>
                        <p style="color: #666; font-size: 0.9em; margin-bottom: 15px;">
                            EditÃ¡ precios uno por uno buscando el producto.
                        </p>
                        
                        <div class="input-group" style="margin-bottom: 12px;">
                            <label style="font-weight: 600;">Buscar producto</label>
                            <input type="text" id="manualPriceSearch" placeholder="CÃ³digo o descripciÃ³n..." oninput="searchProductForPriceEdit()" style="width: 100%; padding: 10px; border: 2px solid #2196F3; border-radius: 8px;">
                        </div>
                        
                        <div id="manualPriceResults" style="max-height: 250px; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 8px; background: #f8f9fa;">
                            <p style="padding: 20px; text-align: center; color: #999;">EscribÃ­ para buscar productos...</p>
                        </div>
                    </div>
                </div>
                
                <!-- HISTORIAL DE AUMENTOS -->
                <div style="margin-top: 20px; background: white; padding: 15px; border-radius: 12px;">
                    <h4 style="color: #666; margin-bottom: 10px;">ğŸ“‹ Ãšltimos aumentos aplicados</h4>
                    <div id="priceUpdateHistory" style="max-height: 150px; overflow-y: auto;">
                        <p style="color: #999; font-size: 0.9em;">No hay aumentos registrados aÃºn.</p>
                    </div>
                </div>
            </div>

            <!-- SECCIÃ“N DE EDICIÃ“N -->
            <div id="editSupplierSection" class="edit-section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3>âœï¸ Editando Proveedor: <span id="editSupplierName"></span></h3>
                    <button class="btn btn-danger btn-small" onclick="cancelEditSupplier()">âŒ Cancelar</button>
                </div>
                
                <div class="config-panel">
                    <div class="config-group">
                        <div class="input-group">
                            <label>Nombre del Proveedor</label>
                            <input type="text" id="editSupplierNameInput" placeholder="Ej: Ferromax S.A.">
                        </div>
                        <div class="input-group">
                            <label>ğŸ·ï¸ Marcas que vende (separadas por coma)</label>
                            <input type="text" id="editSupplierBrands" placeholder="Ej: Tramontina, Stanley, Black+Decker">
                            <small>Si vende varias marcas, separÃ¡ con comas.</small>
                        </div>
                        <div class="input-group">
                            <label>Descuento 1 (%)</label>
                            <input type="number" id="editSupplierDiscount1" value="0" min="0" max="100" step="0.01">
                        </div>
                        <div class="input-group">
                            <label>Descuento 2 (%)</label>
                            <input type="number" id="editSupplierDiscount2" value="0" min="0" max="100" step="0.01">
                        </div>
                        <div class="input-group">
                            <label>Descuento 3 (%)</label>
                            <input type="number" id="editSupplierDiscount3" value="0" min="0" max="100" step="0.01">
                        </div>
                        <div class="input-group">
                            <label>IVA (%)</label>
                            <select id="editSupplierIVA">
                                <option value="10.5">10.5%</option>
                                <option value="21">21%</option>
                            </select>
                        </div>
                        <button class="btn btn-success" onclick="saveSupplierEdit()">
                            ğŸ’¾ Guardar Cambios
                        </button>
                    </div>
                </div>
            </div>

            <div class="config-panel">
                <div class="config-group">
                    <h3>Agregar Nuevo Proveedor</h3>
                    <div class="input-group">
                        <label>Nombre del Proveedor</label>
                        <input type="text" id="newSupplierName" placeholder="Ej: Ferromax S.A.">
                    </div>
                    <div class="input-group">
                        <label>ğŸ·ï¸ Marcas que vende (separadas por coma)</label>
                        <input type="text" id="newSupplierBrands" placeholder="Ej: Tramontina, Stanley, Black+Decker">
                        <small>Si vende varias marcas, separÃ¡ con comas. Si vende una sola marca, escribÃ­ solo esa.</small>
                    </div>
                    <div class="input-group">
                        <label>Descuento 1 (%)</label>
                        <input type="number" id="newSupplierDiscount1" value="0" min="0" max="100" step="0.01">
                    </div>
                    <div class="input-group">
                        <label>Descuento 2 (%)</label>
                        <input type="number" id="newSupplierDiscount2" value="0" min="0" max="100" step="0.01">
                    </div>
                    <div class="input-group">
                        <label>Descuento 3 (%)</label>
                        <input type="number" id="newSupplierDiscount3" value="0" min="0" max="100" step="0.01">
                    </div>
                    <div class="input-group">
                        <label>IVA (%)</label>
                        <select id="newSupplierIVA">
                            <option value="10.5">10.5%</option>
                            <option value="21" selected="">21%</option>
                        </select>
                    </div>
                    <button class="btn btn-success" onclick="addSupplier()">
                        â• Agregar Proveedor
                    </button>
                </div>
            </div>

            <h3 style="margin-top: 30px; margin-bottom: 15px;">Lista de Proveedores</h3>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Nombre</th>
                            <th>Marcas</th>
                            <th>Desc. 1</th>
                            <th>Desc. 2</th>
                            <th>Desc. 3</th>
                            <th>IVA</th>
                            <th>Productos</th>
                            <th>Plantilla</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="suppliersTableBody">
                        <tr>
                            <td><strong>py</strong></td>
                            <td><span style="color: #999;">Sin marcas</span></td>
                            <td>30%</td>
                            <td>5%</td>
                            <td>10%</td>
                            <td>21%</td>
                            <td><span class="supplier-badge">0 productos</span></td>
                            <td><span style="color: #999; font-weight: 600;">âŒ Sin plantilla</span></td>
                            <td>
                                <button class="btn btn-warning btn-small" onclick="editSupplier(0)">âœï¸</button>
                                <button class="btn btn-danger btn-small" onclick="deleteSupplier(0)">ğŸ—‘ï¸</button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- PESTAÃ‘A IMPORTAR -->
        <div id="import" class="tab-content">
            <h2 style="margin-bottom: 20px;">ğŸ“¥ Importar y Actualizar Precios</h2>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
                <div style="border: 3px solid #4caf50; border-radius: 15px; padding: 30px; text-align: center; cursor: pointer; background: #f1f8f4;" onclick="startNewImport()">
                    <h3 style="color: #4caf50; font-size: 1.5em; margin-bottom: 10px;">ğŸ“¥ NUEVA IMPORTACIÃ“N</h3>
                    <p style="color: #666; margin-bottom: 20px;">Importar productos de un nuevo proveedor o agregar productos nuevos</p>
                    <button class="btn btn-success">Importar Archivo Nuevo</button>
                </div>

                <div style="border: 3px solid #2196F3; border-radius: 15px; padding: 30px; text-align: center; cursor: pointer; background: #e3f2fd;" onclick="startUpdateImport()">
                    <h3 style="color: #2196F3; font-size: 1.5em; margin-bottom: 10px;">ğŸ”„ ACTUALIZAR PRECIOS</h3>
                    <p style="color: #666; margin-bottom: 20px;">Actualizar precios de un proveedor existente con nueva lista</p>
                    <button class="btn btn-primary">Actualizar Precios</button>
                </div>
            </div>

            <div id="importTypeSelection" style="display: none; margin-bottom: 20px;">
                <div class="alert alert-info">
                    <strong id="importTypeMessage"></strong>
                </div>
            </div>

            <div class="upload-zone" id="uploadZone" style="display: none;">
                <h3>ğŸ“ Seleccionar Archivo Excel</h3>
                <p>ArrastrÃ¡ tu archivo Excel aquÃ­ o hacÃ© clic para seleccionarlo</p>
                <p style="color: #999; font-size: 0.9em;">Formatos soportados: XLS, XLSX</p>
                <input type="file" id="fileInput" accept=".xls,.xlsx" onchange="handleFileUpload(event)">
                <button class="btn btn-primary" onclick="document.getElementById(&#39;fileInput&#39;).click()">
                    Seleccionar Archivo
                </button>
            </div>

            <div id="importForm" style="display: none; margin-top: 30px;">
                <div class="alert alert-info">
                    <strong>Archivo cargado correctamente.</strong> ConfigurÃ¡ los campos:
                </div>
                
                <div class="config-panel">
                    <div class="config-group">
                        <h3>InformaciÃ³n del Proveedor</h3>
                        <div class="input-group">
                            <label>Seleccionar Proveedor</label>
                            <select id="selectSupplier" onchange="updateImportMode()"><option value="">-- Seleccionar proveedor --</option><option value="py">py</option></select>
                            <small>Si no existe, agregalo desde la pestaÃ±a "Proveedores"</small>
                        </div>
                        
                        <div id="supplierBrandsInfo" style="display: none; margin-top: 10px;">
                            <div class="alert alert-warning">
                                <strong>ğŸ“¦ Marcas de este proveedor:</strong>
                                <div id="currentSupplierBrands" class="brands-display"></div>
                                <small style="display: block; margin-top: 10px;">Estas marcas se asignarÃ¡n automÃ¡ticamente a los productos importados.</small>
                            </div>
                        </div>

                        <div id="importModeGroup" class="input-group" style="display: none;">
                            <label>Modo de ImportaciÃ³n</label>
                            <select id="importMode">
                                <option value="add">Agregar productos nuevos</option>
                                <option value="update">Actualizar precios existentes</option>
                            </select>
                            <small>
                                <strong>Agregar:</strong> Solo agrega productos que no existen<br>
                                <strong>Actualizar:</strong> Reemplaza precios de productos existentes del proveedor
                            </small>
                        </div>
                    </div>

                    <div class="config-group">
                        <h3>ğŸ“Š Personalizar Columnas del Excel</h3>
                        <p style="color: #666; margin-bottom: 15px;">
                            <strong>ğŸ“ EditÃ¡ el nombre de las columnas</strong> o <strong>dejÃ¡ en blanco</strong> las que no querÃ©s importar/mostrar.
                        </p>
                        
                        <div class="alert alert-info" style="margin-bottom: 15px;">
                            <strong>ğŸ’¡ TIP:</strong> Si tu Excel tiene columnas adicionales como "Cantidad por Bulto", "Stock", "Peso", etc., 
                            asegurate de mantener esos nombres. Se guardarÃ¡n automÃ¡ticamente con los productos y aparecerÃ¡n en la exportaciÃ³n.
                            <div style="margin-top: 10px; padding: 10px; background: white; border-radius: 5px; font-family: monospace; font-size: 0.85em;">
                                <strong style="color: #667eea;">Ejemplo:</strong><br>
                                Columna D: "Cantidad por Bulto" âœ…<br>
                                Columna E: "Stock" âœ…<br>
                                Columna F: "Peso" âœ…
                            </div>
                        </div>

                        <div class="column-preview">
                            <h4>Columnas de tu archivo (podÃ©s renombrarlas o dejarlas vacÃ­as para ignorarlas):</h4>
                            <div id="columnPreview" style="display: grid; gap: 10px; margin-top: 15px;"></div>
                        </div>
                        <div style="margin-top: 15px;">
                            <button class="btn btn-primary btn-small" onclick="resetColumnNames()">
                                ğŸ”„ Restaurar Nombres Originales
                            </button>
                            <button class="btn btn-warning btn-small" onclick="clearAllColumnNames()">
                                âŒ Limpiar Todos los Nombres
                            </button>
                        </div>
                    </div>

                    <div class="config-group">
                        <h3>ğŸ¯ ConfiguraciÃ³n de Columnas del Excel</h3>
                        
                        <div class="alert alert-info" style="margin-bottom: 20px;">
                            <strong>ğŸ“– Â¿CÃ³mo funciona?</strong><br>
                            IndicÃ¡ en quÃ© <strong>COLUMNA (letra)</strong> de tu Excel estÃ¡ cada dato.<br>
                            <strong>Ejemplo:</strong> Si el cÃ³digo estÃ¡ en la columna A, escribÃ­ "A". Si el precio estÃ¡ en la columna D, escribÃ­ "D".
                        </div>

                        <h4 style="color: #667eea; margin-bottom: 15px;">âœ… Columnas OBLIGATORIAS</h4>
                        <p style="color: #666; margin-bottom: 15px;">Estas 3 columnas son necesarias para importar:</p>
                        
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 30px;">
                            <div style="background: #e8f5e9; padding: 15px; border-radius: 10px; border: 2px solid #4caf50;">
                                <label style="display: block; font-weight: 600; color: #2e7d32; margin-bottom: 8px;">
                                    ğŸ“¦ 1. CÃ³digo del Producto
                                </label>
                                <input type="text" id="columnCodeLetter" placeholder="Ej: A" maxlength="3" style="width: 100%; padding: 12px; font-size: 1.2em; text-align: center; border: 2px solid #4caf50; border-radius: 8px; text-transform: uppercase;">
                                <small style="display: block; margin-top: 8px; color: #666;">
                                    Letra de la columna donde estÃ¡ el cÃ³digo/SKU
                                </small>
                                <div id="previewCode" style="margin-top: 8px; padding: 8px; background: white; border-radius: 5px; min-height: 30px; font-size: 0.9em; color: #2e7d32;"></div>
                            </div>

                            <div style="background: #e8f5e9; padding: 15px; border-radius: 10px; border: 2px solid #4caf50;">
                                <label style="display: block; font-weight: 600; color: #2e7d32; margin-bottom: 8px;">
                                    ğŸ“ 2. DescripciÃ³n
                                </label>
                                <input type="text" id="columnDescriptionLetter" placeholder="Ej: B" maxlength="3" style="width: 100%; padding: 12px; font-size: 1.2em; text-align: center; border: 2px solid #4caf50; border-radius: 8px; text-transform: uppercase;">
                                <small style="display: block; margin-top: 8px; color: #666;">
                                    Letra de la columna donde estÃ¡ la descripciÃ³n
                                </small>
                                <div id="previewDescription" style="margin-top: 8px; padding: 8px; background: white; border-radius: 5px; min-height: 30px; font-size: 0.9em; color: #2e7d32;"></div>
                            </div>

                            <div style="background: #e8f5e9; padding: 15px; border-radius: 10px; border: 2px solid #4caf50;">
                                <label style="display: block; font-weight: 600; color: #2e7d32; margin-bottom: 8px;">
                                    ğŸ’° 3. Precio de Compra
                                </label>
                                <input type="text" id="columnPriceLetter" placeholder="Ej: C" maxlength="3" style="width: 100%; padding: 12px; font-size: 1.2em; text-align: center; border: 2px solid #4caf50; border-radius: 8px; text-transform: uppercase;">
                                <small style="display: block; margin-top: 8px; color: #666;">
                                    Letra de la columna donde estÃ¡ el precio
                                </small>
                                <div id="previewPrice" style="margin-top: 8px; padding: 8px; background: white; border-radius: 5px; min-height: 30px; font-size: 0.9em; color: #2e7d32;"></div>
                            </div>
                        </div>

                        <h4 style="color: #ff9800; margin-bottom: 15px; margin-top: 30px;">â­ Columnas OPCIONALES</h4>
                        <p style="color: #666; margin-bottom: 15px;">Si tu Excel tiene estas columnas, indicÃ¡ dÃ³nde estÃ¡n. Si no, dejÃ¡ en blanco.</p>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                            <div style="background: #fff3cd; padding: 15px; border-radius: 10px; border: 2px solid #ff9800;">
                                <label style="display: block; font-weight: 600; color: #e65100; margin-bottom: 8px;">
                                    ğŸ“¦ Cantidad por Bulto
                                </label>
                                <input type="text" id="columnBulkLetter" placeholder="Ej: D (opcional)" maxlength="3" style="width: 100%; padding: 12px; font-size: 1.2em; text-align: center; border: 2px solid #ff9800; border-radius: 8px; text-transform: uppercase;">
                                <small style="display: block; margin-top: 8px; color: #666;">
                                    Unidades por caja/bulto/paquete
                                </small>
                                <div id="previewBulk" style="margin-top: 8px; padding: 8px; background: white; border-radius: 5px; min-height: 30px; font-size: 0.9em; color: #e65100;"></div>
                            </div>

                            <div style="background: #fff3cd; padding: 15px; border-radius: 10px; border: 2px solid #ff9800;">
                                <label style="display: block; font-weight: 600; color: #e65100; margin-bottom: 8px;">
                                    ğŸ“Š Otra columna (stock, peso, etc.)
                                </label>
                                <input type="text" id="columnExtraLetter" placeholder="Ej: E (opcional)" maxlength="3" style="width: 100%; padding: 12px; font-size: 1.2em; text-align: center; border: 2px solid #ff9800; border-radius: 8px; text-transform: uppercase;">
                                <input type="text" id="columnExtraName" placeholder="Nombre de la columna (Ej: Stock)" style="width: 100%; padding: 8px; margin-top: 8px; border: 2px solid #ff9800; border-radius: 8px;">
                                <small style="display: block; margin-top: 8px; color: #666;">
                                    Cualquier dato adicional que quieras guardar
                                </small>
                                <div id="previewExtra" style="margin-top: 8px; padding: 8px; background: white; border-radius: 5px; min-height: 30px; font-size: 0.9em; color: #e65100;"></div>
                            </div>
                        </div>

                        <div class="alert alert-success" style="margin-top: 20px;">
                            <strong>ğŸ’¡ EJEMPLO PRÃCTICO:</strong><br>
                            <div style="margin-top: 10px; background: white; padding: 15px; border-radius: 8px; font-family: monospace;">
                                <div style="display: grid; grid-template-columns: 60px 120px 200px 100px 120px; gap: 10px; padding: 8px; background: #667eea; color: white; border-radius: 5px; font-weight: bold;">
                                    <div>A</div>
                                    <div>B</div>
                                    <div>C</div>
                                    <div>D</div>
                                    <div>E</div>
                                </div>
                                <div style="display: grid; grid-template-columns: 60px 120px 200px 100px 120px; gap: 10px; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 5px;">
                                    <div>12345</div>
                                    <div>MARTILLO</div>
                                    <div>MARTILLO CARPINTERO</div>
                                    <div>$1500</div>
                                    <div>10</div>
                                </div>
                                <div style="margin-top: 15px; color: #666;">
                                    <strong>ConfiguraciÃ³n:</strong><br>
                                    â€¢ CÃ³digo: <strong>A</strong><br>
                                    â€¢ DescripciÃ³n: <strong>C</strong> (descripciÃ³n completa)<br>
                                    â€¢ Precio: <strong>D</strong><br>
                                    â€¢ Cantidad por Bulto: <strong>E</strong>
                                </div>
                            </div>
                        </div>

                        <!-- GESTIÃ“N DE PLANTILLAS -->
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-top: 30px;">
                            <h4 style="margin-bottom: 15px; color: #667eea;">ğŸ’¾ Guardar esta ConfiguraciÃ³n</h4>
                            
                            <div style="display: grid; grid-template-columns: 1fr auto; gap: 10px; margin-bottom: 15px;">
                                <div class="input-group" style="margin-bottom: 0;">
                                    <label>Nombre de la Plantilla</label>
                                    <input type="text" id="templateName" placeholder="Ej: Aldebras Lista Principal, Stanley Formato Nuevo, etc.">
                                    <small>Dale un nombre para identificar esta configuraciÃ³n fÃ¡cilmente</small>
                                </div>
                                <button class="btn btn-success" onclick="saveColumnTemplateWithName()" style="align-self: end; padding: 15px 30px;">
                                    ğŸ’¾ Guardar Plantilla
                                </button>
                            </div>

                            <!-- PLANTILLAS GUARDADAS -->
                            <div id="templatesListSection" style="display: none; margin-top: 20px;">
                                <h5 style="margin-bottom: 10px;">ğŸ“‹ Plantillas Guardadas:</h5>
                                <div id="templatesList" style="display: grid; gap: 10px;">
                                    <!-- Se llena dinÃ¡micamente -->
                                </div>
                            </div>
                        </div>

                        <div class="template-controls" style="margin-top: 15px;">
                            <button class="btn btn-warning" onclick="autoDetectColumns()">
                                ğŸ” Auto-Detectar Columnas
                            </button>
                        </div>
                    </div>
                </div>

                <button class="btn btn-success" onclick="processImport()" style="font-size: 1.2em; padding: 15px 40px;">
                    âœ… Procesar e Importar
                </button>
            </div>

            <div id="importedData" style="margin-top: 30px;"></div>
        </div>

        <!-- PESTAÃ‘A CATÃLOGO -->
        <div id="catalog" class="tab-content">
            <h2 style="margin-bottom: 20px;">ğŸ“¦ CatÃ¡logo Unificado de Productos</h2>
            
            <!-- BUSCADOR DE PRODUCTOS -->
            <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px;">
                <div style="display: grid; grid-template-columns: 1fr auto; gap: 15px; align-items: center;">
                    <div>
                        <input type="text" id="catalogSearchInput" placeholder="ğŸ” Buscar por cÃ³digo, descripciÃ³n, marca o proveedor..." class="search-box" onkeyup="filterCatalog()" style="margin-bottom: 0; width: 100%;">
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-primary" onclick="clearCatalogSearch()">
                            ğŸ”„ Limpiar
                        </button>
                        <button class="btn btn-warning" onclick="showCatalogStats()">
                            ğŸ“Š Stats
                        </button>
                    </div>
                </div>
        <!-- PESTAÃ‘A CATÃLOGO VISUAL -->
        <div id="visual-catalog" class="tab-content">
            <h2 style="margin-bottom: 20px;">ğŸ“¸ CatÃ¡logo Visual por Marcas</h2>
            
            <div style="background: #e3f2fd; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                <p><strong>ğŸ’¡ Tip:</strong> Para agregar imÃ¡genes a los productos, hacÃ© click en cualquier producto y agregÃ¡ la URL de la imagen.</p>
            </div>

            <div style="display: flex; gap: 15px; margin-bottom: 30px; flex-wrap: wrap;">
                <input type="text" id="searchVisualCatalog" placeholder="ğŸ” Buscar productos..." style="flex: 1; min-width: 200px; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1em;">
                <select id="filterBrandVisual" onchange="currentPageVisual = 1; updateVisualCatalog()" style="padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; min-width: 150px;">
                    <option value="">Todas las Marcas</option>
                </select>
            </div>

            <!-- PAGINACIÃ“N TOP -->
            <div id="visualPaginationTop" style="display: none; background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                    <div style="font-weight: 600; color: #667eea; font-size: 0.95em;">
                        <span id="visualShowingFrom">0</span> - <span id="visualShowingTo">0</span> de <span id="visualTotalProducts">0</span> productos
                    </div>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <button class="btn btn-primary" onclick="previousPageVisual()" id="btnPrevTop" style="padding: 10px 20px;">
                            â¬…ï¸ Anterior
                        </button>
                        <span style="font-weight: 600; color: #667eea; white-space: nowrap;">
                            PÃ¡gina <span id="currentPageNumTop">1</span> de <span id="totalPagesTop">1</span>
                        </span>
                        <button class="btn btn-primary" onclick="nextPageVisual()" id="btnNextTop" style="padding: 10px 20px;">
                            Siguiente â¡ï¸
                        </button>
                    </div>
                </div>
            </div>

            <div id="visualCatalogContent">
                <div style="text-align: center; padding: 60px 20px; color: #999;">
                    <div style="font-size: 4em; margin-bottom: 20px;">ğŸ“¦</div>
                    <h3>No hay productos para mostrar</h3>
                    <p>ImportÃ¡ productos primero desde la pestaÃ±a "Importar Precios"</p>
                </div>
            </div>

            <!-- PAGINACIÃ“N BOTTOM -->
            <div id="visualPaginationBottom" style="display: none; background: #f8f9fa; padding: 15px; border-radius: 10px; margin-top: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                    <div style="font-weight: 600; color: #667eea; font-size: 0.95em;">
                        <span id="visualShowingFrom2">0</span> - <span id="visualShowingTo2">0</span> de <span id="visualTotalProducts2">0</span>
                    </div>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <button class="btn btn-primary" onclick="previousPageVisual()" id="btnPrevBottom" style="padding: 10px 20px;">
                            â¬…ï¸ Anterior
                        </button>
                        <span style="font-weight: 600; color: #667eea; white-space: nowrap;">
                            PÃ¡gina <span id="currentPageNumBottom">1</span> de <span id="totalPagesBottom">1</span>
                        </span>
                        <button class="btn btn-primary" onclick="nextPageVisual()" id="btnNextBottom" style="padding: 10px 20px;">
                            Siguiente â¡ï¸
                        </button>
                    </div>
                </div>
            </div>
        </div>

                
                <!-- Contador de resultados -->
                <div id="catalogSearchInfo" style="margin-top: 15px; padding: 10px; background: #e3f2fd; border-radius: 5px; display: none;">
                    <strong id="catalogResultCount">0</strong> productos encontrados
                </div>
            </div>

            <!-- OPCIONES DE ELIMINACIÃ“N MASIVA -->
            <div style="background: #fff3cd; padding: 20px; border-radius: 10px; border: 2px solid #ffc107; margin-bottom: 20px;">
                <h3 style="color: #856404; margin-bottom: 15px;">ğŸ—‘ï¸ Eliminar Productos</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #856404;">Por Proveedor:</label>
                        <div style="display: grid; grid-template-columns: 1fr auto; gap: 10px;">
                            <select id="deleteBySupplier" style="padding: 10px; border: 2px solid #ffc107; border-radius: 8px;"><option value="">-- Seleccionar --</option></select>
                            <button class="btn btn-danger" onclick="deleteProductsBySupplier()" style="padding: 10px 20px;">
                                ğŸ—‘ï¸ Borrar
                            </button>
                        </div>
                    </div>

                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #856404;">Por Marca:</label>
                        <div style="display: grid; grid-template-columns: 1fr auto; gap: 10px;">
                            <select id="deleteByBrand" style="padding: 10px; border: 2px solid #ffc107; border-radius: 8px;"><option value="">-- Seleccionar --</option></select>
                            <button class="btn btn-danger" onclick="deleteProductsByBrand()" style="padding: 10px 20px;">
                                ğŸ—‘ï¸ Borrar
                            </button>
                        </div>
                    </div>

                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #856404;">Por CÃ³digo:</label>
                        <div style="display: grid; grid-template-columns: 1fr auto; gap: 10px;">
                            <input type="text" id="deleteByCode" placeholder="CÃ³digo del producto" style="padding: 10px; border: 2px solid #ffc107; border-radius: 8px;">
                            <button class="btn btn-danger" onclick="deleteProductByCode()" style="padding: 10px 20px;">
                                ğŸ—‘ï¸ Borrar
                            </button>
                        </div>
                    </div>
                </div>

                <div style="margin-top: 15px; padding: 15px; background: white; border-radius: 8px; border-left: 4px solid #dc3545;">
                    <strong style="color: #dc3545;">âš ï¸ ATENCIÃ“N:</strong> Las eliminaciones son permanentes y no se pueden deshacer. 
                    Se mostrarÃ¡ una confirmaciÃ³n antes de borrar.
                </div>
            </div>

            <!-- AGREGAR PRODUCTO MANUAL -->
            <div style="background: #e8f5e9; padding: 20px; border-radius: 10px; border: 2px solid #4caf50; margin-bottom: 20px;">
                <h3 style="color: #2e7d32; margin-bottom: 15px;">â• Agregar Producto Manual</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                    <div class="input-group">
                        <label style="font-weight: 600; color: #2e7d32;">CÃ³digo *</label>
                        <input type="text" id="manualProductCode" placeholder="Ej: ABC123" style="padding: 10px; border: 2px solid #4caf50; border-radius: 8px;">
                    </div>
                    <div class="input-group" style="grid-column: span 2;">
                        <label style="font-weight: 600; color: #2e7d32;">DescripciÃ³n *</label>
                        <input type="text" id="manualProductDescription" placeholder="DescripciÃ³n del producto" style="padding: 10px; border: 2px solid #4caf50; border-radius: 8px;">
                    </div>
                    <div class="input-group">
                        <label style="font-weight: 600; color: #2e7d32;">Marca</label>
                        <input type="text" id="manualProductBrand" placeholder="Marca" style="padding: 10px; border: 2px solid #4caf50; border-radius: 8px;">
                    </div>
                    <div class="input-group">
                        <label style="font-weight: 600; color: #2e7d32;">Proveedor *</label>
                        <select id="manualProductSupplier" style="padding: 10px; border: 2px solid #4caf50; border-radius: 8px;">
                            <option value="">-- Seleccionar --</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label style="font-weight: 600; color: #2e7d32;">Precio Lista *</label>
                        <input type="number" id="manualProductPrice" placeholder="0.00" step="0.01" min="0" style="padding: 10px; border: 2px solid #4caf50; border-radius: 8px;">
                    </div>
                    <div class="input-group">
                        <label style="font-weight: 600; color: #2e7d32;">IVA (%)</label>
                        <input type="number" id="manualProductIVA" value="21" step="0.5" min="0" style="padding: 10px; border: 2px solid #4caf50; border-radius: 8px;">
                    </div>
                    <div class="input-group">
                        <label style="font-weight: 600; color: #2e7d32;">Cant. x Bulto</label>
                        <input type="number" id="manualProductBulto" value="1" min="1" style="padding: 10px; border: 2px solid #4caf50; border-radius: 8px;">
                    </div>
                </div>
                <div style="margin-top: 15px; display: flex; gap: 15px;">
                    <button class="btn btn-success" onclick="addProductManually()" style="padding: 12px 25px;">
                        â• Agregar Producto
                    </button>
                    <button class="btn btn-secondary" onclick="clearManualProductForm()" style="padding: 12px 25px;">
                        ğŸ”„ Limpiar
                    </button>
                </div>
                <div style="margin-top: 10px; font-size: 0.9em; color: #666;">
                    ğŸ’¡ Los descuentos se aplicarÃ¡n automÃ¡ticamente segÃºn la configuraciÃ³n del proveedor seleccionado.
                </div>
            </div>

            <div class="table-container">
                <table id="catalogTable">
                    <thead>
                        <tr>
                            <th>CÃ³digo</th>
                            <th>DescripciÃ³n</th>
                            <th>Marca</th>
                            <th>Proveedor</th>
                            <th>P. Lista</th>
                            <th>P. Compra</th>
                            <th>P. Mayorista</th>
                            <th>P. Minorista</th>
                            <th>Ganancia</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="catalogBody"><tr><td colspan="10" style="text-align: center; padding: 40px; color: #999;">No hay productos importados.</td></tr></tbody>
                </table>
            </div>
        </div>

        <!-- PESTAÃ‘A PEDIDOS -->
        <div id="orders" class="tab-content">
            <h2 style="margin-bottom: 20px;">ğŸ“ GestiÃ³n de Pedidos</h2>

            <div style="display: flex; gap: 20px; margin-bottom: 20px;">
                <button class="btn btn-success" onclick="showNewOrderForm()">
                    â• Nuevo Pedido
                </button>
                <button class="btn btn-primary" onclick="showOrdersList()">
                    ğŸ“‹ Ver Todos los Pedidos
                </button>
            </div>

            <!-- FORMULARIO NUEVO PEDIDO -->
            <div id="newOrderForm" style="display: none;">
                <div class="config-panel">
                    <!-- DATOS DEL COMPRADOR -->
                    <div class="config-group">
                        <h3>ğŸ¢ Datos del Comprador</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div class="input-group">
                                <label>RazÃ³n Social *</label>
                                <input type="text" id="buyerRazonSocial" placeholder="Ej: FERRETERÃA EL TORNILLO S.R.L.">
                            </div>
                            <div class="input-group">
                                <label>CUIT *</label>
                                <input type="text" id="buyerCUIT" placeholder="Ej: 20-12345678-9" maxlength="13">
                            </div>
                            <div class="input-group">
                                <label>Nombre de FantasÃ­a</label>
                                <input type="text" id="buyerNombreFantasia" placeholder="Ej: FerreterÃ­a El Tornillo">
                            </div>
                            <div class="input-group">
                                <label>TelÃ©fono de Contacto</label>
                                <input type="text" id="buyerPhone" placeholder="Ej: 3584-123456">
                            </div>
                        </div>
                    </div>

                    <!-- DATOS DE ENVÃO -->
                    <div class="config-group">
                        <h3>ğŸ“¦ Datos de EnvÃ­o</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div class="input-group">
                                <label>DirecciÃ³n de Entrega *</label>
                                <input type="text" id="deliveryAddress" placeholder="Calle y nÃºmero">
                            </div>
                            <div class="input-group">
                                <label>Localidad *</label>
                                <input type="text" id="deliveryCity" placeholder="Ciudad">
                            </div>
                            <div class="input-group">
                                <label>Provincia</label>
                                <input type="text" id="deliveryProvince" placeholder="Provincia" value="CÃ³rdoba">
                            </div>
                            <div class="input-group">
                                <label>CÃ³digo Postal</label>
                                <input type="text" id="deliveryZipCode" placeholder="CP">
                            </div>
                        </div>
                    </div>

                    <!-- DATOS DE TRANSPORTE -->
                    <div class="config-group">
                        <h3>ğŸšš Datos de Transporte</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div class="input-group">
                                <label>Empresa de Transporte</label>
                                <input type="text" id="transportCompany" placeholder="Ej: Andreani, OCA, Correo Argentino">
                            </div>
                            <div class="input-group">
                                <label>Tipo de EnvÃ­o</label>
                                <select id="shippingType">
                                    <option value="">-- Seleccionar --</option>
                                    <option value="retira">Retira en local</option>
                                    <option value="domicilio">EnvÃ­o a domicilio</option>
                                    <option value="transporte">Por transporte</option>
                                </select>
                            </div>
                            <div class="input-group">
                                <label>Observaciones de EnvÃ­o</label>
                                <input type="text" id="shippingNotes" placeholder="Horarios, referencias, etc.">
                            </div>
                        </div>
                    </div>

                    <!-- DATOS DEL VENDEDOR -->
                    <div class="config-group">
                        <h3>ğŸ‘¨â€ğŸ’¼ Datos del Vendedor</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div class="input-group">
                                <label>Vendedor</label>
                                <input type="text" id="orderSalesperson" readonly="" style="background: #f8f9fa; cursor: not-allowed;">
                                <small>Se asigna automÃ¡ticamente segÃºn el usuario logueado</small>
                            </div>
                            <div class="input-group">
                                <label>Fecha del Pedido</label>
                                <input type="text" id="orderDate" readonly="" style="background: #f8f9fa; cursor: not-allowed;">
                            </div>
                        </div>
                    </div>

                    <!-- BÃšSQUEDA Y CARGA DE PRODUCTOS -->
                    <div class="config-group">
                        <h3>ğŸ›’ Agregar Productos al Pedido</h3>
                        <div style="display: grid; grid-template-columns: 1fr 120px 100px; gap: 10px; margin-bottom: 15px;">
                            <input type="text" id="productSearchInput" placeholder="ğŸ” Buscar por cÃ³digo o descripciÃ³n..." class="search-box" onkeyup="searchProductForOrder()" style="margin-bottom: 0;">
                            <input type="number" id="productQuantityInput" placeholder="Cant." min="1" value="1" style="padding: 15px; border: 2px solid #667eea; border-radius: 8px; font-size: 1em; text-align: center;">
                            <button class="btn btn-success" onclick="addProductToOrder()" style="padding: 15px; margin: 0;">
                                â• Agregar
                            </button>
                        </div>

                        <!-- Resultados de bÃºsqueda -->
                        <div id="searchResults" style="display: none; max-height: 300px; overflow-y: auto; border: 2px solid #667eea; border-radius: 8px; padding: 10px; background: white; margin-bottom: 15px;">
                            <!-- Se llena dinÃ¡micamente -->
                        </div>

                        <div style="display: flex; gap: 10px; margin-top: 10px;">
                            <button class="btn btn-primary btn-small" onclick="clearSearch()">
                                ğŸ”„ Limpiar BÃºsqueda
                            </button>
                            <button class="btn btn-warning btn-small" onclick="showAllProducts()">
                                ğŸ“‹ Ver Todos los Productos
                            </button>
                        </div>
                    </div>

                    <!-- PRODUCTOS AGREGADOS AL PEDIDO -->
                    <div id="orderItemsSection" style="display: none;">
                        <div class="config-group">
                            <h3>ğŸ“¦ Productos en el Pedido</h3>
                            <div class="table-container" style="max-height: 400px;">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>CÃ³digo</th>
                                            <th>DescripciÃ³n</th>
                                            <th>Marca</th>
                                            <th>Cantidad</th>
                                            <th>Precio Unit. (Sin IVA)</th>
                                            <th>Subtotal</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="orderItemsTable">
                                        <!-- Se llena dinÃ¡micamente -->
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- RESUMEN DEL PEDIDO -->
                        <div class="order-summary">
                            <h3>ğŸ’° Resumen del Pedido</h3>
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; font-size: 1.1em; margin-top: 15px;">
                                <div>
                                    <strong>Total Items:</strong><br>
                                    <span id="orderTotalItems" style="font-size: 1.5em; color: #667eea;">0</span>
                                </div>
                                <div>
                                    <strong>Total Unidades:</strong><br>
                                    <span id="orderTotalUnits" style="font-size: 1.5em; color: #667eea;">0</span>
                                </div>
                                <div>
                                    <strong>TOTAL PEDIDO (Sin IVA):</strong><br>
                                    <span id="orderTotalAmount" style="font-size: 1.8em; color: #2e7d32; font-weight: bold;">$0.00</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- BOTONES DE ACCIÃ“N -->
                <div style="display: flex; gap: 10px; margin-top: 20px; justify-content: center;">
                    <button class="btn btn-success" onclick="saveOrder()" style="font-size: 1.2em; padding: 15px 40px;">
                        ğŸ’¾ Guardar Pedido
                    </button>
                    <button class="btn btn-danger" onclick="cancelOrder()" style="font-size: 1.2em; padding: 15px 40px;">
                        âŒ Cancelar
                    </button>
                </div>
            </div>

            <!-- LISTA DE PEDIDOS -->
            <div id="ordersList">
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>NÂ° Pedido</th>
                                <th>Fecha</th>
                                <th>Cliente</th>
                                <th>Vendedor</th>
                                <th>Items</th>
                                <th>Total</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="ordersTableBody"><tr><td colspan="8" style="text-align: center; padding: 40px; color: #999;">No hay pedidos registrados.</td></tr></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- PESTAÃ‘A PEDIDOS A FÃBRICA -->
        <div id="factory-orders" class="tab-content">
            <h2 style="margin-bottom: 20px;">ğŸ­ Pedidos a FÃ¡brica / Proveedores</h2>
            
            <div class="alert alert-info" style="margin-bottom: 25px;">
                <strong>ğŸ’¡ Â¿CÃ³mo funciona?</strong><br>
                GestionÃ¡ tus pedidos a proveedores: controlÃ¡ stock, creÃ¡ pedidos, seguÃ­ el estado y comparÃ¡ lo pedido vs lo recibido.
            </div>

            <!-- ESTADÃSTICAS RÃPIDAS -->
            <div class="stats" style="margin-bottom: 25px;">
                <div class="stat-card" style="display: block; background: #fff3e0;">
                    <h3 id="factoryOrdersPending" style="color: #ff9800;">0</h3>
                    <p>Pedidos Pendientes</p>
                </div>
                <div class="stat-card" style="display: block; background: #e3f2fd;">
                    <h3 id="factoryOrdersSent" style="color: #2196f3;">0</h3>
                    <p>Enviados</p>
                </div>
                <div class="stat-card" style="display: block; background: #e8f5e9;">
                    <h3 id="factoryOrdersReceived" style="color: #4caf50;">0</h3>
                    <p>Recibidos</p>
                </div>
                <div class="stat-card" style="display: block; background: #ffebee;">
                    <h3 id="lowStockCount" style="color: #f44336;">0</h3>
                    <p>Productos Stock Bajo</p>
                </div>
            </div>

            <!-- TABS INTERNOS -->
            <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                <button class="btn btn-primary" onclick="showFactoryTab('new-order')" id="btnNewOrder">â• Nuevo Pedido</button>
                <button class="btn btn-secondary" onclick="showFactoryTab('stock-entry')" id="btnStockEntry">ğŸ“¥ Entrada de MercaderÃ­a</button>
                <button class="btn btn-secondary" onclick="showFactoryTab('stock-control')" id="btnStockControl">ğŸ“¦ Control de Stock</button>
                <button class="btn btn-secondary" onclick="showFactoryTab('order-history')" id="btnOrderHistory">ğŸ“‹ Historial de Pedidos</button>
                <button class="btn btn-secondary" onclick="showFactoryTab('low-stock')" id="btnLowStock">âš ï¸ Stock Bajo</button>
            </div>

            <!-- NUEVO PEDIDO -->
            <div id="factory-new-order" class="factory-tab-content">
                <div class="config-panel">
                    <div class="config-group">
                        <h3>ğŸ“ Crear Pedido a Proveedor</h3>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                            <div class="input-group">
                                <label>Proveedor *</label>
                                <select id="factoryOrderSupplier" onchange="loadSupplierProducts()">
                                    <option value="">-- Seleccionar Proveedor --</option>
                                </select>
                            </div>
                            <div class="input-group">
                                <label>Fecha del Pedido</label>
                                <input type="date" id="factoryOrderDate" value="">
                            </div>
                        </div>
                        
                        <div class="input-group">
                            <label>Notas / Observaciones</label>
                            <textarea id="factoryOrderNotes" placeholder="Ej: Urgente, enviar por transporte X, etc." style="width: 100%; padding: 10px; border-radius: 8px; border: 2px solid #e0e0e0; min-height: 60px;"></textarea>
                        </div>
                    </div>
                </div>

                <!-- PRODUCTOS DEL PROVEEDOR -->
                <div id="supplierProductsContainer" style="display: none; margin-top: 20px;">
                    <div class="config-panel">
                        <div class="config-group">
                            <h3>ğŸ“¦ Productos de <span id="selectedSupplierName"></span></h3>
                            
                            <div style="margin-bottom: 15px;">
                                <input type="text" id="factoryProductSearch" placeholder="ğŸ” Buscar producto..." class="search-box" onkeyup="filterFactoryProducts()" style="width: 100%; max-width: 400px;">
                            </div>
                            
                            <div style="max-height: 400px; overflow-y: auto;">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>CÃ³digo</th>
                                            <th>DescripciÃ³n</th>
                                            <th>Stock Actual</th>
                                            <th>Stock MÃ­n.</th>
                                            <th>Precio Lista</th>
                                            <th>Cantidad a Pedir</th>
                                            <th>Subtotal</th>
                                        </tr>
                                    </thead>
                                    <tbody id="factoryProductsBody"></tbody>
                                </table>
                            </div>
                            
                            <div style="margin-top: 20px; padding: 15px; background: #e8f5e9; border-radius: 10px; display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong>Total del Pedido:</strong>
                                    <span id="factoryOrderTotal" style="font-size: 1.5em; color: #4caf50; margin-left: 10px;">$0.00</span>
                                </div>
                                <div style="display: flex; gap: 10px;">
                                    <button class="btn btn-success" onclick="saveFactoryOrder()">ğŸ’¾ Guardar Pedido</button>
                                    <button class="btn btn-primary" onclick="sendFactoryOrderWhatsApp()">ğŸ“± Enviar por WhatsApp</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ENTRADA DE MERCADERÃA -->
            <div id="factory-stock-entry" class="factory-tab-content" style="display: none;">
                <div class="config-panel">
                    <div class="config-group">
                        <h3>ğŸ“¥ Entrada de MercaderÃ­a</h3>
                        <p style="color: #666; margin-bottom: 15px;">CargÃ¡ el stock cuando recibÃ­s mercaderÃ­a de tus proveedores.</p>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                            <div class="input-group">
                                <label>Proveedor</label>
                                <select id="entrySupplier" onchange="loadEntryProducts()">
                                    <option value="">-- Seleccionar Proveedor --</option>
                                </select>
                            </div>
                            <div class="input-group">
                                <label>Fecha de Entrada</label>
                                <input type="date" id="entryDate" value="">
                            </div>
                            <div class="input-group">
                                <label>NÂº Remito / Factura</label>
                                <input type="text" id="entryInvoice" placeholder="Ej: 0001-00012345">
                            </div>
                        </div>
                        
                        <div class="input-group">
                            <label>Observaciones</label>
                            <textarea id="entryNotes" placeholder="Notas adicionales..." style="width: 100%; padding: 10px; border-radius: 8px; border: 2px solid #e0e0e0; min-height: 50px;"></textarea>
                        </div>
                    </div>
                </div>

                <!-- PRODUCTOS PARA ENTRADA -->
                <div id="entryProductsContainer" style="display: none; margin-top: 20px;">
                    <div class="config-panel">
                        <div class="config-group">
                            <h3>ğŸ“¦ Productos de <span id="entrySupplierName"></span></h3>
                            
                            <div style="margin-bottom: 15px;">
                                <input type="text" id="entryProductSearch" placeholder="ğŸ” Buscar producto..." class="search-box" onkeyup="filterEntryProducts()" style="width: 100%; max-width: 400px;">
                            </div>
                            
                            <div style="max-height: 400px; overflow-y: auto;">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>CÃ³digo</th>
                                            <th>DescripciÃ³n</th>
                                            <th>Stock Actual</th>
                                            <th>Cantidad Recibida</th>
                                            <th>Nuevo Stock</th>
                                        </tr>
                                    </thead>
                                    <tbody id="entryProductsBody"></tbody>
                                </table>
                            </div>
                            
                            <div style="margin-top: 20px; padding: 15px; background: #e8f5e9; border-radius: 10px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                                <div>
                                    <strong>Total productos a cargar:</strong>
                                    <span id="entryTotalProducts" style="font-size: 1.3em; color: #4caf50; margin-left: 10px;">0</span>
                                </div>
                                <button class="btn btn-success" onclick="saveStockEntry()" style="padding: 15px 30px; font-size: 1.1em;">
                                    âœ… Confirmar Entrada de MercaderÃ­a
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- HISTORIAL DE ENTRADAS -->
                <div style="margin-top: 25px;">
                    <div class="config-panel">
                        <div class="config-group">
                            <h3>ğŸ“‹ Ãšltimas Entradas de MercaderÃ­a</h3>
                            <div style="max-height: 300px; overflow-y: auto;">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>Fecha</th>
                                            <th>Proveedor</th>
                                            <th>Remito/Factura</th>
                                            <th>Productos</th>
                                            <th>Unidades</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="stockEntriesHistoryBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CONTROL DE STOCK -->
            <div id="factory-stock-control" class="factory-tab-content" style="display: none;">
                <div class="config-panel">
                    <div class="config-group">
                        <h3>ğŸ“¦ Control de Stock</h3>
                        <p style="color: #666; margin-bottom: 15px;">ConfigurÃ¡ el stock actual y mÃ­nimo de cada producto para recibir alertas.</p>
                        
                        <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
                            <select id="stockSupplierFilter" onchange="filterStockBySupplier()" style="padding: 10px; border-radius: 8px; border: 2px solid #e0e0e0;">
                                <option value="">Todos los Proveedores</option>
                            </select>
                            <input type="text" id="stockProductSearch" placeholder="ğŸ” Buscar producto..." class="search-box" onkeyup="filterStockProducts()" style="flex: 1; min-width: 200px;">
                        </div>
                        
                        <div style="max-height: 500px; overflow-y: auto;">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>CÃ³digo</th>
                                        <th>DescripciÃ³n</th>
                                        <th>Proveedor</th>
                                        <th>Stock Actual</th>
                                        <th>Stock MÃ­nimo</th>
                                        <th>Estado</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="stockControlBody"></tbody>
                            </table>
                        </div>
                        
                        <div style="margin-top: 15px;">
                            <button class="btn btn-success" onclick="saveAllStock()">ğŸ’¾ Guardar Cambios de Stock</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- HISTORIAL DE PEDIDOS -->
            <div id="factory-order-history" class="factory-tab-content" style="display: none;">
                <div class="config-panel">
                    <div class="config-group">
                        <h3>ğŸ“‹ Historial de Pedidos a Proveedores</h3>
                        
                        <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
                            <select id="historySupplierFilter" onchange="filterOrderHistory()" style="padding: 10px; border-radius: 8px; border: 2px solid #e0e0e0;">
                                <option value="">Todos los Proveedores</option>
                            </select>
                            <select id="historyStatusFilter" onchange="filterOrderHistory()" style="padding: 10px; border-radius: 8px; border: 2px solid #e0e0e0;">
                                <option value="">Todos los Estados</option>
                                <option value="pendiente">Pendiente</option>
                                <option value="enviado">Enviado</option>
                                <option value="recibido">Recibido</option>
                                <option value="parcial">Recibido Parcial</option>
                            </select>
                        </div>
                        
                        <div style="max-height: 500px; overflow-y: auto;">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>NÂº Pedido</th>
                                        <th>Fecha</th>
                                        <th>Proveedor</th>
                                        <th>Productos</th>
                                        <th>Total</th>
                                        <th>Estado</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="factoryOrdersHistoryBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- STOCK BAJO -->
            <div id="factory-low-stock" class="factory-tab-content" style="display: none;">
                <div class="config-panel">
                    <div class="config-group">
                        <h3>âš ï¸ Productos con Stock Bajo</h3>
                        <p style="color: #666; margin-bottom: 15px;">Productos que estÃ¡n por debajo del stock mÃ­nimo configurado.</p>
                        
                        <div style="max-height: 500px; overflow-y: auto;">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>CÃ³digo</th>
                                        <th>DescripciÃ³n</th>
                                        <th>Proveedor</th>
                                        <th>Stock Actual</th>
                                        <th>Stock MÃ­nimo</th>
                                        <th>Faltan</th>
                                        <th>AcciÃ³n</th>
                                    </tr>
                                </thead>
                                <tbody id="lowStockBody"></tbody>
                            </table>
                        </div>
                        
                        <div style="margin-top: 15px;">
                            <button class="btn btn-warning" onclick="generateLowStockOrders()">ğŸ“ Generar Pedidos para Stock Bajo</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- PESTAÃ‘A VENDEDORES -->
        <div id="sellers" class="tab-content">
            <h2 style="margin-bottom: 20px;">ğŸ‘¥ GestiÃ³n de Vendedores</h2>
            
            <div class="config-panel">
                <div class="config-group">
                    <h3>â• Agregar Nuevo Vendedor</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="input-group">
                            <label>Nombre Completo *</label>
                            <input type="text" id="newSellerName" placeholder="Ej: Juan PÃ©rez">
                        </div>
                        <div class="input-group">
                            <label>Usuario * (para login)</label>
                            <input type="text" id="newSellerUsername" placeholder="Ej: jperez">
                            <small>Solo letras minÃºsculas y nÃºmeros, sin espacios</small>
                        </div>
                        <div class="input-group">
                            <label>ContraseÃ±a *</label>
                            <input type="password" id="newSellerPassword" placeholder="ContraseÃ±a">
                        </div>
                        <div class="input-group">
                            <label>Confirmar ContraseÃ±a *</label>
                            <input type="password" id="newSellerPasswordConfirm" placeholder="Repetir contraseÃ±a">
                        </div>
                        <div class="input-group">
                            <label>TelÃ©fono</label>
                            <input type="text" id="newSellerPhone" placeholder="Ej: 3584-123456">
                        </div>
                        <div class="input-group">
                            <label>Email</label>
                            <input type="email" id="newSellerEmail" placeholder="vendedor@email.com">
                        </div>
                    </div>
                    <button class="btn btn-success" onclick="addSeller()" style="margin-top: 15px;">
                        â• Agregar Vendedor
                    </button>
                </div>
            </div>

            <h3 style="margin-top: 30px; margin-bottom: 15px;">Lista de Vendedores</h3>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Nombre</th>
                            <th>Usuario</th>
                            <th>TelÃ©fono</th>
                            <th>Email</th>
                            <th>Pedidos</th>
                            <th>Fecha Alta</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="sellersTableBody"><tr><td colspan="7" style="text-align: center; padding: 40px; color: #999;">No hay vendedores registrados.</td></tr></tbody>
                </table>
            </div>
        </div>

        <!-- PESTAÃ‘A CLIENTES -->
        <div id="clients" class="tab-content">
            <h2 style="margin-bottom: 20px;">ğŸ›’ GestiÃ³n de Clientes</h2>
            
            <div class="alert alert-info" style="margin-bottom: 25px;">
                <strong>ğŸ’¡ Â¿CÃ³mo funciona?</strong><br>
                Los clientes registrados pueden ingresar a su portal personal para:<br>
                â€¢ Ver el catÃ¡logo con precios mayoristas sin IVA<br>
                â€¢ Armar pedidos y enviarlos directamente<br>
                â€¢ Ver el historial de sus pedidos<br>
                â€¢ Actualizar sus datos de contacto
            </div>

            <div class="config-panel">
                <div class="config-group">
                    <h3>â• Registrar Nuevo Cliente</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="input-group">
                            <label>Nombre/RazÃ³n Social *</label>
                            <input type="text" id="newClientName" placeholder="Ej: FerreterÃ­a Central">
                        </div>
                        <div class="input-group">
                            <label>Usuario * (para login)</label>
                            <input type="text" id="newClientUsername" placeholder="Ej: ferreteriacentral">
                            <small>Solo letras minÃºsculas y nÃºmeros, sin espacios</small>
                        </div>
                        <div class="input-group">
                            <label>ContraseÃ±a *</label>
                            <input type="password" id="newClientPassword" placeholder="ContraseÃ±a">
                        </div>
                        <div class="input-group">
                            <label>Confirmar ContraseÃ±a *</label>
                            <input type="password" id="newClientPasswordConfirm" placeholder="Repetir contraseÃ±a">
                        </div>
                        <div class="input-group">
                            <label>CUIT/DNI</label>
                            <input type="text" id="newClientTaxId" placeholder="20-12345678-9">
                        </div>
                        <div class="input-group">
                            <label>TelÃ©fono</label>
                            <input type="text" id="newClientPhone" placeholder="3585-123456">
                        </div>
                        <div class="input-group">
                            <label>Email</label>
                            <input type="email" id="newClientEmail" placeholder="cliente@email.com">
                        </div>
                        <div class="input-group">
                            <label>DirecciÃ³n</label>
                            <input type="text" id="newClientAddress" placeholder="Calle, NÃºmero, Ciudad">
                        </div>
                    </div>
                    <button class="btn btn-success" onclick="addClient()" style="margin-top: 15px;">
                        â• Registrar Cliente
                    </button>
                </div>
            </div>

            <h3 style="margin-top: 30px; margin-bottom: 15px;">Lista de Clientes Registrados</h3>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Nombre/RazÃ³n Social</th>
                            <th>Usuario</th>
                            <th>CUIT/DNI</th>
                            <th>TelÃ©fono</th>
                            <th>Email</th>
                            <th>Pedidos</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="clientsTableBody"><tr><td colspan="8" style="text-align: center; padding: 40px; color: #999;">No hay clientes registrados aÃºn.</td></tr></tbody>
                </table>
            </div>

            <div class="alert alert-success" style="margin-top: 30px;">
                <strong>ğŸ“² Compartir credenciales con el cliente:</strong><br>
                Una vez registrado el cliente, podÃ©s enviarle sus credenciales por WhatsApp o Email junto con el link:<br>
                <div style="display: flex; align-items: center; gap: 10px; margin-top: 10px;">
                    <code id="systemUrl" style="background: white; padding: 8px 15px; border-radius: 5px; flex: 1;">
                        https://bruzzonedistribuidora.github.io/bruzzonedistribuidora
                    </code>
                    <button class="btn btn-primary" onclick="copySystemUrl()" style="padding: 8px 15px;">
                        ğŸ“‹ Copiar
                    </button>
                    <a href="https://wa.me/?text=Hola! Te comparto el acceso al catÃ¡logo de BRUZZONE DISTRIBUIDORA: https://bruzzonedistribuidora.github.io/bruzzonedistribuidora" target="_blank" class="btn btn-success" style="padding: 8px 15px; text-decoration: none;">
                        ğŸ“± WhatsApp
                    </a>
                </div>
            </div>
        </div>

        <!-- PESTAÃ‘A PUBLICIDADES -->
        <div id="banners" class="tab-content">
            <h2 style="margin-bottom: 20px;">ğŸ“¢ GestiÃ³n de Publicidades y Avisos</h2>
            
            <div class="alert alert-info" style="margin-bottom: 25px;">
                <strong>ğŸ’¡ Â¿CÃ³mo funciona?</strong><br>
                CreÃ¡ avisos, ofertas y publicidades que los clientes verÃ¡n cuando ingresen al portal.<br>
                Ideal para destacar promociones, productos nuevos, ofertas especiales, etc.
            </div>

            <div class="config-panel">
                <div class="config-group">
                    <h3>â• Crear Nueva Publicidad</h3>
                    <div style="display: grid; gap: 15px;">
                        <div class="input-group">
                            <label>TÃ­tulo del Aviso *</label>
                            <input type="text" id="newBannerTitle" placeholder="Ej: Â¡OFERTA ESPECIAL! 20% de descuento">
                        </div>
                        <div class="input-group">
                            <label>Mensaje/DescripciÃ³n *</label>
                            <textarea id="newBannerMessage" placeholder="Describe la oferta o el aviso..." style="min-height: 80px; resize: vertical; padding: 12px; border: 2px solid #ddd; border-radius: 8px; width: 100%;"></textarea>
                        </div>
                        <div class="input-group">
                            <label>ğŸ–¼ï¸ Imagen (opcional)</label>
                            <input type="text" id="newBannerImage" placeholder="URL de la imagen (https://...)">
                            <small style="color: #666;">PegÃ¡ el link de una imagen. PodÃ©s subir imÃ¡genes a <a href="https://imgbb.com/" target="_blank">imgbb.com</a> gratis.</small>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                            <div class="input-group">
                                <label>Color del Banner</label>
                                <select id="newBannerColor" style="padding: 12px;">
                                    <option value="blue">ğŸ”µ Azul (Info)</option>
                                    <option value="green">ğŸŸ¢ Verde (Ofertas)</option>
                                    <option value="orange">ğŸŸ  Naranja (Destacado)</option>
                                    <option value="red">ğŸ”´ Rojo (Urgente)</option>
                                    <option value="purple">ğŸŸ£ Morado (Nuevo)</option>
                                </select>
                            </div>
                            <div class="input-group">
                                <label>VÃ¡lido hasta (opcional)</label>
                                <input type="date" id="newBannerExpiry" style="padding: 12px;">
                            </div>
                            <div class="input-group">
                                <label style="display: flex; align-items: center; cursor: pointer; margin-top: 25px;">
                                    <input type="checkbox" id="newBannerActive" checked="" style="width: auto; margin-right: 10px;">
                                    <span>Activo</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    <button class="btn btn-success" onclick="addBanner()" style="margin-top: 15px;">
                        â• Crear Publicidad
                    </button>
                </div>
            </div>

            <h3 style="margin-top: 30px; margin-bottom: 15px;">Publicidades Activas</h3>
            <div id="bannersContainer">
                <div style="text-align: center; padding: 40px; color: #999;">
                    No hay publicidades creadas aÃºn.
                </div>
            </div>
        </div>

        <div id="company" class="tab-content">
            <h2 style="margin-bottom: 20px;">ğŸ­ ConfiguraciÃ³n de Mi Empresa</h2>
            
            <div class="config-panel">
                <div class="config-group">
                    <h3>ğŸ¢ Datos de la Empresa</h3>
                    <div class="input-group">
                        <label>Nombre de la Empresa</label>
                        <input type="text" id="companyName" value="BRUZZONE DISTRIBUIDORA" placeholder="Nombre de tu empresa">
                        <small>Este nombre aparecerÃ¡ en el header y en las exportaciones</small>
                    </div>
                    <div class="input-group">
                        <label>Eslogan / SubtÃ­tulo</label>
                        <input type="text" id="companySlogan" value="MAYORISTA" placeholder="Ej: MAYORISTA Â· DISTRIBUCIÃ“N">
                        <small>Aparece debajo del nombre principal</small>
                    </div>
                </div>

                <div class="config-group">
                    <h3>ğŸ“ Datos de Contacto</h3>
                    <div class="input-group">
                        <label>DirecciÃ³n Completa</label>
                        <input type="text" id="companyAddress" value="Dr. Carlos Rocha 128 - Alejandro Roca, CÃ³rdoba" placeholder="Calle, nÃºmero, ciudad, provincia">
                    </div>
                    <div class="input-group">
                        <label>TelÃ©fono</label>
                        <input type="text" id="companyPhone" value="3585142098" placeholder="Ej: 3584-123456">
                        <small>Puede incluir cÃ³digo de Ã¡rea y guiones</small>
                    </div>
                    <div class="input-group">
                        <label>Email</label>
                        <input type="email" id="companyEmail" value="bruzzonedistribuidora@gmail.com" placeholder="contacto@tuempresa.com">
                    </div>
                </div>

                <div class="config-group">
                    <h3>ğŸ–¼ï¸ Logo de la Empresa</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div>
                            <p style="color: #666; margin-bottom: 15px;">
                                SubÃ­ el logo de tu empresa (formato PNG, JPG o SVG)
                            </p>
                            <input type="file" id="logoFileInput" accept="image/png,image/jpeg,image/jpg,image/svg+xml" style="display: none;" onchange="uploadLogo(event)">
                            <button class="btn btn-primary" onclick="document.getElementById(&#39;logoFileInput&#39;).click()">
                                ğŸ“ Seleccionar Logo
                            </button>
                            <button class="btn btn-warning" onclick="removeLogo()" style="margin-left: 10px;">
                                ğŸ—‘ï¸ Quitar Logo
                            </button>
                            <div style="margin-top: 10px; font-size: 0.85em; color: #666;">
                                <strong>Recomendaciones:</strong><br>
                                â€¢ TamaÃ±o recomendado: 150x150 px<br>
                                â€¢ Formato: PNG con fondo transparente<br>
                                â€¢ Peso mÃ¡ximo: 500 KB
                            </div>
                        </div>
                        <div>
                            <div style="background: white; border: 2px solid #e0e0e0; border-radius: 10px; padding: 20px; text-align: center; min-height: 200px; display: flex; align-items: center; justify-content: center;">
                                <img id="logoPreview" src="file:///C:/Users/Administrador.SERVER.000/Documents/distribucion%20web/index.html" alt="Logo Preview" style="max-width: 150px; max-height: 150px; display: none;">
                                <div id="noLogoText" style="color: #999;">
                                    <div style="font-size: 3em; margin-bottom: 10px;">ğŸ¢</div>
                                    <div>Sin logo cargado</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <button class="btn btn-success" onclick="saveCompanyData()" style="font-size: 1.2em; padding: 15px 40px; margin-top: 20px;">
                ğŸ’¾ Guardar ConfiguraciÃ³n de Empresa
            </button>

            <div class="alert alert-info" style="margin-top: 20px;">
                <strong>â„¹ï¸ InformaciÃ³n:</strong> Los cambios se aplicarÃ¡n automÃ¡ticamente en todo el sistema (header, exportaciones, etc.)
            </div>
        </div>

        <!-- PESTAÃ‘A CONFIGURACIÃ“N -->
        <div id="config" class="tab-content">
            <h2 style="margin-bottom: 20px;">âš™ï¸ ConfiguraciÃ³n de MÃ¡rgenes y Comisiones</h2>
            
            <div class="config-panel">
                <div class="config-group">
                    <h3>MÃ¡rgenes de Ganancia</h3>
                    <div class="input-group">
                        <label>Margen Mayorista (%)</label>
                        <input type="number" id="marginWholesale" value="20" min="0" step="0.01" onchange="updatePrices(); saveMargins();">
                        <small>Precio sin comisiÃ³n de vendedor</small>
                    </div>
                    <div class="input-group">
                        <label>Margen Minorista (%)</label>
                        <input type="number" id="marginRetail" value="35" min="0" step="0.01" onchange="updatePrices(); saveMargins();">
                        <small>Precio para consumidor final</small>
                    </div>
                </div>

                <div class="config-group">
                    <h3>Comisiones de Venta</h3>
                    <div class="input-group">
                        <label>ComisiÃ³n Vendedor (%)</label>
                        <input type="number" id="commissionSales" value="5" min="0" step="0.01" onchange="updatePrices(); saveMargins();">
                        <small>Solo se aplica en precio minorista</small>
                    </div>
                </div>

                <div class="config-group">
                    <h3>Opciones de Redondeo</h3>
                    <div class="input-group">
                        <label>Redondear precios a:</label>
                        <select id="roundingOption" onchange="updatePrices(); saveMargins();">
                            <option value="none">Sin redondeo</option>
                            <option value="0">NÃºmero entero mÃ¡s cercano</option>
                            <option value="5">MÃºltiplo de 5</option>
                            <option value="10" selected="">MÃºltiplo de 10</option>
                            <option value="50">MÃºltiplo de 50</option>
                            <option value="100">MÃºltiplo de 100</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- PESTAÃ‘A BACKUP -->
        <div id="backup" class="tab-content">
            <h2 style="margin-bottom: 20px;">ğŸ’¾ Backup y Respaldo de Datos</h2>
            
            <div class="config-panel">
                <div class="config-group">
                    <h3>ğŸ“¤ Exportar Backup</h3>
                    <p style="color: #666; margin-bottom: 15px;">
                        DescargÃ¡ un archivo de respaldo con todos tus datos.
                    </p>
                    <button class="btn btn-success" onclick="exportBackup()">
                        ğŸ’¾ Descargar Backup Completo
                    </button>
                </div>

                <div class="config-group">
                    <h3>ğŸ“¥ Importar Backup</h3>
                    <p style="color: #666; margin-bottom: 15px;">
                        RestaurÃ¡ datos desde un archivo de backup.
                    </p>
                    <input type="file" id="backupFileInput" accept=".json" style="display: none;" onchange="importBackup(event)">
                    <button class="btn btn-primary" onclick="document.getElementById(&#39;backupFileInput&#39;).click()">
                        ğŸ“ Seleccionar Archivo
                    </button>
                </div>

                <div class="config-group">
                    <h3>ğŸ—‘ï¸ Limpiar Datos</h3>
                    <p style="color: #d32f2f; margin-bottom: 15px;">
                        <strong>âš ï¸ CUIDADO:</strong> EliminarÃ¡ TODOS los datos.
                    </p>
                    <button class="btn btn-danger" onclick="clearAllData()">
                        ğŸ—‘ï¸ Eliminar Todos los Datos
                    </button>
                </div>
            </div>
        </div>

        <!-- PESTAÃ‘A CATÃLOGOS -->
        <div id="catalogs" class="tab-content">
            <h2 style="margin-bottom: 20px;">ğŸ“ CatÃ¡logos y Recursos</h2>
            
            <div class="alert alert-info" style="margin-bottom: 20px;">
                <strong>â„¹ï¸ CargÃ¡ imÃ¡genes y PDFs</strong><br>
                <small>Los archivos se asociarÃ¡n a los productos y podrÃ¡n ser compartidos con los clientes a travÃ©s de links en la lista de precios.</small>
            </div>

            <div class="config-panel">
                <div class="config-group">
                    <h3>ğŸ“¤ Cargar Archivo</h3>
                    
                    <!-- ÃREA DE DRAG AND DROP -->
                    <div id="catalogUploadZone" class="upload-zone" style="border: 3px dashed #667eea; border-radius: 15px; padding: 60px; text-align: center; cursor: pointer; transition: all 0.3s; background: #f8f9ff; margin-bottom: 20px;">
                        <div style="font-size: 3em; margin-bottom: 10px;">ğŸ“</div>
                        <h3 style="color: #667eea; margin-bottom: 10px;">ArrastrÃ¡ un archivo aquÃ­</h3>
                        <p style="color: #666; margin-bottom: 20px;">O hacÃ© clic para seleccionar</p>
                        <input type="file" id="catalogFileInput" accept=".jpg,.jpeg,.png,.pdf,.gif" style="display: none;">
                        <small style="color: #999;">JPG, PNG, GIF, PDF â€¢ MÃ¡x 5MB</small>
                    </div>

                    <div class="input-group">
                        <label>Nombre del recurso (opcional)</label>
                        <input type="text" id="catalogResourceName" placeholder="Ej: CatÃ¡logo Completo, Ficha TÃ©cnica, Imagen Producto">
                        <small>Si no colocas nombre, se usarÃ¡ el nombre del archivo</small>
                    </div>

                    <div class="input-group">
                        <label>Asociar a producto (opcional)</label>
                        <select id="catalogProductSelect" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;"><option value="">-- Sin asociar (CatÃ¡logo general) --</option></select>
                        <small>Selecciona un producto si quieres que el link aparezca solo en ese producto</small>
                    </div>

                    <button class="btn btn-success" onclick="uploadCatalogFile()" style="width: 100%; margin-top: 10px;">
                        ğŸ“¤ Cargar Archivo
                    </button>
                </div>
            </div>

            <div style="margin-top: 30px;">
                <h3 style="color: #667eea; margin-bottom: 15px;">ğŸ“‹ Archivos Cargados</h3>
                <div id="catalogFilesTable" style="background: white; border-radius: 10px; overflow: hidden;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead style="background: #667eea; color: white;">
                            <tr>
                                <th style="padding: 12px; text-align: left; border-right: 1px solid #e0e0e0;">Nombre</th>
                                <th style="padding: 12px; text-align: left; border-right: 1px solid #e0e0e0;">Tipo</th>
                                <th style="padding: 12px; text-align: left; border-right: 1px solid #e0e0e0;">Asociado a</th>
                                <th style="padding: 12px; text-align: left;">Opciones</th>
                            </tr>
                        </thead>
                        <tbody id="catalogFilesBody" style="border-top: 1px solid #e0e0e0;"><tr><td colspan="4" style="padding: 30px; text-align: center; color: #999;">No hay archivos cargados todavÃ­a</td></tr></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- PESTAÃ‘A EXPORTAR - ACTUALIZADA CON FILTROS -->
        <div id="export" class="tab-content">
            <h2 style="margin-bottom: 20px;">ğŸ“¤ Exportar Lista de Precios</h2>
            
            <div class="alert alert-info" style="margin-bottom: 20px;">
                <strong>ğŸ“‹ Columnas que se exportarÃ¡n:</strong><br>
                <div style="margin-top: 10px; padding: 10px; background: white; border-radius: 5px;">
                    âœ… <strong>CÃ³digo</strong><br>
                    âœ… <strong>DescripciÃ³n</strong><br>
                    âœ… <strong>Cantidad por Bulto</strong> (si existe en el producto)<br>
                    âœ… <strong>Precios SIN IVA</strong> (Mayorista y/o Minorista segÃºn tipo de lista)
                </div>
            </div>
            
            <div class="config-panel">
                <div class="config-group">
                    <h3>ğŸ¯ Filtrar Productos (Opcional)</h3>
                    <p style="color: #666; margin-bottom: 15px;">
                        Selecciona una <strong>marca</strong> o <strong>proveedor</strong> para exportar solo esos productos. 
                        Si dejas vacÃ­o, se exportarÃ¡n todos.
                    </p>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                        <div class="input-group">
                            <label>Filtrar por Marca</label>
                            <select id="exportFilterBrand" onchange="updateExportProductCount()"><option value="">-- Todas las marcas --</option></select>
                            <small>Selecciona una marca especÃ­fica (opcional)</small>
                        </div>

                        <div class="input-group">
                            <label>Filtrar por Proveedor</label>
                            <select id="exportFilterSupplier" onchange="updateExportProductCount()"><option value="">-- Todos los proveedores --</option></select>
                            <small>Selecciona un proveedor especÃ­fico (opcional)</small>
                        </div>
                    </div>

                    <div class="alert alert-info" style="margin-bottom: 20px; background: #e8f5e9; border: 2px solid #4caf50; color: #2e7d32;">
                        <strong>ğŸ“Š Resumen de exportaciÃ³n:</strong><br>
                        <div style="margin-top: 10px; font-size: 1.1em;">
                            <span id="exportProductCount" style="font-weight: bold; color: #4caf50;">0</span> productos serÃ¡n exportados
                        </div>
                    </div>
                </div>

                <div class="config-group">
                    <h3>Opciones de ExportaciÃ³n</h3>
                    <div class="input-group">
                        <label>Tipo de Lista</label>
                        <select id="exportType">
                            <option value="complete">Lista Completa (Mayorista + Minorista + Marca + Proveedor)</option>
                            <option value="wholesale">Solo Precio Mayorista</option>
                            <option value="retail">Solo Precio Minorista</option>
                        </select>
                        <small>
                            <strong>Completa:</strong> Incluye precios mayoristas, minoristas, marca y proveedor<br>
                            <strong>Mayorista:</strong> Solo incluye precio mayorista<br>
                            <strong>Minorista:</strong> Solo incluye precio minorista
                        </small>
                    </div>
                    <div class="input-group">
                        <label>Nombre del Archivo</label>
                        <input type="text" id="exportFilename" value="lista_precios_bruzzone" placeholder="Nombre del archivo">
                        <small>Se agregarÃ¡ automÃ¡ticamente la fecha al nombre</small>
                    </div>
                    <div class="input-group">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="includeIVA" checked="" style="width: auto; margin-right: 10px;">
                            <span>Incluir IVA en precios de venta</span>
                        </label>
                        <small><strong>âš ï¸ Todos los precios se exportan SIN IVA.</strong> Esta opciÃ³n solo marca en el PDF si estÃ¡ "con IVA en venta" o no.</small>
                    </div>
                </div>
            </div>

            <div style="margin-top: 30px;">
                <h3 style="color: #667eea; margin-bottom: 20px;">ğŸ“‹ Tipo de Documento</h3>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
                    <!-- LISTA DE PRECIOS -->
                    <div style="background: #e8f5e9; padding: 25px; border-radius: 15px; border: 3px solid #4caf50;">
                        <h4 style="color: #2e7d32; margin-bottom: 15px;">ğŸ“Š LISTA DE PRECIOS</h4>
                        <p style="color: #666; margin-bottom: 20px; font-size: 0.95em;">
                            CatÃ¡logo con los productos filtrados y sus precios. Ideal para enviar informaciÃ³n.
                        </p>
                        <div style="display: grid; gap: 10px;">
                            <button class="btn btn-success" onclick="exportToExcel()" style="font-size: 1.1em; padding: 12px;">
                                ğŸ“Š Exportar a Excel
                            </button>
                            <button class="btn btn-primary" onclick="exportToPDF()" style="font-size: 1.1em; padding: 12px;">
                                ğŸ“„ Exportar a PDF
                            </button>
                        </div>
                    </div>

                    <!-- ORDEN DE PEDIDO -->
                    <div style="background: #fff3cd; padding: 25px; border-radius: 15px; border: 3px solid #ff9800;">
                        <h4 style="color: #e65100; margin-bottom: 15px;">ğŸ›’ ORDEN DE PEDIDO</h4>
                        <p style="color: #666; margin-bottom: 20px; font-size: 0.95em;">
                            Formulario para que el cliente complete con cantidades. Solo productos filtrados.
                        </p>
                        <div style="display: grid; gap: 10px;">
                            <button class="btn btn-success" onclick="exportOrderToExcel()" style="font-size: 1.1em; padding: 12px; background: #ff9800; border-color: #ff9800;">
                                ğŸ“Š Orden en Excel
                            </button>
                            <button class="btn btn-primary" onclick="exportOrderToPDF()" style="font-size: 1.1em; padding: 12px; background: #f57c00; border-color: #f57c00;">
                                ğŸ“„ Orden en PDF
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="alert alert-info" style="margin-top: 20px;">
                <strong>ğŸ’¡ Â¿CuÃ¡l usar?</strong><br>
                â€¢ <strong>Lista de Precios</strong> â†’ Para mostrar productos disponibles y precios<br>
                â€¢ <strong>Orden de Pedido</strong> â†’ Para que el cliente complete cantidades y haga el pedido
            </div>
        </div>
    </div>
    <!-- FIN MAINSYSTEM -->

    <!-- PORTAL DE CLIENTES -->
    <div id="clientPortal" style="display: none;">
        <div class="header">
            <div class="header-top">
                <div></div>
                <div class="user-info">
                    <span>ğŸ‘¤ <strong id="clientUsername"></strong></span>
                    <span>|</span>
                    <span style="color: #4caf50;">Cliente</span>
                    <button class="logout-btn" onclick="logout()">Cerrar SesiÃ³n</button>
                </div>
            </div>
            <div class="header-content">
                <img src="data:image/svg+xml,%3Csvg xmlns=&#39;http://www.w3.org/2000/svg&#39; width=&#39;150&#39; height=&#39;150&#39; viewBox=&#39;0 0 150 150&#39;%3E%3Crect fill=&#39;%23667eea&#39; width=&#39;150&#39; height=&#39;150&#39;/%3E%3Ctext x=&#39;50%25&#39; y=&#39;50%25&#39; dominant-baseline=&#39;middle&#39; text-anchor=&#39;middle&#39; font-family=&#39;Arial&#39; font-size=&#39;60&#39; fill=&#39;white&#39; font-weight=&#39;bold&#39;%3EB%3C/text%3E%3C/svg%3E" class="header-logo" alt="Logo Bruzzone">
                <div class="header-info">
                    <h1>ğŸ› ï¸ BRUZZONE DISTRIBUIDORA</h1>
                    <p style="font-size: 1.3em; font-weight: 600;">MAYORISTA</p>
                    <div class="header-contact">
                    <p>ğŸ“ Dr. Carlos Rocha 128 - Alejandro Roca, CÃ³rdoba</p>
                    <p>ğŸ“± 3585142098</p>
                </div>
                </div>
            </div>
            <p style="font-size: 1em; margin-top: 15px;">Portal de Clientes</p>
        </div>

        <div class="tabs">
            <button class="tab-btn active" onclick="showClientTab(&#39;clientOffers&#39;, event)" style="font-size: 1.1em; padding: 15px 25px;">ğŸ Ofertas</button>
            <button class="tab-btn" onclick="showClientTab(&#39;clientData&#39;, event)" style="font-size: 1.1em; padding: 15px 25px;">ğŸ‘¤ Mis Datos</button>
            <button class="tab-btn" onclick="showClientTab(&#39;clientCatalog&#39;, event)" style="font-size: 1.1em; padding: 15px 25px;">ğŸ“¦ CatÃ¡logo</button>
            <button class="tab-btn" onclick="showClientTab(&#39;clientCart&#39;, event)" style="font-size: 1.1em; padding: 15px 25px;">
                ğŸ›’ Mi Pedido <span id="cartCount" style="background: #f44336; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.9em; margin-left: 5px;">0</span>
            </button>
            <button class="tab-btn" onclick="showClientTab(&#39;clientOrders&#39;, event)" style="font-size: 1.1em; padding: 15px 25px;">ğŸ“‹ Mis Pedidos</button>
        </div>

        <div class="container">
            <!-- OFERTAS Y ANUNCIOS -->
            <div id="clientOffers" class="tab-content">
                <h2>ğŸ Ofertas y Novedades</h2>
                
                <div id="clientOffersContainer">
                    <!-- Se llena dinÃ¡micamente -->
                </div>
            </div>

            <!-- MIS DATOS -->
            <div id="clientData" class="tab-content">
                <h2>ğŸ‘¤ Mis Datos</h2>
                
                <div class="config-panel">
                    <div class="config-group">
                        <h3>InformaciÃ³n Personal</h3>
                        <div class="input-group">
                            <label>Nombre/RazÃ³n Social</label>
                            <input type="text" id="clientName" placeholder="Tu nombre completo o razÃ³n social">
                        </div>
                        <div class="input-group">
                            <label>CUIT/DNI</label>
                            <input type="text" id="clientTaxId" placeholder="20-12345678-9">
                        </div>
                        <div class="input-group">
                            <label>TelÃ©fono</label>
                            <input type="text" id="clientPhone" placeholder="3585-123456">
                        </div>
                        <div class="input-group">
                            <label>Email</label>
                            <input type="email" id="clientEmail" placeholder="tu@email.com">
                        </div>
                        <div class="input-group">
                            <label>DirecciÃ³n</label>
                            <input type="text" id="clientAddress" placeholder="Calle, NÃºmero, Ciudad">
                        </div>
                        <button class="btn btn-success" onclick="saveClientData()">
                            ğŸ’¾ Guardar Datos
                        </button>
                    </div>
                </div>
            </div>

            <!-- CATÃLOGO -->
            <div id="clientCatalog" class="tab-content" style="display: none;">
                <h2>ğŸ“¦ CatÃ¡logo de Productos</h2>
                
                <!-- SECCIÃ“N DE PUBLICIDADES/OFERTAS -->
                <div id="clientBannersSection" style="margin-bottom: 25px;">
                    <!-- Se llena dinÃ¡micamente con los anuncios -->
                </div>

                <div style="background: #e3f2fd; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                    <p style="color: #1976d2; margin: 0;"><strong>ğŸ’° Precios Mayoristas sin IVA</strong></p>
                    <p style="color: #666; margin: 5px 0 0 0; font-size: 0.9em;">AgregÃ¡ productos a tu pedido haciendo click en "Agregar"</p>
                </div>

                <div style="margin-bottom: 20px;">
                    <input type="text" id="clientCatalogSearch" placeholder="ğŸ” Buscar por cÃ³digo, descripciÃ³n o marca..." class="search-box" onkeyup="filterClientCatalog()">
                </div>

                <div id="clientCatalogContainer">
                    <!-- Se llena dinÃ¡micamente -->
                </div>
            </div>

            <!-- MI PEDIDO (CARRITO) -->
            <div id="clientCart" class="tab-content" style="display: none;">
                <h2>ğŸ›’ Mi Pedido Actual</h2>
                
                <div id="cartItems">
                    <div style="text-align: center; padding: 60px 20px; color: #999;">
                        <div style="font-size: 4em; margin-bottom: 20px;">ğŸ›’</div>
                        <h3>Tu carrito estÃ¡ vacÃ­o</h3>
                        <p>AgregÃ¡ productos desde el catÃ¡logo</p>
                    </div>
                </div>

                <div id="cartSummary" style="display: none; margin-top: 30px; padding: 25px; background: #f5f5f5; border-radius: 15px;">
                    <h3 style="margin-bottom: 20px;">Resumen del Pedido</h3>
                    <div style="display: grid; gap: 15px; font-size: 1.1em;">
                        <div style="display: flex; justify-content: space-between;">
                            <span>Subtotal:</span>
                            <strong id="cartSubtotal">$0.00</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding-top: 15px; border-top: 2px solid #ddd; font-size: 1.3em; color: #667eea;">
                            <span><strong>TOTAL:</strong></span>
                            <strong id="cartTotal">$0.00</strong>
                        </div>
                    </div>
                    
                    <div style="margin-top: 25px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">Observaciones (opcional):</label>
                        <textarea id="orderNotes" placeholder="Indicaciones especiales para tu pedido..." style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; resize: vertical; min-height: 80px;"></textarea>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 25px;">
                        <button class="btn btn-warning" onclick="clearCart()">
                            ğŸ—‘ï¸ Vaciar Carrito
                        </button>
                        <button class="btn btn-success" onclick="submitClientOrder()" style="font-size: 1.1em;">
                            ğŸ“¤ Enviar Pedido
                        </button>
                    </div>
                </div>
            </div>

            <!-- MIS PEDIDOS -->
            <div id="clientOrders" class="tab-content" style="display: none;">
                <h2>ğŸ“‹ Historial de Pedidos</h2>
                
                <div id="clientOrdersList">
                    <div style="text-align: center; padding: 60px 20px; color: #999;">
                        <div style="font-size: 4em; margin-bottom: 20px;">ğŸ“‹</div>
                        <h3>No tenÃ©s pedidos aÃºn</h3>
                        <p>Tus pedidos aparecerÃ¡n aquÃ­ una vez que los envÃ­es</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // =============================================
        // CONFIGURACIÃ“N DE FIREBASE
        // =============================================
        const firebaseConfig = {
            apiKey: "AIzaSyAOW6EDEw5RsnypWryhr3qFg9cWjQkottA",
            authDomain: "bruzzone-distribuidora-42a19.firebaseapp.com",
            projectId: "bruzzone-distribuidora-42a19",
            storageBucket: "bruzzone-distribuidora-42a19.firebasestorage.app",
            messagingSenderId: "842215586842",
            appId: "1:842215586842:web:d9513c0d156b826de1e5a3"
        };

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        // Variable para controlar si Firebase estÃ¡ disponible
        let firebaseAvailable = true;
        let isLoadingFromFirebase = false;
        
        console.log('ğŸ”¥ Firebase inicializado correctamente');

        // =============================================
        // FUNCIONES DE FIREBASE
        // =============================================
        
        // Guardar datos en Firebase
        async function saveToFirebase() {
            if (!firebaseAvailable || isLoadingFromFirebase) return;
            
            console.log('â˜ï¸ Guardando en Firebase...');
            
            try {
                // Guardar proveedores
                await db.collection('config').doc('suppliers').set({
                    data: suppliersData,
                    updatedAt: new Date().toISOString()
                });
                
                // Guardar productos
                await db.collection('config').doc('products').set({
                    data: productsData,
                    updatedAt: new Date().toISOString()
                });
                
                // Guardar pedidos
                await db.collection('config').doc('orders').set({
                    data: ordersData,
                    updatedAt: new Date().toISOString()
                });
                
                // Guardar clientes
                await db.collection('config').doc('clients').set({
                    data: clientsData,
                    updatedAt: new Date().toISOString()
                });
                
                // Guardar usuarios/vendedores
                await db.collection('config').doc('users').set({
                    data: users,
                    updatedAt: new Date().toISOString()
                });
                
                // Guardar plantillas de columnas
                await db.collection('config').doc('templates').set({
                    data: columnTemplates,
                    updatedAt: new Date().toISOString()
                });
                
                // Guardar catÃ¡logos
                await db.collection('config').doc('catalogs').set({
                    data: catalogFiles,
                    updatedAt: new Date().toISOString()
                });
                
                // Guardar datos de empresa
                await db.collection('config').doc('company').set({
                    data: companyData,
                    updatedAt: new Date().toISOString()
                });
                
                // Guardar mÃ¡rgenes
                await db.collection('config').doc('margins').set({
                    data: marginSettingsMemory,
                    updatedAt: new Date().toISOString()
                });
                
                // Guardar publicidades/anuncios
                await db.collection('config').doc('announcements').set({
                    data: announcementsData,
                    updatedAt: new Date().toISOString()
                });
                
                // Guardar pedidos a fÃ¡brica
                await db.collection('config').doc('factoryOrders').set({
                    data: factoryOrdersData,
                    updatedAt: new Date().toISOString()
                });
                
                // Guardar datos de stock
                await db.collection('config').doc('stock').set({
                    data: stockData,
                    updatedAt: new Date().toISOString()
                });
                
                // Guardar historial de entradas de mercaderÃ­a
                await db.collection('config').doc('stockEntries').set({
                    data: stockEntriesData,
                    updatedAt: new Date().toISOString()
                });
                
                console.log('âœ… Datos guardados en Firebase');
            } catch (error) {
                console.error('âŒ Error guardando en Firebase:', error);
                firebaseAvailable = false;
            }
        }
        
        // Cargar datos desde Firebase
        async function loadFromFirebase() {
            console.log('â˜ï¸ Cargando datos desde Firebase...');
            isLoadingFromFirebase = true;
            
            try {
                // Cargar proveedores
                const suppliersDoc = await db.collection('config').doc('suppliers').get();
                if (suppliersDoc.exists && suppliersDoc.data().data) {
                    suppliersData = suppliersDoc.data().data;
                    console.log('âœ… Proveedores cargados desde Firebase:', suppliersData.length);
                }
                
                // Cargar productos
                const productsDoc = await db.collection('config').doc('products').get();
                if (productsDoc.exists && productsDoc.data().data) {
                    productsData = productsDoc.data().data;
                    console.log('âœ… Productos cargados desde Firebase:', productsData.length);
                }
                
                // Cargar pedidos
                const ordersDoc = await db.collection('config').doc('orders').get();
                if (ordersDoc.exists && ordersDoc.data().data) {
                    ordersData = ordersDoc.data().data;
                    console.log('âœ… Pedidos cargados desde Firebase:', ordersData.length);
                }
                
                // Cargar clientes
                const clientsDoc = await db.collection('config').doc('clients').get();
                if (clientsDoc.exists && clientsDoc.data().data) {
                    clientsData = clientsDoc.data().data;
                    console.log('âœ… Clientes cargados desde Firebase:', clientsData.length);
                }
                
                // Cargar usuarios/vendedores
                const usersDoc = await db.collection('config').doc('users').get();
                if (usersDoc.exists && usersDoc.data().data) {
                    users = usersDoc.data().data;
                    console.log('âœ… Usuarios cargados desde Firebase:', users.length);
                }
                
                // Cargar plantillas
                const templatesDoc = await db.collection('config').doc('templates').get();
                if (templatesDoc.exists && templatesDoc.data().data) {
                    columnTemplates = templatesDoc.data().data;
                    console.log('âœ… Plantillas cargadas desde Firebase');
                }
                
                // Cargar catÃ¡logos
                const catalogsDoc = await db.collection('config').doc('catalogs').get();
                if (catalogsDoc.exists && catalogsDoc.data().data) {
                    catalogFiles = catalogsDoc.data().data;
                    console.log('âœ… CatÃ¡logos cargados desde Firebase:', catalogFiles.length);
                }
                
                // Cargar datos de empresa
                const companyDoc = await db.collection('config').doc('company').get();
                if (companyDoc.exists && companyDoc.data().data) {
                    companyData = companyDoc.data().data;
                    console.log('âœ… Datos de empresa cargados desde Firebase');
                }
                
                // Cargar mÃ¡rgenes
                const marginsDoc = await db.collection('config').doc('margins').get();
                if (marginsDoc.exists && marginsDoc.data().data) {
                    marginSettingsMemory = marginsDoc.data().data;
                    console.log('âœ… MÃ¡rgenes cargados desde Firebase');
                }
                
                // Cargar publicidades/anuncios
                const announcementsDoc = await db.collection('config').doc('announcements').get();
                if (announcementsDoc.exists && announcementsDoc.data().data) {
                    announcementsData = announcementsDoc.data().data;
                    console.log('âœ… Publicidades cargadas desde Firebase:', announcementsData.length);
                }
                
                // Cargar pedidos a fÃ¡brica
                const factoryOrdersDoc = await db.collection('config').doc('factoryOrders').get();
                if (factoryOrdersDoc.exists && factoryOrdersDoc.data().data) {
                    factoryOrdersData = factoryOrdersDoc.data().data;
                    console.log('âœ… Pedidos a fÃ¡brica cargados desde Firebase:', factoryOrdersData.length);
                }
                
                // Cargar datos de stock
                const stockDoc = await db.collection('config').doc('stock').get();
                if (stockDoc.exists && stockDoc.data().data) {
                    stockData = stockDoc.data().data;
                    console.log('âœ… Stock cargado desde Firebase');
                }
                
                // Cargar historial de entradas de mercaderÃ­a
                const stockEntriesDoc = await db.collection('config').doc('stockEntries').get();
                if (stockEntriesDoc.exists && stockEntriesDoc.data().data) {
                    stockEntriesData = stockEntriesDoc.data().data;
                    console.log('âœ… Historial de entradas cargado desde Firebase:', stockEntriesData.length);
                }
                
                console.log('âœ… Todos los datos cargados desde Firebase');
                return true;
            } catch (error) {
                console.error('âŒ Error cargando desde Firebase:', error);
                firebaseAvailable = false;
                return false;
            } finally {
                isLoadingFromFirebase = false;
            }
        }

        // =============================================
        // VARIABLES GLOBALES
        // =============================================
        let currentUser = null;
        let users = [
            { username: 'admin', password: 'admin123', role: 'admin', name: 'Administrador', createdAt: new Date().toISOString() }
        ];

        let clientsData = []; // Clientes registrados
        let announcementsData = []; // Anuncios/Publicidades para clientes
        let productsData = [];
        let suppliersData = [];
        let ordersData = [];
        let factoryOrdersData = []; // Pedidos a fÃ¡brica/proveedores
        let stockData = {}; // Stock actual y mÃ­nimo por producto
        let currentFactoryOrder = { items: [], supplier: '', notes: '' }; // Pedido actual a fÃ¡brica
        let columnTemplates = {};
        let currentFileData = null;
        let currentFileHeaders = [];
        let importType = 'new';
        let editingSupplierIndex = -1;

        // Pedido actual en construcciÃ³n
        let currentOrder = {
            items: [],
            buyer: {},
            delivery: {},
            transport: {}
        };
        let selectedProductForOrder = null;

        // Carrito de cliente (para portal de clientes)
        let clientCart = [];

        // CatÃ¡logos y recursos cargados
        let catalogFiles = [];

        // Variables para paginaciÃ³n del catÃ¡logo visual
        let currentPageVisual = 1;
        const itemsPerPageVisual = 50;

        // ALMACENAMIENTO DE MÃRGENES EN MEMORIA (respaldo si localStorage no funciona)
        let marginSettingsMemory = {
            marginWholesale: 20,
            marginRetail: 35,
            commissionSales: 5,
            roundingOption: 'normal'
        };

        // Verificar si localStorage estÃ¡ disponible
        let localStorageAvailable = false;
        try {
            localStorageAvailable = typeof(localStorage) !== "undefined";
            localStorage.setItem('test', 'test');
            localStorage.removeItem('test');
            console.log('âœ… localStorage estÃ¡ disponible');
        } catch(e) {
            console.warn('âš ï¸ localStorage NO estÃ¡ disponible, usando almacenamiento en memoria');
            localStorageAvailable = false;
        }

        // Datos de la empresa (configurables)
        let companyData = {
            name: 'BRUZZONE DISTRIBUIDORA',
            slogan: 'MAYORISTA',
            address: 'Dr. Carlos Rocha 128 - Alejandro Roca, CÃ³rdoba',
            phone: '3585142098',
            email: 'bruzzonedistribuidora@gmail.com',
            logo: ''
        };

        console.log('ğŸš€ SISTEMA INICIADO');
        console.log('Arrays inicializados');

        checkLogin();

        const uploadZone = document.getElementById('uploadZone');
        uploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadZone.classList.add('dragover');
        });
        uploadZone.addEventListener('dragleave', () => uploadZone.classList.remove('dragover'));
        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
            if (e.dataTransfer.files.length > 0) processFile(e.dataTransfer.files[0]);
        });

        function checkLogin() {
            const savedUser = sessionStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                if (currentUser.role === 'client') {
                    showClientPortal();
                } else {
                    showMainSystem();
                }
            } else {
                showLoginScreen();
            }
        }

        function login() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            const errorDiv = document.getElementById('loginError');

            if (!username || !password) {
                errorDiv.textContent = 'Por favor ingresÃ¡ usuario y contraseÃ±a';
                return;
            }

            const user = users.find(u => u.username === username && u.password === password);
            if (user) {
                currentUser = user;
                sessionStorage.setItem('currentUser', JSON.stringify(user));
                errorDiv.textContent = '';
                showMainSystem();
            } else {
                errorDiv.textContent = 'âŒ Usuario o contraseÃ±a incorrectos';
            }
        }

        function logout() {
            if (confirm('Â¿EstÃ¡s seguro de cerrar sesiÃ³n?')) {
                currentUser = null;
                sessionStorage.removeItem('currentUser');
                clientCart = []; // Limpiar carrito si es cliente
                document.getElementById('mainSystem').style.display = 'none';
                document.getElementById('clientPortal').style.display = 'none';
                showLoginScreen();
            }
        }

        async function showClientPortal() {
            // Ocultar login y mainSystem, mostrar clientPortal
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainSystem').style.display = 'none';
            document.getElementById('clientPortal').style.display = 'block';
            document.getElementById('clientUsername').textContent = currentUser.name || currentUser.username;
            
            // Cargar datos desde Firebase primero
            console.log('ğŸ”„ Cargando datos para portal de cliente...');
            await loadFromFirebase();
            
            // Ahora cargar la interfaz del cliente
            loadClientData();
            loadClientCatalog();
            updateCartDisplay();
            loadClientOrders();
            loadClientBanners();
            
            // Mostrar el catÃ¡logo por defecto
            showClientTab('clientCatalog', null);
        }

        function showLoginScreen() {
            // Mostrar login, ocultar mainSystem y clientPortal
            document.getElementById('loginScreen').style.display = 'block';
            document.getElementById('mainSystem').style.display = 'none';
            document.getElementById('clientPortal').style.display = 'none';
            
            document.getElementById('loginUsername').value = '';
            document.getElementById('loginPassword').value = '';
            document.getElementById('loginError').textContent = '';
        }

        async function showMainSystem() {
            // Mostrar mainSystem, ocultar login y clientPortal
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainSystem').style.display = 'block';
            document.getElementById('clientPortal').style.display = 'none';
            
            document.getElementById('currentUsername').textContent = currentUser.name;
            document.getElementById('currentUserRole').textContent = currentUser.role === 'admin' ? 'ğŸ”‘ Administrador' : 'ğŸ‘¨â€ğŸ’¼ Vendedor';
            await loadData();
            configureInterfaceByRole();
        }

        function configureInterfaceByRole() {
            const isAdmin = currentUser.role === 'admin';
            
            document.querySelectorAll('.tab').forEach(tab => {
                const tabText = tab.textContent.toLowerCase();
                
                if (!isAdmin) {
                    // Vendedor: solo puede ver Pedidos
                    if (tabText.includes('pedidos')) {
                        tab.style.display = 'block';
                    } else {
                        tab.style.display = 'none';
                    }
                } else {
                    // Admin: puede ver todo EXCEPTO algunos tabs especÃ­ficos de vendedor
                    tab.style.display = 'block';
                }
            });

            // Iniciar en la pestaÃ±a correcta
            if (!isAdmin) {
                switchTab('orders', null);
            } else {
                switchTab('suppliers', null);
            }

            // Ajustar visibilidad de stats
            if (!isAdmin) {
                document.querySelectorAll('.stat-card').forEach((card, index) => {
                    if (index === 1 || index === 3 || index === 4) {
                        card.style.display = 'none';
                    }
                });
            } else {
                document.querySelectorAll('.stat-card').forEach(card => {
                    card.style.display = 'block';
                });
            }
        }

        async function loadData() {
            console.log('=== CARGANDO DATOS ===');
            
            // Intentar cargar desde Firebase primero
            if (firebaseAvailable) {
                const loaded = await loadFromFirebase();
                if (loaded) {
                    console.log('âœ… Datos cargados desde Firebase');
                    
                    // Actualizar interfaz
                    console.log('=== ACTUALIZANDO INTERFAZ ===');
                    updateSuppliersTable();
                    updateSupplierSelect();
                    updateStats();
                    updateCatalog();
                    updateCompanyInterface();
                    updateExportFilters();
                    
                    // Aplicar mÃ¡rgenes cargados
                    if (document.getElementById('marginWholesale')) {
                        document.getElementById('marginWholesale').value = marginSettingsMemory.marginWholesale || 20;
                        document.getElementById('marginRetail').value = marginSettingsMemory.marginRetail || 35;
                        document.getElementById('commissionSales').value = marginSettingsMemory.commissionSales || 5;
                        document.getElementById('roundingOption').value = marginSettingsMemory.roundingOption || 'normal';
                    }
                    
                    updateSellersTable();
                    updateClientsTable();
                    updateBannersDisplay();
                    
                    try {
                        updateOrdersTable();
                    } catch(e) {
                        console.warn('âš ï¸ Error en updateOrdersTable:', e);
                    }
                    
                    updateTemplatesList();
                    updateCatalogFilesList();
                    updateCatalogProductSelect();
                    
                    console.log('=== CARGA COMPLETA ===');
                    return;
                }
            }
            
            // Si Firebase falla, cargar desde localStorage (respaldo)
            console.log('âš ï¸ Usando localStorage como respaldo...');
            
            const saved = {
                suppliers: localStorage.getItem('suppliersData'),
                products: localStorage.getItem('productsData'),
                orders: localStorage.getItem('ordersData'),
                clients: localStorage.getItem('clientsData'),
                templates: localStorage.getItem('columnTemplates'),
                catalogs: localStorage.getItem('catalogFiles')
            };

            console.log('Datos en localStorage:');
            console.log('- Proveedores:', saved.suppliers ? 'SÃ' : 'NO');
            console.log('- Productos:', saved.products ? 'SÃ' : 'NO');
            console.log('- Pedidos:', saved.orders ? 'SÃ' : 'NO');
            console.log('- Clientes:', saved.clients ? 'SÃ' : 'NO');
            console.log('- Plantillas:', saved.templates ? 'SÃ' : 'NO');
            console.log('- CatÃ¡logos:', saved.catalogs ? 'SÃ' : 'NO');

            if (saved.suppliers) {
                try {
                    suppliersData = JSON.parse(saved.suppliers);
                    console.log('âœ… Proveedores cargados:', suppliersData.length);
                    console.log('Datos:', suppliersData);
                } catch (e) {
                    console.error('âŒ Error cargando proveedores:', e);
                    suppliersData = [];
                }
            } else {
                console.log('âš ï¸ No hay proveedores en localStorage');
                suppliersData = [];
            }

            if (saved.products) {
                try {
                    productsData = JSON.parse(saved.products);
                    console.log('âœ… Productos cargados:', productsData.length);
                } catch (e) {
                    console.error('âŒ Error cargando productos:', e);
                    productsData = [];
                }
            } else {
                productsData = [];
            }

            if (saved.orders) {
                try {
                    ordersData = JSON.parse(saved.orders);
                    console.log('âœ… Pedidos cargados:', ordersData.length);
                } catch (e) {
                    console.error('âŒ Error cargando pedidos:', e);
                    ordersData = [];
                }
            } else {
                ordersData = [];
            }

            if (saved.clients) {
                try {
                    clientsData = JSON.parse(saved.clients);
                    console.log('âœ… Clientes cargados:', clientsData.length);
                } catch (e) {
                    console.error('âŒ Error cargando clientes:', e);
                    clientsData = [];
                }
            } else {
                clientsData = [];
            }

            if (saved.templates) {
                try {
                    columnTemplates = JSON.parse(saved.templates);
                    console.log('âœ… Plantillas cargadas:', Object.keys(columnTemplates).length);
                } catch (e) {
                    console.error('âŒ Error cargando plantillas:', e);
                    columnTemplates = {};
                }
            } else {
                columnTemplates = {};
            }

            if (saved.catalogs) {
                try {
                    catalogFiles = JSON.parse(saved.catalogs);
                    console.log('âœ… CatÃ¡logos cargados:', catalogFiles.length);
                } catch (e) {
                    console.error('âŒ Error cargando catÃ¡logos:', e);
                    catalogFiles = [];
                }
            } else {
                catalogFiles = [];
            }

            console.log('=== ACTUALIZANDO INTERFAZ ===');
            updateSuppliersTable();
            updateSupplierSelect();
            updateStats();
            updateCatalog();
            loadCompanyData();
	    updateExportFilters();
            
            // CARGAR MÃRGENES Y CONFIGURACIONES ANTES DE CUALQUIER COSA
            loadMargins();
            
            loadUsers();
            updateClientsTable();
            
            try {
                updateOrdersTable();
            } catch(e) {
                console.warn('âš ï¸ Error en updateOrdersTable:', e);
            }
            
            updateTemplatesList();
            
            // ACTUALIZAR INTERFAZ DE CATÃLOGOS
            updateCatalogFilesList();
            updateCatalogProductSelect();
            
            console.log('=== CARGA COMPLETA ===');
        }

        function saveData() {
            console.log('=== GUARDANDO DATOS ===');
            console.log('Proveedores a guardar:', suppliersData.length);
            console.log('Productos a guardar:', productsData.length);
            console.log('Pedidos a guardar:', ordersData.length);
            console.log('Clientes a guardar:', clientsData.length);
            
            try {
                // Guardar en localStorage como respaldo
                localStorage.setItem('suppliersData', JSON.stringify(suppliersData));
                console.log('âœ… Proveedores guardados en localStorage');
                
                localStorage.setItem('productsData', JSON.stringify(productsData));
                console.log('âœ… Productos guardados en localStorage');
                
                localStorage.setItem('ordersData', JSON.stringify(ordersData));
                console.log('âœ… Pedidos guardados en localStorage');
                
                localStorage.setItem('clientsData', JSON.stringify(clientsData));
                console.log('âœ… Clientes guardados en localStorage');
                
                localStorage.setItem('columnTemplates', JSON.stringify(columnTemplates));
                console.log('âœ… Plantillas guardadas en localStorage');
                
                localStorage.setItem('catalogFiles', JSON.stringify(catalogFiles));
                console.log('âœ… CatÃ¡logos guardados en localStorage');
                
                // GUARDAR MÃRGENES Y CONFIGURACIONES
                saveMargins();
                
                // GUARDAR EN FIREBASE (la nube)
                saveToFirebase();
                
                console.log('=== GUARDADO COMPLETO ===');
                
            } catch (e) {
                console.error('âŒ ERROR AL GUARDAR:', e);
                alert('Error al guardar datos: ' + e.message);
            }
        }

        function saveMargins() {
            try {
                const margins = {
                    marginWholesale: document.getElementById('marginWholesale').value,
                    marginRetail: document.getElementById('marginRetail').value,
                    commissionSales: document.getElementById('commissionSales').value,
                    roundingOption: document.getElementById('roundingOption').value
                };

                // Guardar en memoria siempre
                marginSettingsMemory = JSON.parse(JSON.stringify(margins));
                console.log('ğŸ’¾ MÃ¡rgenes guardados en memoria:', margins);

                // Intentar guardar en localStorage si estÃ¡ disponible
                if (localStorageAvailable) {
                    try {
                        localStorage.setItem('marginSettings', JSON.stringify(margins));
                        console.log('âœ… MÃ¡rgenes guardados en localStorage');
                    } catch(e) {
                        console.warn('âš ï¸ No se pudo guardar en localStorage:', e);
                    }
                }
                
                // Guardar en Firebase
                saveToFirebase();
                
            } catch(e) {
                console.error('âŒ Error guardando mÃ¡rgenes:', e);
            }
        }

        function loadMargins() {
            try {
                let margins = null;

                // Primero intentar localStorage
                if (localStorageAvailable) {
                    try {
                        const saved = localStorage.getItem('marginSettings');
                        if (saved) {
                            margins = JSON.parse(saved);
                            console.log('âœ… MÃ¡rgenes cargados desde localStorage:', margins);
                        }
                    } catch(e) {
                        console.warn('âš ï¸ Error leyendo localStorage:', e);
                    }
                }

                // Si no hay en localStorage, usar memoria
                if (!margins) {
                    margins = marginSettingsMemory;
                    console.log('ğŸ’¾ MÃ¡rgenes cargados desde memoria:', margins);
                }

                // SINCRONIZAR MEMORIA CON LO CARGADO
                marginSettingsMemory = JSON.parse(JSON.stringify(margins));

                // Aplicar mÃ¡rgenes a los inputs
                if (document.getElementById('marginWholesale')) {
                    document.getElementById('marginWholesale').value = margins.marginWholesale || 20;
                    console.log('âœ… marginWholesale cargado:', margins.marginWholesale);
                }
                if (document.getElementById('marginRetail')) {
                    document.getElementById('marginRetail').value = margins.marginRetail || 35;
                    console.log('âœ… marginRetail cargado:', margins.marginRetail);
                }
                if (document.getElementById('commissionSales')) {
                    document.getElementById('commissionSales').value = margins.commissionSales || 5;
                    console.log('âœ… commissionSales cargado:', margins.commissionSales);
                }
                if (document.getElementById('roundingOption')) {
                    document.getElementById('roundingOption').value = margins.roundingOption || 'normal';
                    console.log('âœ… roundingOption cargado:', margins.roundingOption);
                }

                console.log('âœ… MÃ¡rgenes aplicados a la interfaz:', marginSettingsMemory);
            } catch(e) {
                console.error('âŒ Error cargando mÃ¡rgenes:', e);
            }
        }

        // ========================================
        // FUNCIONES DE CATÃLOGOS Y RECURSOS
        // ========================================

        function uploadCatalogFile() {
            const fileInput = document.getElementById('catalogFileInput');
            const file = fileInput.files[0];

            if (!file) {
                alert('âš ï¸ Selecciona un archivo primero');
                return;
            }

            // Validar formato
            const validFormats = ['image/jpeg', 'image/png', 'image/gif', 'application/pdf'];
            if (!validFormats.includes(file.type)) {
                alert('âŒ Formato no soportado. Usa JPG, PNG, GIF o PDF');
                return;
            }

            // Validar tamaÃ±o (mÃ¡x 5MB)
            const maxSize = 5 * 1024 * 1024; // 5MB en bytes
            if (file.size > maxSize) {
                alert('âŒ El archivo es demasiado grande. MÃ¡ximo 5MB');
                return;
            }

            // Mostrar que se estÃ¡ cargando
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = 'â³ Cargando...';
            btn.disabled = true;

            const reader = new FileReader();
            
            reader.onerror = () => {
                alert('âŒ Error al leer el archivo');
                btn.innerHTML = originalText;
                btn.disabled = false;
            };

            reader.onload = (e) => {
                try {
                    const base64Data = e.target.result;
                    const resourceName = document.getElementById('catalogResourceName').value.trim() || file.name;
                    const productCode = document.getElementById('catalogProductSelect').value;

                    const catalogFile = {
                        id: Date.now(),
                        name: resourceName,
                        originalFileName: file.name,
                        type: file.type,
                        size: file.size,
                        data: base64Data,
                        productCode: productCode || null,
                        createdAt: new Date().toISOString()
                    };

                    catalogFiles.push(catalogFile);
                    console.log('âœ… Archivo cargado:', catalogFile.name);

                    // Limpiar inputs
                    fileInput.value = '';
                    document.getElementById('catalogResourceName').value = '';
                    document.getElementById('catalogProductSelect').value = '';

                    // Actualizar tabla
                    updateCatalogFilesList();
                    saveData();

                    alert(`âœ… Archivo "${resourceName}" cargado correctamente\n\nTamaÃ±o: ${(file.size / 1024).toFixed(2)} KB`);
                } catch(err) {
                    alert('âŒ Error al procesar el archivo: ' + err.message);
                } finally {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            };

            reader.readAsDataURL(file);
        }

        function updateCatalogFilesList() {
            const tbody = document.getElementById('catalogFilesBody');

            if (catalogFiles.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="padding: 30px; text-align: center; color: #999;">No hay archivos cargados todavÃ­a</td></tr>';
                return;
            }

            tbody.innerHTML = catalogFiles.map((file, index) => {
                const fileType = file.type.includes('pdf') ? 'ğŸ“„ PDF' : 'ğŸ–¼ï¸ Imagen';
                const fileSize = (file.size / 1024).toFixed(2) + ' KB';
                const productName = file.productCode ? `CÃ³digo: ${file.productCode}` : 'General';

                return `
                    <tr style="border-bottom: 1px solid #e0e0e0;">
                        <td style="padding: 12px; border-right: 1px solid #e0e0e0;">
                            <strong>${file.name}</strong><br>
                            <small style="color: #999;">${fileSize}</small>
                        </td>
                        <td style="padding: 12px; border-right: 1px solid #e0e0e0;">${fileType}</td>
                        <td style="padding: 12px; border-right: 1px solid #e0e0e0;">
                            <small>${productName}</small>
                        </td>
                        <td style="padding: 12px;">
                            <button class="btn btn-primary btn-small" onclick="copyCatalogLink(${index})" title="Copiar link">ğŸ“‹</button>
                            <button class="btn btn-danger btn-small" onclick="deleteCatalogFile(${index})" title="Eliminar">ğŸ—‘ï¸</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function copyCatalogLink(index) {
            const file = catalogFiles[index];
            if (!file) return;

            // Crear un link con el ID del archivo
            const link = `${window.location.href.split('?')[0]}?catalog=${file.id}`;
            
            navigator.clipboard.writeText(link).then(() => {
                alert(`âœ… Link copiado al portapapeles:\n\n${link}`);
            }).catch(() => {
                alert(`Link:\n\n${link}\n\n(Copia manualmente desde aquÃ­)`);
            });
        }

        function deleteCatalogFile(index) {
            if (!confirm('Â¿Eliminar este archivo? No se puede deshacer.')) {
                return;
            }

            const fileName = catalogFiles[index].name;
            catalogFiles.splice(index, 1);
            updateCatalogFilesList();
            saveData();
            alert(`âœ… Archivo "${fileName}" eliminado`);
        }

        function getCatalogFilesForProduct(productCode) {
            return catalogFiles.filter(f => !f.productCode || f.productCode === productCode);
        }

        function updateCatalogProductSelect() {
            const select = document.getElementById('catalogProductSelect');
            select.innerHTML = '<option value="">-- Sin asociar (CatÃ¡logo general) --</option>';
            
            productsData.forEach(product => {
                const option = document.createElement('option');
                option.value = product.code;
                option.textContent = `${product.code} - ${product.description}`;
                select.appendChild(option);
            });
        }

        function getUnitPrice(product) {
            // Obtener cantidad por bulto
            const bulkQuantityNames = [
                'Cantidad por Bulto', 'cantidad por bulto', 'Cant por Bulto', 'cant por bulto',
                'Bulto', 'bulto', 'Cantidad', 'cantidad', 'CantBulto', 'Cant Bulto',
                'Unid x Bulto', 'unid x bulto', 'Unidades por Bulto', 'unidades por bulto',
                'cantidadBulto'
            ];

            let bulkQuantity = 1;
            for (let nombre of bulkQuantityNames) {
                if (product[nombre] !== undefined && product[nombre] !== '' && product[nombre] !== null) {
                    bulkQuantity = parseInt(product[nombre]) || 1;
                    break;
                }
            }

            // Obtener precio de compra (con descuentos aplicados)
            const purchasePrice = parseFloat(product.purchasePrice) || parseFloat(product.basePrice) || 0;
            
            // Retornar precio por unidad (dividido por cantidad de bulto)
            const unitPrice = purchasePrice / bulkQuantity;
            return isNaN(unitPrice) ? 0 : unitPrice;
        }

        function addSupplier() {
            console.log('=== AGREGANDO PROVEEDOR ===');
            
            const name = document.getElementById('newSupplierName').value.trim();
            const brandsInput = document.getElementById('newSupplierBrands').value.trim();
            const discount1 = parseFloat(document.getElementById('newSupplierDiscount1').value) || 0;
            const discount2 = parseFloat(document.getElementById('newSupplierDiscount2').value) || 0;
            const discount3 = parseFloat(document.getElementById('newSupplierDiscount3').value) || 0;
            const iva = parseFloat(document.getElementById('newSupplierIVA').value);

            console.log('Nombre:', name);
            console.log('Marcas input:', brandsInput);

            if (!name) {
                alert('Por favor ingresÃ¡ el nombre del proveedor');
                return;
            }

            if (!brandsInput) {
                alert('Por favor ingresÃ¡ al menos una marca');
                return;
            }

            if (suppliersData.find(s => s.name === name)) {
                alert('Este proveedor ya existe');
                return;
            }

            const brands = brandsInput.split(',').map(b => b.trim()).filter(b => b);
            console.log('Marcas procesadas:', brands);
            
            const newSupplier = {
                name: name,
                brands: brands,
                discount1: discount1,
                discount2: discount2,
                discount3: discount3,
                iva: iva
            };

            console.log('Nuevo proveedor:', newSupplier);
            suppliersData.push(newSupplier);
            console.log('Total proveedores despuÃ©s de agregar:', suppliersData.length);
            console.log('Array completo:', suppliersData);

            // Limpiar formulario
            document.getElementById('newSupplierName').value = '';
            document.getElementById('newSupplierBrands').value = '';
            document.getElementById('newSupplierDiscount1').value = '0';
            document.getElementById('newSupplierDiscount2').value = '0';
            document.getElementById('newSupplierDiscount3').value = '0';
            document.getElementById('newSupplierIVA').value = '21';

            // Guardar y actualizar
            console.log('Guardando datos...');
            saveData();
            
            console.log('Actualizando tabla...');
            updateSuppliersTable();
            
            console.log('Actualizando select...');
            updateSupplierSelect();
            
            console.log('âœ… PROVEEDOR AGREGADO EXITOSAMENTE');
            alert(`âœ… Proveedor "${name}" agregado exitosamente\n\nMarcas: ${brands.join(', ')}`);
        }

        function editSupplier(index) {
            console.log('=== EDITANDO PROVEEDOR ===');
            console.log('Index:', index);
            console.log('Proveedor:', suppliersData[index]);
            
            editingSupplierIndex = index;
            const supplier = suppliersData[index];
            
            if (!supplier) {
                console.error('âŒ Proveedor no encontrado en index:', index);
                alert('Error: Proveedor no encontrado');
                return;
            }
            
            document.getElementById('editSupplierName').textContent = supplier.name || 'Sin nombre';
            document.getElementById('editSupplierNameInput').value = supplier.name || '';
            
            // Manejar brands de forma segura
            let brandsText = '';
            if (supplier.brands && Array.isArray(supplier.brands) && supplier.brands.length > 0) {
                brandsText = supplier.brands.join(', ');
            }
            document.getElementById('editSupplierBrands').value = brandsText;
            
            document.getElementById('editSupplierDiscount1').value = supplier.discount1 || 0;
            document.getElementById('editSupplierDiscount2').value = supplier.discount2 || 0;
            document.getElementById('editSupplierDiscount3').value = supplier.discount3 || 0;
            document.getElementById('editSupplierIVA').value = supplier.iva || 21;
            
            document.getElementById('editSupplierSection').classList.add('active');
            
            document.getElementById('editSupplierSection').scrollIntoView({ behavior: 'smooth', block: 'start' });
            
            console.log('âœ… Formulario de ediciÃ³n cargado');
        }

        function saveSupplierEdit() {
            if (editingSupplierIndex === -1) {
                alert('Error: No hay proveedor en ediciÃ³n');
                return;
            }

            console.log('=== GUARDANDO EDICIÃ“N DE PROVEEDOR ===');
            console.log('Index editando:', editingSupplierIndex);

            const oldName = suppliersData[editingSupplierIndex].name;
            const newName = document.getElementById('editSupplierNameInput').value.trim();
            const brandsInput = document.getElementById('editSupplierBrands').value.trim();
            const discount1 = parseFloat(document.getElementById('editSupplierDiscount1').value) || 0;
            const discount2 = parseFloat(document.getElementById('editSupplierDiscount2').value) || 0;
            const discount3 = parseFloat(document.getElementById('editSupplierDiscount3').value) || 0;
            const iva = parseFloat(document.getElementById('editSupplierIVA').value) || 21;

            if (!newName) {
                alert('El nombre del proveedor no puede estar vacÃ­o');
                return;
            }

            if (!brandsInput) {
                alert('Por favor ingresÃ¡ al menos una marca');
                return;
            }

            // Verificar si el nombre ya existe (excepto el actual)
            const nameExists = suppliersData.some((s, idx) => 
                s.name === newName && idx !== editingSupplierIndex
            );
            
            if (nameExists) {
                alert('Ya existe un proveedor con ese nombre');
                return;
            }

            const brands = brandsInput.split(',').map(b => b.trim()).filter(b => b.length > 0);

            console.log('Actualizando proveedor:');
            console.log('- Nombre anterior:', oldName);
            console.log('- Nombre nuevo:', newName);
            console.log('- Marcas:', brands);

            suppliersData[editingSupplierIndex] = {
                name: newName,
                brands: brands,
                discount1: discount1,
                discount2: discount2,
                discount3: discount3,
                iva: iva
            };

            // Si cambiÃ³ el nombre, actualizar referencias
            if (newName !== oldName) {
                console.log('Nombre cambiÃ³, actualizando productos y plantillas...');
                
                productsData.forEach(product => {
                    if (product.supplier === oldName) {
                        product.supplier = newName;
                    }
                });

                if (columnTemplates[oldName]) {
                    columnTemplates[newName] = columnTemplates[oldName];
                    delete columnTemplates[oldName];
                }
            }

            saveData();
            updateSuppliersTable();
            updateSupplierSelect();
            updateCatalog();
            cancelEditSupplier();
            
            console.log('âœ… Proveedor actualizado exitosamente');
            alert(`âœ… Proveedor actualizado correctamente\n\nNombre: ${newName}\nMarcas: ${brands.join(', ')}`);
        }

        function cancelEditSupplier() {
            editingSupplierIndex = -1;
            document.getElementById('editSupplierSection').classList.remove('active');
        }

        function deleteSupplier(index) {
            console.log('=== ELIMINANDO PROVEEDOR ===');
            console.log('Index:', index);
            
            if (index < 0 || index >= suppliersData.length) {
                console.error('âŒ Index invÃ¡lido:', index);
                alert('Error: Proveedor no encontrado');
                return;
            }
            
            const supplier = suppliersData[index];
            const supplierName = supplier.name;
            
            if (!confirm(`Â¿Eliminar "${supplierName}"?\n\nEsto eliminarÃ¡:\n- El proveedor\n- Todos sus productos\n- Su plantilla de columnas`)) {
                return;
            }

            console.log('Eliminando:', supplierName);

            // Eliminar proveedor
            suppliersData.splice(index, 1);
            console.log('Proveedores restantes:', suppliersData.length);
            
            // Eliminar productos del proveedor
            const productsBeforeDelete = productsData.length;
            productsData = productsData.filter(p => p.supplier !== supplierName);
            console.log('Productos eliminados:', productsBeforeDelete - productsData.length);
            
            // Eliminar plantilla
            if (columnTemplates[supplierName]) {
                delete columnTemplates[supplierName];
                console.log('Plantilla eliminada');
            }

            saveData();
            updateSuppliersTable();
            updateSupplierSelect();
            updateStats();
            updateCatalog();
            
            console.log('âœ… Proveedor eliminado exitosamente');
            alert(`âœ… Proveedor "${supplierName}" eliminado correctamente`);
        }

        function updateSuppliersTable() {
            const tbody = document.getElementById('suppliersTableBody');
            
            console.log('=== ACTUALIZANDO TABLA ===');
            console.log('Total proveedores:', suppliersData.length);
            console.log('Datos:', suppliersData);
            
            if (!suppliersData || suppliersData.length === 0) {
                console.log('No hay proveedores, mostrando mensaje vacÃ­o');
                tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 40px; color: #999;">No hay proveedores cargados. AgregÃ¡ uno usando el formulario de arriba.</td></tr>';
                return;
            }

            try {
                const rows = [];
                for (let index = 0; index < suppliersData.length; index++) {
                    const supplier = suppliersData[index];
                    console.log(`Procesando proveedor ${index}:`, supplier);
                    
                    const productCount = productsData.filter(p => p.supplier === supplier.name).length;
                    const hasTemplate = columnTemplates[supplier.name] ? 'âœ… Guardada' : 'âŒ Sin plantilla';
                    const templateColor = columnTemplates[supplier.name] ? '#4caf50' : '#999';
                    
                    let brandsDisplay = '<span style="color: #999;">Sin marcas</span>';
                    if (supplier.brands && Array.isArray(supplier.brands) && supplier.brands.length > 0) {
                        brandsDisplay = supplier.brands.map(b => `<span class="brand-badge">${b}</span>`).join('');
                    }
                    
                    rows.push(`
                        <tr>
                            <td><strong>${supplier.name}</strong></td>
                            <td>${brandsDisplay}</td>
                            <td>${supplier.discount1 || 0}%</td>
                            <td>${supplier.discount2 || 0}%</td>
                            <td>${supplier.discount3 || 0}%</td>
                            <td>${supplier.iva || 21}%</td>
                            <td><span class="supplier-badge">${productCount} productos</span></td>
                            <td><span style="color: ${templateColor}; font-weight: 600;">${hasTemplate}</span></td>
                            <td>
                                <button class="btn btn-warning btn-small" onclick="editSupplier(${index})">âœï¸</button>
                                <button class="btn btn-danger btn-small" onclick="deleteSupplier(${index})">ğŸ—‘ï¸</button>
                            </td>
                        </tr>
                    `);
                }
                
                tbody.innerHTML = rows.join('');
                console.log('âœ… Tabla actualizada con', rows.length, 'filas');
            } catch (error) {
                console.error('âŒ ERROR al actualizar tabla:', error);
                tbody.innerHTML = `<tr><td colspan="9" style="text-align: center; padding: 40px; color: #f44336;">Error: ${error.message}</td></tr>`;
            }
        }

        function updateSupplierSelect() {
            const select = document.getElementById('selectSupplier');
            select.innerHTML = '<option value="">-- Seleccionar proveedor --</option>';
            suppliersData.forEach(supplier => {
                const hasTemplate = columnTemplates[supplier.name] ? ' â­' : '';
                select.innerHTML += `<option value="${supplier.name}">${supplier.name}${hasTemplate}</option>`;
            });
            
            // TambiÃ©n actualizar el select de actualizaciÃ³n de precios
            initPriceUpdateSupplierSelect();
        }

        function updateImportMode() {
            const supplierName = document.getElementById('selectSupplier').value;
            const supplierBrandsInfo = document.getElementById('supplierBrandsInfo');
            const currentSupplierBrands = document.getElementById('currentSupplierBrands');
            
            if (supplierName) {
                const supplier = suppliersData.find(s => s.name === supplierName);
                
                if (supplier && supplier.brands) {
                    supplierBrandsInfo.style.display = 'block';
                    currentSupplierBrands.innerHTML = supplier.brands.map(b => 
                        `<span class="brand-badge">${b}</span>`
                    ).join('');
                }

                if (columnTemplates[supplierName]) {
                    loadColumnTemplate();
                }
            } else {
                supplierBrandsInfo.style.display = 'none';
            }
        }

        function letterToIndex(letter) {
            letter = letter.toUpperCase();
            let index = 0;
            for (let i = 0; i < letter.length; i++) {
                index = index * 26 + (letter.charCodeAt(i) - 64);
            }
            return index - 1;
        }

        function indexToLetter(index) {
            let letter = '';
            index = index + 1;
            while (index > 0) {
                let remainder = (index - 1) % 26;
                letter = String.fromCharCode(65 + remainder) + letter;
                index = Math.floor((index - 1) / 26);
            }
            return letter;
        }

        function showColumnPreview() {
            const previewContainer = document.getElementById('columnPreview');
            
            console.log('=== MOSTRANDO VISTA PREVIA DE COLUMNAS ===');
            console.log('Headers:', currentFileHeaders);
            
            if (!currentFileHeaders || currentFileHeaders.length === 0) {
                previewContainer.innerHTML = '<p style="color: #999;">No hay columnas disponibles</p>';
                return;
            }
            
            // Crear inputs editables para cada columna
            const columnHTML = currentFileHeaders.map((header, index) => {
                const letter = indexToLetter(index);
                const columnId = `columnName_${index}`;
                
                return `
                    <div style="display: grid; grid-template-columns: 60px 1fr; gap: 10px; align-items: center; background: white; padding: 10px; border-radius: 5px; border: 2px solid #e0e0e0;">
                        <div style="text-align: center;">
                            <strong style="color: #667eea; font-size: 1.2em;">${letter}</strong>
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 5px;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span style="color: #999; font-size: 0.85em; min-width: 100px;">Original:</span>
                                <span style="color: #333; font-weight: 600;">${header}</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span style="color: #667eea; font-size: 0.85em; min-width: 100px;">Mostrar como:</span>
                                <input 
                                    type="text" 
                                    id="${columnId}" 
                                    value="${header}" 
                                    placeholder="DejÃ¡ vacÃ­o para no importar"
                                    style="flex: 1; padding: 8px; border: 2px solid #e0e0e0; border-radius: 5px; font-size: 0.9em;"
                                    onchange="validateColumnNames()"
                                >
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            previewContainer.innerHTML = columnHTML;
            console.log('âœ… Vista previa de columnas renderizada');
        }

        function validateColumnNames() {
            // Validar que no haya nombres duplicados (ignorando vacÃ­os)
            const names = [];
            let hasDuplicates = false;
            
            currentFileHeaders.forEach((header, index) => {
                const input = document.getElementById(`columnName_${index}`);
                if (!input) return;
                
                const value = input.value.trim();
                
                if (value) {
                    if (names.includes(value)) {
                        hasDuplicates = true;
                        input.style.borderColor = '#f44336';
                        input.style.background = '#ffebee';
                    } else {
                        input.style.borderColor = '#4caf50';
                        input.style.background = '#f1f8f4';
                        names.push(value);
                    }
                } else {
                    input.style.borderColor = '#ff9800';
                    input.style.background = '#fff8e1';
                }
            });
            
            if (hasDuplicates) {
                console.warn('âš ï¸ Hay nombres de columnas duplicados');
            }
        }

        function resetColumnNames() {
            if (!confirm('Â¿Restaurar los nombres originales de todas las columnas?')) return;
            
            currentFileHeaders.forEach((header, index) => {
                const input = document.getElementById(`columnName_${index}`);
                if (input) {
                    input.value = header;
                    input.style.borderColor = '#e0e0e0';
                    input.style.background = 'white';
                }
            });
            
            console.log('âœ… Nombres de columnas restaurados');
        }

        function clearAllColumnNames() {
            if (!confirm('Â¿Limpiar TODOS los nombres de columnas? (Ãºtil si querÃ©s elegir solo algunas)')) return;
            
            currentFileHeaders.forEach((header, index) => {
                const input = document.getElementById(`columnName_${index}`);
                if (input) {
                    input.value = '';
                    input.style.borderColor = '#ff9800';
                    input.style.background = '#fff8e1';
                }
            });
            
            console.log('âœ… Nombres de columnas limpiados');
        }

        function getActiveColumns() {
            // Devuelve un objeto con las columnas que tienen nombre asignado
            const activeColumns = {};
            
            currentFileHeaders.forEach((header, index) => {
                const input = document.getElementById(`columnName_${index}`);
                const customName = input ? input.value.trim() : header;
                
                if (customName) {
                    activeColumns[index] = customName;
                }
            });
            
            console.log('Columnas activas:', activeColumns);
            return activeColumns;
        }

        function updateColumnPreviews() {
            ['Code', 'Description', 'Price', 'Bulk', 'Extra'].forEach(field => {
                const input = document.getElementById(`column${field}Letter`);
                const preview = document.getElementById(`preview${field}`);
                
                if (!input || !preview) return;
                
                const letter = input.value.trim().toUpperCase();
                
                if (letter && currentFileHeaders) {
                    const index = letterToIndex(letter);
                    if (index >= 0 && index < currentFileHeaders.length) {
                        const headerValue = currentFileHeaders[index];
                        preview.textContent = `âœ“ Columna encontrada: "${headerValue}"`;
                        preview.style.color = '#4caf50';
                        input.style.borderColor = '#4caf50';
                    } else {
                        preview.textContent = 'âš ï¸ Columna no encontrada en el archivo';
                        preview.style.color = '#f44336';
                        input.style.borderColor = '#f44336';
                    }
                } else {
                    preview.textContent = letter === '' ? 'Sin configurar (opcional para Bulk y Extra)' : '';
                    input.style.borderColor = field === 'Bulk' || field === 'Extra' ? '#ff9800' : '#667eea';
                }
            });
        }

        function setupColumnInputs() {
            ['Code', 'Description', 'Price', 'Bulk', 'Extra'].forEach(field => {
                const input = document.getElementById(`column${field}Letter`);
                if (input) {
                    input.addEventListener('input', updateColumnPreviews);
                    input.addEventListener('blur', updateColumnPreviews);
                }
            });
            
            // TambiÃ©n listener para el nombre de la columna extra
            const extraNameInput = document.getElementById('columnExtraName');
            if (extraNameInput) {
                extraNameInput.addEventListener('input', updateColumnPreviews);
            }
        }

        function saveColumnTemplate() {
            const supplierName = document.getElementById('selectSupplier').value;
            
            if (!supplierName) {
                alert('âš ï¸ SeleccionÃ¡ un proveedor primero');
                return;
            }

            const template = {
                code: document.getElementById('columnCodeLetter').value.trim().toUpperCase(),
                description: document.getElementById('columnDescriptionLetter').value.trim().toUpperCase(),
                price: document.getElementById('columnPriceLetter').value.trim().toUpperCase()
            };

            if (!template.code || !template.description || !template.price) {
                alert('âš ï¸ CompletÃ¡ todas las columnas');
                return;
            }

            columnTemplates[supplierName] = template;
            saveData();
            updateSuppliersTable();
            
            alert(`âœ… Plantilla guardada para "${supplierName}"`);
        }

        function saveColumnTemplateWithName() {
            const templateName = document.getElementById('templateName').value.trim();
            
            if (!templateName) {
                alert('âš ï¸ IngresÃ¡ un nombre para la plantilla');
                return;
            }

            const template = {
                name: templateName,
                code: document.getElementById('columnCodeLetter').value.trim().toUpperCase(),
                description: document.getElementById('columnDescriptionLetter').value.trim().toUpperCase(),
                price: document.getElementById('columnPriceLetter').value.trim().toUpperCase(),
                bulk: document.getElementById('columnBulkLetter').value.trim().toUpperCase(),
                extra: document.getElementById('columnExtraLetter').value.trim().toUpperCase(),
                extraName: document.getElementById('columnExtraName').value.trim(),
                createdAt: new Date().toISOString()
            };

            if (!template.code || !template.description || !template.price) {
                alert('âš ï¸ CompletÃ¡ todas las columnas obligatorias (CÃ³digo, DescripciÃ³n y Precio)');
                return;
            }

            // Guardar plantilla con nombre Ãºnico
            columnTemplates[templateName] = template;
            saveData();
            
            // Limpiar input de nombre
            document.getElementById('templateName').value = '';
            
            // Actualizar lista de plantillas
            updateTemplatesList();
            
            alert(`âœ… Plantilla "${templateName}" guardada correctamente`);
            
            console.log('ğŸ’¾ Plantilla guardada:', template);
        }

        function updateTemplatesList() {
            const templatesListSection = document.getElementById('templatesListSection');
            const templatesList = document.getElementById('templatesList');
            
            const templates = Object.keys(columnTemplates);
            
            if (templates.length === 0) {
                templatesListSection.style.display = 'none';
                return;
            }

            templatesListSection.style.display = 'block';
            
            templatesList.innerHTML = templates.map(name => {
                const template = columnTemplates[name];
                const date = template.createdAt ? new Date(template.createdAt).toLocaleDateString('es-AR') : 'N/A';
                
                // Construir texto de columnas
                let columnsText = `CÃ³digo: <code>${template.code}</code> â€¢ 
                                   DescripciÃ³n: <code>${template.description}</code> â€¢ 
                                   Precio: <code>${template.price}</code>`;
                
                if (template.bulk) {
                    columnsText += ` â€¢ Cant. Bulto: <code>${template.bulk}</code>`;
                }
                
                if (template.extra) {
                    const extraLabel = template.extraName || 'Extra';
                    columnsText += ` â€¢ ${extraLabel}: <code>${template.extra}</code>`;
                }
                
                return `
                    <div style="background: white; padding: 15px; border-radius: 8px; border: 2px solid #e0e0e0; display: grid; grid-template-columns: 1fr auto; gap: 15px; align-items: center;">
                        <div>
                            <div style="font-weight: 600; color: #667eea; margin-bottom: 5px;">
                                ğŸ“‹ ${name}
                            </div>
                            <div style="font-size: 0.85em; color: #666;">
                                ${columnsText}
                            </div>
                            <div style="font-size: 0.75em; color: #999; margin-top: 3px;">
                                Guardada: ${date}
                            </div>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-primary btn-small" onclick="loadTemplateByName('${name.replace(/'/g, "\\'")}')">
                                ğŸ“¥ Cargar
                            </button>
                            <button class="btn btn-danger btn-small" onclick="deleteTemplate('${name.replace(/'/g, "\\'")}')">
                                ğŸ—‘ï¸
                            </button>
                        </div>
                    </div>
                `;
            }).join('');

            console.log(`ğŸ“‹ ${templates.length} plantillas en la lista`);
        }

        function loadTemplateByName(templateName) {
            const template = columnTemplates[templateName];
            
            if (!template) {
                alert(`âš ï¸ No se encontrÃ³ la plantilla "${templateName}"`);
                return;
            }

            document.getElementById('columnCodeLetter').value = template.code || '';
            document.getElementById('columnDescriptionLetter').value = template.description || '';
            document.getElementById('columnPriceLetter').value = template.price || '';
            document.getElementById('columnBulkLetter').value = template.bulk || '';
            document.getElementById('columnExtraLetter').value = template.extra || '';
            document.getElementById('columnExtraName').value = template.extraName || '';

            updateColumnPreviews();
            
            alert(`âœ… Plantilla "${templateName}" cargada correctamente`);
            
            console.log('ğŸ“¥ Plantilla cargada:', templateName);
        }

        function deleteTemplate(templateName) {
            if (!confirm(`Â¿Eliminar la plantilla "${templateName}"?\n\nEsta acciÃ³n no se puede deshacer.`)) {
                return;
            }

            delete columnTemplates[templateName];
            saveData();
            updateTemplatesList();
            
            alert(`âœ… Plantilla "${templateName}" eliminada`);
            
            console.log('ğŸ—‘ï¸ Plantilla eliminada:', templateName);
        }

        function loadColumnTemplate() {
            const supplierName = document.getElementById('selectSupplier').value;
            
            if (!supplierName) {
                alert('âš ï¸ SeleccionÃ¡ un proveedor');
                return;
            }

            const template = columnTemplates[supplierName];
            
            if (!template) {
                alert(`âš ï¸ Sin plantilla para "${supplierName}"`);
                return;
            }

            document.getElementById('columnCodeLetter').value = template.code;
            document.getElementById('columnDescriptionLetter').value = template.description;
            document.getElementById('columnPriceLetter').value = template.price;

            updateColumnPreviews();
            alert(`âœ… Plantilla cargada`);
        }

        function autoDetectColumns() {
            if (!currentFileHeaders || currentFileHeaders.length === 0) {
                alert('âš ï¸ No hay archivo cargado');
                return;
            }

            const keywords = {
                code: ['codigo', 'code', 'sku', 'cod', 'item'],
                description: ['descripcion', 'description', 'desc', 'producto'],
                price: ['precio', 'price', 'costo', 'cost', 'valor']
            };

            let detected = {};
            
            Object.keys(keywords).forEach(field => {
                for (let i = 0; i < currentFileHeaders.length; i++) {
                    const header = currentFileHeaders[i].toLowerCase().trim();
                    if (keywords[field].some(keyword => header.includes(keyword))) {
                        detected[field] = indexToLetter(i);
                        break;
                    }
                }
            });

            if (Object.keys(detected).length > 0) {
                if (detected.code) document.getElementById('columnCodeLetter').value = detected.code;
                if (detected.description) document.getElementById('columnDescriptionLetter').value = detected.description;
                if (detected.price) document.getElementById('columnPriceLetter').value = detected.price;
                
                updateColumnPreviews();
                alert('âœ… Columnas detectadas automÃ¡ticamente');
            } else {
                alert('âš ï¸ No se detectaron columnas');
            }
        }

        function calculateFinalPrice(basePrice, d1, d2, d3, iva) {
            let price = basePrice;
            price *= (1 - d1 / 100);
            price *= (1 - d2 / 100);
            price *= (1 - d3 / 100);
            price *= (1 + iva / 100);
            return price;
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (file) processFile(file);
        }

        function startNewImport() {
            importType = 'new';
            document.getElementById('importTypeSelection').style.display = 'block';
            document.getElementById('importTypeMessage').innerHTML = 'ğŸ“¥ <strong>Nueva ImportaciÃ³n</strong>';
            document.getElementById('uploadZone').style.display = 'block';
            document.getElementById('importForm').style.display = 'none';
        }

        function startUpdateImport() {
            if (suppliersData.length === 0) {
                alert('âš ï¸ No hay proveedores');
                return;
            }
            importType = 'update';
            document.getElementById('importTypeSelection').style.display = 'block';
            document.getElementById('importTypeMessage').innerHTML = 'ğŸ”„ <strong>Actualizar Precios</strong>';
            document.getElementById('uploadZone').style.display = 'block';
            document.getElementById('importForm').style.display = 'none';
        }

        function processFile(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet, {header: 1});
                
                currentFileHeaders = jsonData[0];
                currentFileData = jsonData.slice(1);
                showImportForm();
            };
            reader.readAsArrayBuffer(file);
        }

        function showImportForm() {
            document.getElementById('importForm').style.display = 'block';
            showColumnPreview();
            setupColumnInputs();
            updateSupplierSelect();
            updateTemplatesList();
        }

        function processImport() {
            const supplierName = document.getElementById('selectSupplier').value;
            const codeLetter = document.getElementById('columnCodeLetter').value.trim().toUpperCase();
            const descLetter = document.getElementById('columnDescriptionLetter').value.trim().toUpperCase();
            const priceLetter = document.getElementById('columnPriceLetter').value.trim().toUpperCase();
            
            // Columnas opcionales
            const bulkLetter = document.getElementById('columnBulkLetter').value.trim().toUpperCase();
            const extraLetter = document.getElementById('columnExtraLetter').value.trim().toUpperCase();
            const extraName = document.getElementById('columnExtraName').value.trim() || 'Extra';

            if (!supplierName || !codeLetter || !descLetter || !priceLetter) {
                alert('âš ï¸ CompletÃ¡ todos los campos obligatorios (CÃ³digo, DescripciÃ³n, Precio)');
                return;
            }

            const codeCol = letterToIndex(codeLetter);
            const descCol = letterToIndex(descLetter);
            const priceCol = letterToIndex(priceLetter);
            const bulkCol = bulkLetter ? letterToIndex(bulkLetter) : -1;
            const extraCol = extraLetter ? letterToIndex(extraLetter) : -1;

            // Obtener columnas adicionales personalizadas
            const activeColumns = getActiveColumns();
            console.log('=== PROCESANDO IMPORTACIÃ“N ===');
            console.log('Columnas configuradas:');
            console.log('- CÃ³digo:', codeLetter, '(Ã­ndice:', codeCol, ')');
            console.log('- DescripciÃ³n:', descLetter, '(Ã­ndice:', descCol, ')');
            console.log('- Precio:', priceLetter, '(Ã­ndice:', priceCol, ')');
            console.log('- Cantidad por Bulto:', bulkLetter || 'No configurada', '(Ã­ndice:', bulkCol, ')');
            console.log('- Columna Extra:', extraLetter || 'No configurada', '(Ã­ndice:', extraCol, ')');

            const supplier = suppliersData.find(s => s.name === supplierName);
            const defaultBrand = supplier.brands && supplier.brands.length > 0 ? supplier.brands[0] : 'Sin marca';
            let addedCount = 0;
            let skippedCount = 0;

            currentFileData.forEach((row, rowIndex) => {
                if (row[codeCol] && row[priceCol]) {
                    const basePrice = parseFloat(String(row[priceCol]).replace(/[^0-9.-]/g, ''));
                    
                    if (isNaN(basePrice) || basePrice <= 0) {
                        console.warn(`Fila ${rowIndex + 2}: Precio invÃ¡lido`);
                        skippedCount++;
                        return;
                    }
                    
                    const finalPrice = calculateFinalPrice(basePrice, supplier.discount1, supplier.discount2, supplier.discount3, supplier.iva);
                    
                    // Crear objeto base del producto
                    const productData = {
                        code: String(row[codeCol]),
                        description: row[descCol] || 'Sin descripciÃ³n',
                        brand: defaultBrand,
                        supplier: supplierName,
                        purchasePrice: finalPrice,
                        basePrice: basePrice,
                        iva: supplier.iva
                    };

                    // Agregar Cantidad por Bulto si estÃ¡ configurada
                    if (bulkCol >= 0 && row[bulkCol] !== undefined && row[bulkCol] !== '') {
                        productData['Cantidad por Bulto'] = row[bulkCol];
                    }

                    // Agregar Columna Extra si estÃ¡ configurada
                    if (extraCol >= 0 && row[extraCol] !== undefined && row[extraCol] !== '') {
                        const safeExtraName = extraName.replace(/[^a-zA-Z0-9Ã¡Ã©Ã­Ã³ÃºÃ±ÃÃ‰ÃÃ“ÃšÃ‘_\s]/g, '').trim();
                        if (safeExtraName) {
                            productData[safeExtraName] = row[extraCol];
                        }
                    }

                    // Agregar todas las columnas adicionales que el usuario definiÃ³
                    Object.keys(activeColumns).forEach(colIndex => {
                        const columnName = activeColumns[colIndex];
                        const colIdx = parseInt(colIndex);
                        
                        // Evitar duplicar las columnas principales y las opcionales ya procesadas
                        if (colIdx !== codeCol && colIdx !== descCol && colIdx !== priceCol && colIdx !== bulkCol && colIdx !== extraCol) {
                            const safeColumnName = columnName.replace(/[^a-zA-Z0-9Ã¡Ã©Ã­Ã³ÃºÃ±ÃÃ‰ÃÃ“ÃšÃ‘_\s]/g, '').trim();
                            if (safeColumnName && row[colIdx] !== undefined && row[colIdx] !== '') {
                                productData[safeColumnName] = row[colIdx];
                            }
                        }
                    });

                    console.log(`Producto ${addedCount + 1}:`, productData);
                    productsData.push(productData);
                    addedCount++;
                } else {
                    skippedCount++;
                }
            });

            saveData();
            updateStats();
            updateCatalog();
            updateSuppliersTable();
            
            let message = `âœ… <strong>ImportaciÃ³n completada!</strong><br>`;
            message += `Productos importados: ${addedCount}<br>`;
            if (skippedCount > 0) {
                message += `Filas omitidas: ${skippedCount} (sin cÃ³digo o precio)<br>`;
            }
            message += `Marca asignada: ${defaultBrand}<br>`;
            
            const extraCols = Object.keys(activeColumns).length - 3;
            if (extraCols > 0) {
                message += `Columnas adicionales guardadas: ${extraCols}`;
            }
            if (bulkCol >= 0) {
                message += `<br>Cantidad por Bulto: âœ“`;
            }
            if (extraCol >= 0) {
                message += `<br>${extraName}: âœ“`;
            }
            
            document.getElementById('importedData').innerHTML = `
                <div class="alert alert-success">${message}</div>
            `;
            
            document.getElementById('importForm').style.display = 'none';
            document.getElementById('uploadZone').style.display = 'none';
            document.getElementById('fileInput').value = '';
            
            console.log(`âœ… ImportaciÃ³n completada: ${addedCount} productos, ${skippedCount} omitidos`);
        }

        function updateStats() {
            const totalProducts = productsData.length;
            const uniqueSuppliers = [...new Set(productsData.map(p => p.supplier))];
            const totalInvestment = productsData.reduce((sum, p) => sum + (p.purchasePrice || 0), 0);
            
            const marginElement = document.getElementById('marginWholesale');
            const marginWholesale = marginElement ? parseFloat(marginElement.value) / 100 : 0.20;
            const totalRevenue = productsData.reduce((sum, p) => sum + ((p.purchasePrice || 0) * (1 + marginWholesale)), 0);

            document.getElementById('totalProducts').textContent = totalProducts;
            document.getElementById('totalSuppliers').textContent = uniqueSuppliers.length;
            document.getElementById('totalClients').textContent = clientsData.length;
            document.getElementById('totalOrders').textContent = ordersData.length;
            document.getElementById('totalInvestment').textContent = '$' + totalInvestment.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            document.getElementById('totalRevenue').textContent = '$' + totalRevenue.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }

        function updateCatalog(filteredProducts = null) {
            const catalogBody = document.getElementById('catalogBody');
            const productsToShow = filteredProducts || productsData;
            
            if (productsToShow.length === 0) {
                const message = filteredProducts ? 
                    'No se encontraron productos con ese criterio de bÃºsqueda.' : 
                    'No hay productos importados.';
                catalogBody.innerHTML = `<tr><td colspan="10" style="text-align: center; padding: 40px; color: #999;">${message}</td></tr>`;
                
                // Actualizar selectores de eliminaciÃ³n
                updateDeleteSelectors();
                updateManualProductSuppliers();
                return;
            }

            const mWElement = document.getElementById('marginWholesale');
            const mRElement = document.getElementById('marginRetail');
            const commElement = document.getElementById('commissionSales');
            const roundElement = document.getElementById('roundingOption');
            
            const mW = mWElement ? (parseFloat(mWElement.value) || 20) / 100 : 0.20;
            const mR = mRElement ? (parseFloat(mRElement.value) || 35) / 100 : 0.35;
            const comm = commElement ? (parseFloat(commElement.value) || 5) / 100 : 0.05;
            const round = roundElement ? roundElement.value : 'normal';

            catalogBody.innerHTML = productsToShow.map(product => {
                const listPrice = parseFloat(product.basePrice) || parseFloat(product.purchasePrice) || 0; // Precio de lista original
                const unitPrice = getUnitPrice(product); // Precio con descuentos aplicados
                const wPrice = applyRounding(unitPrice * (1 + mW), round) || 0;
                const rPrice = applyRounding(unitPrice * (1 + mR + comm), round) || 0;
                const profit = unitPrice > 0 ? ((wPrice - unitPrice) / unitPrice * 100).toFixed(1) : '0';
                
                // Calcular el descuento aplicado
                const discountPercent = listPrice > 0 && listPrice !== unitPrice ? ((listPrice - unitPrice) / listPrice * 100).toFixed(1) : 0;

                return `
                    <tr>
                        <td><strong>${product.code || ''}</strong></td>
                        <td>${product.description || ''}</td>
                        <td><span class="brand-badge">${product.brand || ''}</span></td>
                        <td><span class="supplier-badge">${product.supplier || ''}</span></td>
                        <td style="color: #999; ${discountPercent > 0 ? 'text-decoration: line-through;' : ''}">$${listPrice.toFixed(2)}</td>
                        <td>$${unitPrice.toFixed(2)} ${discountPercent > 0 ? '<small style="color:#4caf50;">(-' + discountPercent + '%)</small>' : ''}</td>
                        <td><span class="price-highlight">$${wPrice.toFixed(2)}</span></td>
                        <td><span class="price-highlight">$${rPrice.toFixed(2)}</span></td>
                        <td><span class="profit-indicator">+${profit}%</span></td>
                        <td>
                            <button class="btn btn-danger btn-small" onclick="deleteProductByCodeDirect('${(product.code || '').replace(/'/g, "\\'")}')">
                                ğŸ—‘ï¸
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');

            // Actualizar selectores de eliminaciÃ³n
            updateDeleteSelectors();
            updateManualProductSuppliers();
            
            // Actualizar filtro de marcas del catÃ¡logo visual
            updateVisualBrandFilter();
 	   updateExportFilters();
        }

        function updateDeleteSelectors() {
            // Actualizar selector de proveedores
            const supplierSelect = document.getElementById('deleteBySupplier');
            const suppliers = [...new Set(productsData.map(p => p.supplier).filter(s => s))].sort();
            
            supplierSelect.innerHTML = '<option value="">-- Seleccionar --</option>' +
                suppliers.map(s => `<option value="${s}">${s}</option>`).join('');

            // Actualizar selector de marcas
            const brandSelect = document.getElementById('deleteByBrand');
            const brands = [...new Set(productsData.map(p => p.brand).filter(b => b))].sort();
            
            brandSelect.innerHTML = '<option value="">-- Seleccionar --</option>' +
                brands.map(b => `<option value="${b}">${b}</option>`).join('');
        }

        // ===== FUNCIONES PARA AGREGAR PRODUCTO MANUAL =====
        
        function updateManualProductSuppliers() {
            const select = document.getElementById('manualProductSupplier');
            if (!select) return;
            
            select.innerHTML = '<option value="">-- Seleccionar --</option>' +
                suppliersData.map(s => `<option value="${s.name}">${s.name}</option>`).join('');
        }
        
        function addProductManually() {
            const code = document.getElementById('manualProductCode').value.trim();
            const description = document.getElementById('manualProductDescription').value.trim();
            const brand = document.getElementById('manualProductBrand').value.trim();
            const supplierName = document.getElementById('manualProductSupplier').value;
            const price = parseFloat(document.getElementById('manualProductPrice').value) || 0;
            const iva = parseFloat(document.getElementById('manualProductIVA').value) || 21;
            const bulto = parseInt(document.getElementById('manualProductBulto').value) || 1;
            
            // Validaciones
            if (!code) {
                alert('âš ï¸ El cÃ³digo es obligatorio');
                document.getElementById('manualProductCode').focus();
                return;
            }
            
            if (!description) {
                alert('âš ï¸ La descripciÃ³n es obligatoria');
                document.getElementById('manualProductDescription').focus();
                return;
            }
            
            if (!supplierName) {
                alert('âš ï¸ SeleccionÃ¡ un proveedor');
                document.getElementById('manualProductSupplier').focus();
                return;
            }
            
            if (price <= 0) {
                alert('âš ï¸ El precio debe ser mayor a 0');
                document.getElementById('manualProductPrice').focus();
                return;
            }
            
            // Verificar si el cÃ³digo ya existe
            const existingProduct = productsData.find(p => p.code === code);
            if (existingProduct) {
                if (!confirm(`âš ï¸ Ya existe un producto con el cÃ³digo "${code}".\n\nÂ¿QuerÃ©s reemplazarlo?`)) {
                    return;
                }
                // Eliminar el producto existente
                productsData = productsData.filter(p => p.code !== code);
            }
            
            // Obtener datos del proveedor para los descuentos
            const supplier = suppliersData.find(s => s.name === supplierName);
            const d1 = supplier ? supplier.discount1 : 0;
            const d2 = supplier ? supplier.discount2 : 0;
            const d3 = supplier ? supplier.discount3 : 0;
            
            // Calcular precio de compra (con descuentos aplicados)
            const finalPrice = calculateFinalPrice(price, d1, d2, d3, iva);
            
            // Crear el producto
            const product = {
                code: code,
                description: description,
                brand: brand || supplierName,
                supplier: supplierName,
                basePrice: price, // Precio de lista original
                purchasePrice: finalPrice, // Precio con descuentos aplicados
                iva: iva,
                cantidadBulto: bulto,
                discount1: d1,
                discount2: d2,
                discount3: d3,
                addedManually: true,
                addedAt: new Date().toISOString()
            };
            
            // Agregar a la lista
            productsData.push(product);
            
            // Guardar y actualizar
            saveData();
            updateCatalog();
            updateStats();
            
            // Limpiar formulario
            clearManualProductForm();
            
            alert(`âœ… Producto "${code}" agregado correctamente\n\nPrecio lista: $${price.toFixed(2)}\nPrecio compra: $${finalPrice.toFixed(2)}`);
            console.log('âœ… Producto agregado manualmente:', product);
        }
        
        function clearManualProductForm() {
            document.getElementById('manualProductCode').value = '';
            document.getElementById('manualProductDescription').value = '';
            document.getElementById('manualProductBrand').value = '';
            document.getElementById('manualProductSupplier').value = '';
            document.getElementById('manualProductPrice').value = '';
            document.getElementById('manualProductIVA').value = '21';
            document.getElementById('manualProductBulto').value = '1';
        }

function updateExportFilters() {
    // Actualizar selector de marcas para exportaciÃ³n
    const brandSelect = document.getElementById('exportFilterBrand');
    if (brandSelect) {
        const brands = [...new Set(productsData.map(p => p.brand).filter(b => b))].sort();
        brandSelect.innerHTML = '<option value="">-- Todas las marcas --</option>' +
            brands.map(b => `<option value="${b}">${b}</option>`).join('');
    }

    // Actualizar selector de proveedores para exportaciÃ³n
    const supplierSelect = document.getElementById('exportFilterSupplier');
    if (supplierSelect) {
        const suppliers = [...new Set(productsData.map(p => p.supplier).filter(s => s))].sort();
        supplierSelect.innerHTML = '<option value="">-- Todos los proveedores --</option>' +
            suppliers.map(s => `<option value="${s}">${s}</option>`).join('');
    }

    // Actualizar contador de productos
    updateExportProductCount();
}

function updateExportProductCount() {
    const brandFilter = document.getElementById('exportFilterBrand').value;
    const supplierFilter = document.getElementById('exportFilterSupplier').value;
    
    let count = productsData.filter(p => {
        const matchBrand = !brandFilter || p.brand === brandFilter;
        const matchSupplier = !supplierFilter || p.supplier === supplierFilter;
        return matchBrand && matchSupplier;
    }).length;
    
    document.getElementById('exportProductCount').textContent = count;
}

        function filterCatalog() {
            const searchTerm = document.getElementById('catalogSearchInput').value.trim().toLowerCase();
            const infoDiv = document.getElementById('catalogSearchInfo');
            
            if (!searchTerm) {
                // Si no hay bÃºsqueda, mostrar todos
                updateCatalog();
                infoDiv.style.display = 'none';
                return;
            }

            // Filtrar productos con validaciÃ³n de campos
            const filtered = productsData.filter(product => {
                const matchCode = product.code && product.code.toString().toLowerCase().includes(searchTerm);
                const matchDescription = product.description && product.description.toString().toLowerCase().includes(searchTerm);
                const matchBrand = product.brand && product.brand.toString().toLowerCase().includes(searchTerm);
                const matchSupplier = product.supplier && product.supplier.toString().toLowerCase().includes(searchTerm);
                
                return matchCode || matchDescription || matchBrand || matchSupplier;
            });

            // Actualizar catÃ¡logo con productos filtrados
            updateCatalog(filtered);

            // Mostrar estadÃ­sticas de bÃºsqueda
            document.getElementById('catalogResultCount').textContent = filtered.length;
            infoDiv.style.display = 'block';

            console.log(`ğŸ” BÃºsqueda: "${searchTerm}" - ${filtered.length} resultados`);
        }

        function clearCatalogSearch() {
            document.getElementById('catalogSearchInput').value = '';
            document.getElementById('catalogSearchInfo').style.display = 'none';
            updateCatalog();
            console.log('ğŸ”„ BÃºsqueda limpiada');
        }

        function showCatalogStats() {
            const totalProducts = productsData.length;
            const uniqueSuppliers = [...new Set(productsData.map(p => p.supplier))];
            const uniqueBrands = [...new Set(productsData.map(p => p.brand))].filter(b => b);
            
            const totalInvestment = productsData.reduce((sum, p) => sum + p.purchasePrice, 0);
            
            alert(`ğŸ“Š ESTADÃSTICAS DEL CATÃLOGO\n\n` +
                  `Total Productos: ${totalProducts}\n` +
                  `Proveedores: ${uniqueSuppliers.length}\n` +
                  `Marcas: ${uniqueBrands.length}\n\n` +
                  `InversiÃ³n Total: $${totalInvestment.toFixed(2)}`);
        }

        // ===== FUNCIONES DE ELIMINACIÃ“N DE PRODUCTOS =====

        function deleteProductsBySupplier() {
            const supplier = document.getElementById('deleteBySupplier').value;
            
            if (!supplier) {
                alert('âš ï¸ SeleccionÃ¡ un proveedor');
                return;
            }

            const productsToDelete = productsData.filter(p => p.supplier === supplier);
            
            if (productsToDelete.length === 0) {
                alert(`No hay productos del proveedor "${supplier}"`);
                return;
            }

            const confirmMessage = `âš ï¸ ELIMINAR TODOS LOS PRODUCTOS DEL PROVEEDOR\n\n` +
                                  `Proveedor: ${supplier}\n` +
                                  `Productos a eliminar: ${productsToDelete.length}\n\n` +
                                  `Esta acciÃ³n NO se puede deshacer.\n\n` +
                                  `Â¿EstÃ¡s seguro?`;

            if (!confirm(confirmMessage)) {
                return;
            }

            // Segundo nivel de confirmaciÃ³n para eliminaciones masivas
            if (productsToDelete.length > 10) {
                if (!confirm(`âš ï¸ CONFIRMACIÃ“N FINAL\n\nÂ¿Realmente querÃ©s eliminar ${productsToDelete.length} productos?\n\nEsta es la Ãºltima advertencia.`)) {
                    return;
                }
            }

            console.log(`ğŸ—‘ï¸ Eliminando ${productsToDelete.length} productos del proveedor ${supplier}`);

            // Eliminar productos
            productsData = productsData.filter(p => p.supplier !== supplier);
            
            // Guardar cambios
            saveData();
            
            // Actualizar interfaz
            updateCatalog();
            updateStats();
            
            // Limpiar selector
            document.getElementById('deleteBySupplier').value = '';

            alert(`âœ… Eliminados ${productsToDelete.length} productos del proveedor "${supplier}"`);
        }

        function deleteProductsByBrand() {
            const brand = document.getElementById('deleteByBrand').value;
            
            if (!brand) {
                alert('âš ï¸ SeleccionÃ¡ una marca');
                return;
            }

            const productsToDelete = productsData.filter(p => p.brand === brand);
            
            if (productsToDelete.length === 0) {
                alert(`No hay productos de la marca "${brand}"`);
                return;
            }

            const confirmMessage = `âš ï¸ ELIMINAR TODOS LOS PRODUCTOS DE LA MARCA\n\n` +
                                  `Marca: ${brand}\n` +
                                  `Productos a eliminar: ${productsToDelete.length}\n\n` +
                                  `Esta acciÃ³n NO se puede deshacer.\n\n` +
                                  `Â¿EstÃ¡s seguro?`;

            if (!confirm(confirmMessage)) {
                return;
            }

            // Segundo nivel de confirmaciÃ³n para eliminaciones masivas
            if (productsToDelete.length > 10) {
                if (!confirm(`âš ï¸ CONFIRMACIÃ“N FINAL\n\nÂ¿Realmente querÃ©s eliminar ${productsToDelete.length} productos?\n\nEsta es la Ãºltima advertencia.`)) {
                    return;
                }
            }

            console.log(`ğŸ—‘ï¸ Eliminando ${productsToDelete.length} productos de la marca ${brand}`);

            // Eliminar productos
            productsData = productsData.filter(p => p.brand !== brand);
            
            // Guardar cambios
            saveData();
            
            // Actualizar interfaz
            updateCatalog();
            updateStats();
            
            // Limpiar selector
            document.getElementById('deleteByBrand').value = '';

            alert(`âœ… Eliminados ${productsToDelete.length} productos de la marca "${brand}"`);
        }

        function deleteProductByCode() {
            const code = document.getElementById('deleteByCode').value.trim();
            
            if (!code) {
                alert('âš ï¸ IngresÃ¡ un cÃ³digo de producto');
                return;
            }

            const product = productsData.find(p => p.code === code);
            
            if (!product) {
                alert(`âš ï¸ No se encontrÃ³ ningÃºn producto con el cÃ³digo "${code}"`);
                return;
            }

            const confirmMessage = `Â¿ELIMINAR PRODUCTO?\n\n` +
                                  `CÃ³digo: ${product.code}\n` +
                                  `DescripciÃ³n: ${product.description}\n` +
                                  `Marca: ${product.brand}\n` +
                                  `Proveedor: ${product.supplier}\n\n` +
                                  `Esta acciÃ³n NO se puede deshacer.`;

            if (!confirm(confirmMessage)) {
                return;
            }

            console.log(`ğŸ—‘ï¸ Eliminando producto ${code}`);

            // Eliminar producto
            productsData = productsData.filter(p => p.code !== code);
            
            // Guardar cambios
            saveData();
            
            // Actualizar interfaz
            updateCatalog();
            updateStats();
            
            // Limpiar input
            document.getElementById('deleteByCode').value = '';

            alert(`âœ… Producto "${product.description}" eliminado correctamente`);
        }

        function deleteProductByCodeDirect(code) {
            const product = productsData.find(p => p.code === code);
            
            if (!product) {
                alert(`âš ï¸ No se encontrÃ³ el producto`);
                return;
            }

            const confirmMessage = `Â¿ELIMINAR PRODUCTO?\n\n` +
                                  `CÃ³digo: ${product.code}\n` +
                                  `DescripciÃ³n: ${product.description}\n` +
                                  `Marca: ${product.brand}\n` +
                                  `Proveedor: ${product.supplier}\n\n` +
                                  `Esta acciÃ³n NO se puede deshacer.`;

            if (!confirm(confirmMessage)) {
                return;
            }

            console.log(`ğŸ—‘ï¸ Eliminando producto ${code}`);

            // Eliminar producto
            productsData = productsData.filter(p => p.code !== code);
            
            // Guardar cambios
            saveData();
            
            // Actualizar interfaz
            updateCatalog();
            updateStats();

            alert(`âœ… Producto "${product.description}" eliminado correctamente`);
        }

        function exportFilteredToExcel() {
            const searchTerm = document.getElementById('catalogSearchInput').value.trim().toLowerCase();
            
            if (!searchTerm) {
                alert('ğŸ’¡ No hay filtro aplicado. UsÃ¡ el botÃ³n "ğŸ“¤ Exportar" en la pestaÃ±a Exportar para exportar todos los productos.');
                return;
            }

            // Obtener productos filtrados
            const filtered = productsData.filter(product => {
                const matchCode = product.code.toLowerCase().includes(searchTerm);
                const matchDescription = product.description.toLowerCase().includes(searchTerm);
                const matchBrand = product.brand && product.brand.toLowerCase().includes(searchTerm);
                const matchSupplier = product.supplier && product.supplier.toLowerCase().includes(searchTerm);
                
                return matchCode || matchDescription || matchBrand || matchSupplier;
            });

            if (filtered.length === 0) {
                alert('âš ï¸ No hay productos para exportar con el filtro actual');
                return;
            }

            if (!confirm(`Â¿Exportar ${filtered.length} productos filtrados?\n\nCriterio de bÃºsqueda: "${searchTerm}"`)) {
                return;
            }

            // Guardar productos actuales
            const tempProducts = productsData;
            
            // Reemplazar temporalmente con filtrados
            productsData = filtered;
            
            // Exportar
            exportToExcel();
            
            // Restaurar productos originales
            productsData = tempProducts;

            console.log(`ğŸ“Š Exportados ${filtered.length} productos filtrados`);
        }

        function applyRounding(price, option) {
            if (!price || isNaN(price)) return 0;
            if (option === 'none' || option === 'normal' || option === '' || !option) return Math.round(price * 100) / 100;
            const multiple = parseInt(option);
            if (isNaN(multiple) || multiple <= 0) return Math.round(price * 100) / 100;
            return Math.round(price / multiple) * multiple;
        }

        function updatePrices() {
            updateCatalog();
            updateStats();
        }

        function switchTab(tabName, event) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            
            if (event?.target) {
                event.target.classList.add('active');
            }

            // Actualizar catÃ¡logo visual cuando se cambie a esa pestaÃ±a
            if (tabName === 'visual-catalog') {
                updateVisualCatalog();
            }
            
            // Actualizar catÃ¡logo normal cuando se cambie a esa pestaÃ±a
            if (tabName === 'catalog') {
                updateCatalog();
            }
            
            // Cargar pedidos a fÃ¡brica
            if (tabName === 'factory-orders') {
                showFactoryTab('new-order');
                updateFactoryStats();
            }
        }
	function getFilteredProductsForExport() {
    const brandFilter = document.getElementById('exportFilterBrand').value;
    const supplierFilter = document.getElementById('exportFilterSupplier').value;
    
    return productsData.filter(p => {
        const matchBrand = !brandFilter || p.brand === brandFilter;
        const matchSupplier = !supplierFilter || p.supplier === supplierFilter;
        return matchBrand && matchSupplier;
    });
}

        function exportToExcel() {
    const filteredProducts = getFilteredProductsForExport();
    
    if (filteredProducts.length === 0) {
        alert('No hay productos para exportar con los filtros seleccionados');
        return;
    }

    console.log('=== EXPORTANDO A EXCEL AGRUPADO POR MARCA ===');
    console.log('Total productos filtrados:', filteredProducts.length);

            const filename = document.getElementById('exportFilename').value || 'lista_precios_bruzzone';
            const exportType = document.getElementById('exportType').value;
            const includeIVA = document.getElementById('includeIVA').checked;

	// Agrupar productos por marca
		const productosPorMarca = {};
		filteredProducts.forEach(product => {
                const marca = product.brand || 'Sin Marca';
                if (!productosPorMarca[marca]) {
                    productosPorMarca[marca] = [];
                }
                productosPorMarca[marca].push(product);
            });

            // Ordenar marcas alfabÃ©ticamente
            const marcasOrdenadas = Object.keys(productosPorMarca).sort();
            console.log('Marcas encontradas:', marcasOrdenadas);

            // ConfiguraciÃ³n de mÃ¡rgenes
            const marginWholesale = parseFloat(document.getElementById('marginWholesale').value) / 100;
            const marginRetail = parseFloat(document.getElementById('marginRetail').value) / 100;
            const commission = parseFloat(document.getElementById('commissionSales').value) / 100;
            const roundingOption = document.getElementById('roundingOption').value;

            // Crear encabezado principal con datos configurables
            const headerData = [
                [companyData.name || 'BRUZZONE DISTRIBUIDORA'],
                [companyData.slogan || 'MAYORISTA'],
                [''],
                [companyData.address || 'Dr. Carlos Rocha 128 - Alejandro Roca, CÃ³rdoba'],
                [`Tel: ${companyData.phone || '3585142098'} | ${companyData.email || 'bruzzonedistribuidora@gmail.com'}`],
                [''],
                ['LISTA DE PRECIOS ' + (includeIVA ? 'CON IVA EN VENTA' : 'SIN IVA EN VENTA')],
                ['Fecha: ' + new Date().toLocaleDateString('es-AR', { 
                    day: '2-digit', 
                    month: '2-digit', 
                    year: 'numeric' 
                })],
                ['']
            ];

            // Crear array de datos completo
            const allData = [];

            // Procesar cada marca
            marcasOrdenadas.forEach((marca, marcaIndex) => {
                const productos = productosPorMarca[marca];
                
                // Agregar encabezado de marca (fila destacada)
                allData.push([marca.toUpperCase(), '', '', '', '', '']);
                allData.push([]); // Fila vacÃ­a para separaciÃ³n

                // Agregar encabezados de columnas
                const columnHeaders = ['CÃ“DIGO', 'DESCRIPCIÃ“N', 'CANT. X BULTO'];
                
                if (exportType === 'complete') {
                    columnHeaders.push('PRECIO MAYORISTA SIN IVA', 'PRECIO MINORISTA SIN IVA', 'PROVEEDOR');
                } else if (exportType === 'wholesale') {
                    columnHeaders.push('PRECIO MAYORISTA SIN IVA');
                } else if (exportType === 'retail') {
                    columnHeaders.push('PRECIO MINORISTA SIN IVA');
                }
                
                allData.push(columnHeaders);

                // Agregar productos de esta marca
                productos.forEach(product => {
                    // USAR PRECIO POR UNIDAD (considerando cantidad por bulto)
                    const precioBase = getUnitPrice(product);

                    // Buscar cantidad por bulto
                    let cantidadPorBulto = '';
                    const posibleNombres = [
                        'Cantidad por Bulto', 'cantidad por bulto', 'Cant por Bulto', 'cant por bulto',
                        'Bulto', 'bulto', 'Cantidad', 'cantidad', 'CantBulto', 'Cant Bulto',
                        'Unid x Bulto', 'unid x bulto', 'Unidades por Bulto', 'unidades por bulto'
                    ];

                    for (let nombre of posibleNombres) {
                        if (product[nombre] !== undefined && product[nombre] !== '') {
                            cantidadPorBulto = product[nombre];
                            break;
                        }
                    }

                    const row = [
                        product.code || '',
                        product.description || '',
                        cantidadPorBulto
                    ];

                    // Agregar precios segÃºn tipo de exportaciÃ³n
                    if (exportType === 'complete') {
                        const precioMayorista = applyRounding(precioBase * (1 + marginWholesale), roundingOption);
                        const precioMinorista = applyRounding(precioBase * (1 + marginRetail + commission), roundingOption);
                        row.push(
                            parseFloat(precioMayorista.toFixed(2)),
                            parseFloat(precioMinorista.toFixed(2)),
                            product.supplier || ''
                        );
                    } else if (exportType === 'wholesale') {
                        const precioMayorista = applyRounding(precioBase * (1 + marginWholesale), roundingOption);
                        row.push(parseFloat(precioMayorista.toFixed(2)));
                    } else if (exportType === 'retail') {
                        const precioMinorista = applyRounding(precioBase * (1 + marginRetail + commission), roundingOption);
                        row.push(parseFloat(precioMinorista.toFixed(2)));
                    }

                    allData.push(row);
                });

                // Agregar lÃ­neas vacÃ­as entre marcas para separaciÃ³n
                allData.push([]);
                allData.push([]);
            });

            // Agregar resumen final
            allData.push(['â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', '', '', '', '', '']);
            allData.push([`TOTAL GENERAL: ${filteredProducts.length} productos en ${marcasOrdenadas.length} marcas`, '', '', '', '', '']);
            allData.push([]);

            // Crear worksheet
            const ws = XLSX.utils.aoa_to_sheet([...headerData, ...allData]);

            // Aplicar estilos y anchos de columna
            const colWidths = [
                { wch: 15 },  // CÃ“DIGO
                { wch: 50 },  // DESCRIPCIÃ“N
                { wch: 15 },  // CANT X BULTO
                { wch: 18 },  // PRECIO MAYORISTA
                { wch: 18 },  // PRECIO MINORISTA
                { wch: 25 }   // PROVEEDOR
            ];
            ws['!cols'] = colWidths;

            // Crear workbook
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Lista de Precios");
            
            // Descargar archivo
            const fechaHoy = new Date().toISOString().split('T')[0];
            XLSX.writeFile(wb, `${filename}_${fechaHoy}.xlsx`);
            
            console.log('âœ… Archivo exportado exitosamente');
            console.log(`- ${marcasOrdenadas.length} marcas`);
            console.log(`- ${productsData.length} productos`);
            
            alert(`âœ… Lista exportada exitosamente\n\nğŸ“¦ ${filteredProducts.length} productos\nğŸ·ï¸ ${marcasOrdenadas.length} marcas\n\nArchivo: ${filename}_${fechaHoy}.xlsx`);
        }

        function exportToPDF() {
    const filteredProducts = getFilteredProductsForExport();
    
    if (filteredProducts.length === 0) {
        alert('No hay productos para exportar con los filtros seleccionados');
        return;
    }

    console.log('=== EXPORTANDO A PDF AGRUPADO POR MARCA ===');
    console.log('Total productos filtrados:', filteredProducts.length);;

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('landscape'); // OrientaciÃ³n horizontal para mÃ¡s espacio

            const filename = document.getElementById('exportFilename').value || 'lista_precios_bruzzone';
            const exportType = document.getElementById('exportType').value;
            const includeIVA = document.getElementById('includeIVA').checked;

            // ConfiguraciÃ³n de mÃ¡rgenes
            const marginWholesale = parseFloat(document.getElementById('marginWholesale').value) / 100;
            const marginRetail = parseFloat(document.getElementById('marginRetail').value) / 100;
            const commission = parseFloat(document.getElementById('commissionSales').value) / 100;
            const roundingOption = document.getElementById('roundingOption').value;

            let currentY = 15;

            // ENCABEZADO DEL PDF
            doc.setFontSize(18);
            doc.setFont('helvetica', 'bold');
            doc.text(companyData.name || 'BRUZZONE DISTRIBUIDORA', 148, currentY, { align: 'center' });
            
            currentY += 8;
            doc.setFontSize(12);
            doc.setFont('helvetica', 'normal');
            doc.text(companyData.slogan || 'MAYORISTA', 148, currentY, { align: 'center' });
            
            currentY += 6;
            doc.setFontSize(9);
            doc.text(companyData.address || 'Dr. Carlos Rocha 128 - Alejandro Roca, CÃ³rdoba', 148, currentY, { align: 'center' });
            
            currentY += 5;
            doc.text(`Tel: ${companyData.phone || '3585142098'} | ${companyData.email || 'bruzzonedistribuidora@gmail.com'}`, 148, currentY, { align: 'center' });
            
            currentY += 8;
            doc.setFontSize(11);
            doc.setFont('helvetica', 'bold');
            doc.text('LISTA DE PRECIOS ' + (includeIVA ? 'CON IVA EN VENTA' : 'SIN IVA EN VENTA'), 148, currentY, { align: 'center' });
            
            currentY += 5;
            doc.setFontSize(9);
            doc.setFont('helvetica', 'normal');
            const fechaHoy = new Date().toLocaleDateString('es-AR', { 
                day: '2-digit', 
                month: '2-digit', 
                year: 'numeric' 
            });
            doc.text(`Fecha: ${fechaHoy}`, 148, currentY, { align: 'center' });

            currentY += 10;

            // Agrupar productos por marca
           const productosPorMarca = {};
filteredProducts.forEach(product => {
                const marca = product.brand || 'Sin Marca';
                if (!productosPorMarca[marca]) {
                    productosPorMarca[marca] = [];
                }
                productosPorMarca[marca].push(product);
            });

            const marcasOrdenadas = Object.keys(productosPorMarca).sort();

            // Definir columnas segÃºn tipo de exportaciÃ³n
            let columns = ['CÃ³digo', 'DescripciÃ³n', 'Cant. x Bulto'];
            
            if (exportType === 'complete') {
                columns.push('P. Mayorista S/IVA', 'P. Minorista S/IVA', 'Proveedor');
            } else if (exportType === 'wholesale') {
                columns.push('P. Mayorista S/IVA');
            } else if (exportType === 'retail') {
                columns.push('P. Minorista S/IVA');
            }

            // Procesar cada marca
            marcasOrdenadas.forEach((marca, marcaIndex) => {
                const productos = productosPorMarca[marca];

                // Agregar encabezado de marca
                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.setFillColor(102, 126, 234);
                doc.setTextColor(255, 255, 255);
                doc.rect(10, currentY, 277, 7, 'F');
                doc.text(marca.toUpperCase(), 148, currentY + 5, { align: 'center' });
                doc.setTextColor(0, 0, 0);
                
                currentY += 10;

                // Preparar datos de la tabla
                const tableData = productos.map(product => {
                    // USAR PRECIO POR UNIDAD (considerando cantidad por bulto)
                    const precioBase = getUnitPrice(product);

                    // Buscar cantidad por bulto
                    let cantidadPorBulto = '';
                    const posibleNombres = [
                        'Cantidad por Bulto', 'cantidad por bulto', 'Cant por Bulto', 'cant por bulto',
                        'Bulto', 'bulto', 'Cantidad', 'cantidad', 'CantBulto', 'Cant Bulto',
                        'Unid x Bulto', 'unid x bulto'
                    ];

                    for (let nombre of posibleNombres) {
                        if (product[nombre] !== undefined && product[nombre] !== '') {
                            cantidadPorBulto = product[nombre];
                            break;
                        }
                    }

                    const row = [
                        product.code || '',
                        product.description || '',
                        cantidadPorBulto
                    ];

                    if (exportType === 'complete') {
                        const precioMayorista = applyRounding(precioBase * (1 + marginWholesale), roundingOption);
                        const precioMinorista = applyRounding(precioBase * (1 + marginRetail + commission), roundingOption);
                        row.push(
                            '$' + precioMayorista.toFixed(2),
                            '$' + precioMinorista.toFixed(2),
                            product.supplier || ''
                        );
                    } else if (exportType === 'wholesale') {
                        const precioMayorista = applyRounding(precioBase * (1 + marginWholesale), roundingOption);
                        row.push('$' + precioMayorista.toFixed(2));
                    } else if (exportType === 'retail') {
                        const precioMinorista = applyRounding(precioBase * (1 + marginRetail + commission), roundingOption);
                        row.push('$' + precioMinorista.toFixed(2));
                    }

                    return row;
                });

                // Crear tabla con autoTable
                doc.autoTable({
                    startY: currentY,
                    head: [columns],
                    body: tableData,
                    theme: 'striped',
                    headStyles: {
                        fillColor: [102, 126, 234],
                        textColor: [255, 255, 255],
                        fontSize: 9,
                        fontStyle: 'bold',
                        halign: 'center'
                    },
                    bodyStyles: {
                        fontSize: 8,
                        cellPadding: 2
                    },
                    columnStyles: {
                        0: { cellWidth: 25, halign: 'center' }, // CÃ³digo
                        1: { cellWidth: exportType === 'complete' ? 80 : 120 }, // DescripciÃ³n
                        2: { cellWidth: 25, halign: 'center' }, // Cant x Bulto
                        3: { cellWidth: 30, halign: 'right' }, // P. Mayorista o Minorista
                        4: { cellWidth: 30, halign: 'right' }, // P. Minorista (solo en complete)
                        5: { cellWidth: 40 } // Proveedor (solo en complete)
                    },
                    margin: { left: 10, right: 10 },
                    didDrawPage: function (data) {
                        // Si es una nueva pÃ¡gina, agregar encabezado
                        if (data.pageNumber > 1) {
                            doc.setFontSize(9);
                            doc.setFont('helvetica', 'italic');
                            doc.text(companyData.name || 'BRUZZONE DISTRIBUIDORA', 10, 10);
                            doc.text(`PÃ¡gina ${data.pageNumber}`, 280, 10, { align: 'right' });
                        }
                    }
                });

                currentY = doc.lastAutoTable.finalY + 8;

                // Si queda poco espacio, agregar nueva pÃ¡gina
                if (currentY > 180 && marcaIndex < marcasOrdenadas.length - 1) {
                    doc.addPage();
                    currentY = 15;
                }
            });

            // Agregar resumen final
            if (currentY > 180) {
                doc.addPage();
                currentY = 15;
            }

            doc.setFontSize(10);
            doc.setFont('helvetica', 'bold');
            doc.setFillColor(46, 125, 50);
            doc.setTextColor(255, 255, 255);
            doc.rect(10, currentY, 277, 7, 'F');
            doc.text(`TOTAL GENERAL: ${productsData.length} productos en ${marcasOrdenadas.length} marcas`, 148, currentY + 5, { align: 'center' });

            // Guardar PDF
            const fechaArchivo = new Date().toISOString().split('T')[0];
            doc.save(`${filename}_${fechaArchivo}.pdf`);

            console.log('âœ… PDF exportado exitosamente');
            console.log(`- ${marcasOrdenadas.length} marcas`);
            console.log(`- ${productsData.length} productos`);

            alert(`âœ… Lista exportada a PDF exitosamente\n\nğŸ“¦ ${productsData.length} productos\nğŸ·ï¸ ${marcasOrdenadas.length} marcas\n\nArchivo: ${filename}_${fechaArchivo}.pdf`);
        }

      function exportOrderToExcel() {
    const filteredProducts = getFilteredProductsForExport();
    
    if (filteredProducts.length === 0) {
        alert('No hay productos para exportar con los filtros seleccionados');
        return;
    }

    console.log('=== EXPORTANDO ORDEN DE PEDIDO A EXCEL ===');

            try {
                const filename = document.getElementById('exportFilename').value || 'orden_pedido_bruzzone';
                const exportType = document.getElementById('exportType').value;

                // ConfiguraciÃ³n de mÃ¡rgenes
                const marginWholesale = parseFloat(document.getElementById('marginWholesale').value) / 100;
                const marginRetail = parseFloat(document.getElementById('marginRetail').value) / 100;
                const commission = parseFloat(document.getElementById('commissionSales').value) / 100;
                const roundingOption = document.getElementById('roundingOption').value;

                // Agrupar productos por marca
                // Agrupar productos por marca
			const productosPorMarca = {};
			filteredProducts.forEach(product => {
                    const marca = product.brand || 'Sin Marca';
                    if (!productosPorMarca[marca]) {
                        productosPorMarca[marca] = [];
                    }
                    productosPorMarca[marca].push(product);
                });

                const marcasOrdenadas = Object.keys(productosPorMarca).sort();

                // Construir datos de la orden
                const allData = [];

                // Encabezado
                allData.push([companyData.name || 'BRUZZONE DISTRIBUIDORA']);
                allData.push([companyData.slogan || 'MAYORISTA']);
                allData.push(['']);
                allData.push([companyData.address || 'Dr. Carlos Rocha 128 - Alejandro Roca, CÃ³rdoba']);
                allData.push([`Tel: ${companyData.phone || '3585142098'} | ${companyData.email || 'bruzzonedistribuidora@gmail.com'}`]);
                allData.push(['']);
                allData.push(['ORDEN DE PEDIDO']);
                allData.push([`Fecha: ${new Date().toLocaleDateString('es-AR', { day: '2-digit', month: '2-digit', year: 'numeric' })}`]);
                allData.push(['']);
                allData.push(['DATOS DEL CLIENTE (Completar):']);
                allData.push(['Nombre/RazÃ³n Social:', '']);
                allData.push(['CUIT/DNI:', '']);
                allData.push(['TelÃ©fono:', '']);
                allData.push(['Email:', '']);
                allData.push(['DirecciÃ³n de Entrega:', '']);
                allData.push(['']);
                allData.push(['']);

                // Procesar cada marca
                marcasOrdenadas.forEach((marca) => {
                    const productos = productosPorMarca[marca];
                    
                    // Encabezado de marca
                    allData.push([]);
                    allData.push([marca.toUpperCase()]);
                    
                    // Encabezados de columnas
                    allData.push(['CANT.', 'CÃ“DIGO', 'DESCRIPCIÃ“N', 'PRECIO UNIT.', 'SUBTOTAL']);

                    // Productos
                    productos.forEach((product) => {
                        const precioBase = getUnitPrice(product);

                        // Calcular precio segÃºn tipo
                        let precioVenta;
                        if (exportType === 'wholesale') {
                            precioVenta = applyRounding(precioBase * (1 + marginWholesale), roundingOption);
                        } else {
                            precioVenta = applyRounding(precioBase * (1 + marginRetail + commission), roundingOption);
                        }

                        allData.push([
                            '', // Cantidad vacÃ­a para que el cliente complete
                            product.code || '',
                            product.description || '',
                            precioVenta.toFixed(2),
                            ''  // Subtotal vacÃ­o para llenar manualmente
                        ]);
                    });
                });

                // Totales
                allData.push(['']);
                allData.push(['', '', '', 'TOTAL GENERAL:', '']);
                allData.push(['']);
                allData.push(['OBSERVACIONES:']);
                allData.push(['']);
                allData.push(['']);
                allData.push(['Firma del Cliente: _______________________']);

                // Crear worksheet
                const ws = XLSX.utils.aoa_to_sheet(allData);

                // Formato de columnas
                const colWidths = [
                    { wch: 8 },   // CANT
                    { wch: 15 },  // CÃ“DIGO
                    { wch: 50 },  // DESCRIPCIÃ“N
                    { wch: 15 },  // PRECIO UNIT
                    { wch: 15 }   // SUBTOTAL
                ];
                ws['!cols'] = colWidths;

                // Crear workbook
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Orden de Pedido");
                
                // Descargar
                const fechaHoy = new Date().toISOString().split('T')[0];
                XLSX.writeFile(wb, `${filename}_${fechaHoy}.xlsx`);
                
                alert(`âœ… Orden de Pedido exportada a Excel\n\n` +
                      `ğŸ“¦ ${productsData.length} productos\n` +
                      `ğŸ·ï¸ ${marcasOrdenadas.length} marcas\n\n` +
                      `Archivo: ${filename}_${fechaHoy}.xlsx`);

                console.log('âœ… ExportaciÃ³n exitosa');
            } catch(error) {
                console.error('Error en exportOrderToExcel:', error);
                alert('âŒ Error al exportar: ' + error.message);
            }
        }

function exportOrderToPDF() {
    const filteredProducts = getFilteredProductsForExport();
    
    if (filteredProducts.length === 0) {
        alert('No hay productos para exportar con los filtros seleccionados');
        return;
    }

            console.log('=== EXPORTANDO ORDEN DE PEDIDO A PDF ===');

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('portrait'); // Vertical para orden de pedido

            const filename = document.getElementById('exportFilename').value || 'orden_pedido_bruzzone';
            const exportType = document.getElementById('exportType').value;
            const includeIVA = document.getElementById('includeIVA').checked;

            // ConfiguraciÃ³n de mÃ¡rgenes
            const marginWholesale = parseFloat(document.getElementById('marginWholesale').value) / 100;
            const marginRetail = parseFloat(document.getElementById('marginRetail').value) / 100;
            const commission = parseFloat(document.getElementById('commissionSales').value) / 100;
            const roundingOption = document.getElementById('roundingOption').value;

            let currentY = 15;

            // ENCABEZADO
            doc.setFontSize(16);
            doc.setFont('helvetica', 'bold');
            doc.text(companyData.name || 'BRUZZONE DISTRIBUIDORA', 105, currentY, { align: 'center' });
            
            currentY += 7;
            doc.setFontSize(11);
            doc.setFont('helvetica', 'normal');
            doc.text(companyData.slogan || 'MAYORISTA', 105, currentY, { align: 'center' });
            
            currentY += 6;
            doc.setFontSize(9);
            doc.text(companyData.address || 'Dr. Carlos Rocha 128 - Alejandro Roca, CÃ³rdoba', 105, currentY, { align: 'center' });
            
            currentY += 5;
            doc.text(`Tel: ${companyData.phone || '3585142098'} | ${companyData.email || 'bruzzonedistribuidora@gmail.com'}`, 105, currentY, { align: 'center' });
            
            currentY += 10;
            doc.setFontSize(14);
            doc.setFont('helvetica', 'bold');
            doc.text('ORDEN DE PEDIDO', 105, currentY, { align: 'center' });
            
            currentY += 6;
            doc.setFontSize(9);
            doc.setFont('helvetica', 'normal');
            const fechaHoy = new Date().toLocaleDateString('es-AR', { day: '2-digit', month: '2-digit', year: 'numeric' });
            doc.text(`Fecha: ${fechaHoy}`, 105, currentY, { align: 'center' });

            currentY += 10;

            // SECCIÃ“N DATOS DEL CLIENTE
            doc.setFillColor(240, 240, 240);
            doc.rect(15, currentY, 180, 35, 'F');
            
            currentY += 5;
            doc.setFontSize(10);
            doc.setFont('helvetica', 'bold');
            doc.text('DATOS DEL CLIENTE:', 20, currentY);
            
            currentY += 7;
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(9);
            doc.text('Nombre/RazÃ³n Social: _______________________________________________', 20, currentY);
            
            currentY += 6;
            doc.text('CUIT/DNI: __________________________    Tel: ____________________', 20, currentY);
            
            currentY += 6;
            doc.text('Email: _______________________________________________________________', 20, currentY);
            
            currentY += 6;
            doc.text('DirecciÃ³n de Entrega: ________________________________________________', 20, currentY);

            currentY += 10;

            // Agrupar productos por marca
            const productosPorMarca = {};
            productsData.forEach(product => {
                const marca = product.brand || 'Sin Marca';
                if (!productosPorMarca[marca]) {
                    productosPorMarca[marca] = [];
                }
                productosPorMarca[marca].push(product);
            });

            const marcasOrdenadas = Object.keys(productosPorMarca).sort();

            // PRODUCTOS
            marcasOrdenadas.forEach((marca, marcaIndex) => {
                const productos = productosPorMarca[marca];

                // Encabezado de marca
                doc.setFontSize(11);
                doc.setFont('helvetica', 'bold');
                doc.setFillColor(102, 126, 234);
                doc.setTextColor(255, 255, 255);
                doc.rect(15, currentY, 180, 7, 'F');
                doc.text(marca.toUpperCase(), 105, currentY + 5, { align: 'center' });
                doc.setTextColor(0, 0, 0);
                
                currentY += 10;

                // Preparar datos
                const tableData = productos.map(product => {
                    // USAR PRECIO POR UNIDAD (considerando cantidad por bulto)
                    const precioBase = getUnitPrice(product);

                    let precioVenta;
                    if (exportType === 'wholesale') {
                        precioVenta = applyRounding(precioBase * (1 + marginWholesale), roundingOption);
                    } else {
                        precioVenta = applyRounding(precioBase * (1 + marginRetail + commission), roundingOption);
                    }

                    return [
                        '____', // Espacio para cantidad
                        product.code || '',
                        product.description || '',
                        '$' + precioVenta.toFixed(2)
                    ];
                });

                // Tabla de productos
                doc.autoTable({
                    startY: currentY,
                    head: [['CANT.', 'CÃ“DIGO', 'DESCRIPCIÃ“N', 'PRECIO']],
                    body: tableData,
                    theme: 'grid',
                    headStyles: {
                        fillColor: [102, 126, 234],
                        textColor: [255, 255, 255],
                        fontSize: 9,
                        fontStyle: 'bold',
                        halign: 'center'
                    },
                    bodyStyles: {
                        fontSize: 8,
                        cellPadding: 3
                    },
                    columnStyles: {
                        0: { cellWidth: 15, halign: 'center' }, // CANT
                        1: { cellWidth: 25, halign: 'center' }, // CÃ“DIGO
                        2: { cellWidth: 100 }, // DESCRIPCIÃ“N
                        3: { cellWidth: 25, halign: 'right' } // PRECIO
                    },
                    margin: { left: 15, right: 15 },
                    didDrawPage: function (data) {
                        // Pie de pÃ¡gina
                        doc.setFontSize(8);
                        doc.setFont('helvetica', 'italic');
                        doc.text(companyData.name || 'BRUZZONE DISTRIBUIDORA', 105, 285, { align: 'center' });
                    }
                });

                currentY = doc.lastAutoTable.finalY + 5;

                // Nueva pÃ¡gina si queda poco espacio
                if (currentY > 240 && marcaIndex < marcasOrdenadas.length - 1) {
                    doc.addPage();
                    currentY = 20;
                }
            });

            // SECCIÃ“N FINAL
            if (currentY > 240) {
                doc.addPage();
                currentY = 20;
            }

            currentY += 5;
            doc.setFontSize(10);
            doc.setFont('helvetica', 'bold');
            doc.text('OBSERVACIONES:', 15, currentY);
            
            currentY += 7;
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(9);
            doc.line(15, currentY, 195, currentY);
            currentY += 6;
            doc.line(15, currentY, 195, currentY);
            currentY += 6;
            doc.line(15, currentY, 195, currentY);

            currentY += 15;
            doc.setFont('helvetica', 'bold');
            doc.text('Firma del Cliente: _____________________________', 15, currentY);

            // Guardar PDF
            const fechaArchivo = new Date().toISOString().split('T')[0];
            doc.save(`${filename}_${fechaArchivo}.pdf`);

            alert(`âœ… Orden de Pedido exportada a PDF\n\n` +
                  `ğŸ“¦ ${productsData.length} productos\n` +
                  `ğŸ·ï¸ ${marcasOrdenadas.length} marcas\n\n` +
                  `El cliente puede completar a mano o por WhatsApp.\n\n` +
                  `Archivo: ${filename}_${fechaArchivo}.pdf`);
        }

        function exportBackup() {
            const backup = {
                version: '2.0',
                date: new Date().toISOString(),
                suppliersData,
                productsData,
                ordersData,
                columnTemplates,
                clientsData,
                users,
                companyData,
                announcementsData,
                factoryOrdersData,
                stockData,
                stockEntriesData
            };

            const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `backup_bruzzone_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        function importBackup(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const backup = JSON.parse(e.target.result);
                    
                    if (!confirm('Â¿Restaurar backup? Se reemplazarÃ¡n todos los datos actuales.')) return;

                    // Restaurar todos los datos
                    suppliersData = backup.suppliersData || [];
                    productsData = backup.productsData || [];
                    ordersData = backup.ordersData || [];
                    clientsData = backup.clientsData || [];
                    columnTemplates = backup.columnTemplates || {};
                    factoryOrdersData = backup.factoryOrdersData || [];
                    stockData = backup.stockData || {};
                    stockEntriesData = backup.stockEntriesData || [];
                    announcementsData = backup.announcementsData || [];
                    
                    // Restaurar usuarios si existen
                    if (backup.users) {
                        users = backup.users;
                    }
                    
                    // Restaurar datos de empresa si existen
                    if (backup.companyData) {
                        companyData = backup.companyData;
                    }

                    console.log('ğŸ“¦ Backup cargado:');
                    console.log('- Proveedores:', suppliersData.length);
                    console.log('- Productos:', productsData.length);
                    console.log('- Pedidos:', ordersData.length);
                    console.log('- Clientes:', clientsData.length);

                    // Guardar en localStorage y Firebase
                    saveData();
                    saveUsers();
                    
                    // Actualizar interfaz
                    updateSuppliersTable();
                    updateSupplierSelect();
                    updateStats();
                    updateCatalog();
                    updateClientsTable();
                    updateOrdersTable();
                    updateTemplatesList();
                    updateCompanyInterface();

                    alert('âœ… Backup restaurado correctamente!\n\n' +
                          'ğŸ“¦ Proveedores: ' + suppliersData.length + '\n' +
                          'ğŸ·ï¸ Productos: ' + productsData.length + '\n' +
                          'ğŸ“‹ Pedidos: ' + ordersData.length + '\n' +
                          'ğŸ‘¥ Clientes: ' + clientsData.length);
                          
                } catch (error) {
                    console.error('Error importando backup:', error);
                    alert('âŒ Error al importar: ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        function clearAllData() {
            if (!confirm('âš ï¸ Â¿Eliminar TODOS los datos?')) return;

            suppliersData = [];
            productsData = [];
            columnTemplates = {};
            
            localStorage.clear();
            
            updateSuppliersTable();
            updateSupplierSelect();
            updateStats();
            updateCatalog();

            alert('âœ… Datos eliminados');
        }

        // FUNCIONES DE DEBUG
        function updateDebugInfo() {
            console.log('=== ACTUALIZANDO DEBUG INFO ===');
            
            document.getElementById('debugSupplierCount').textContent = suppliersData.length;
            
            const hasLocalStorage = localStorage.getItem('suppliersData') ? 'SÃ' : 'NO';
            document.getElementById('debugLocalStorage').textContent = hasLocalStorage;
            
            document.getElementById('debugLastUpdate').textContent = new Date().toLocaleTimeString();
            
            console.log('Proveedores en memoria:', suppliersData);
            console.log('Proveedores en localStorage:', localStorage.getItem('suppliersData'));
            
            alert(`Debug Info:\n\nProveedores en memoria: ${suppliersData.length}\nlocalStorage: ${hasLocalStorage}`);
        }

        function forceReloadTable() {
            console.log('=== FORZANDO RECARGA DE TABLA ===');
            console.log('Datos antes de recargar:', suppliersData);
            
            updateSuppliersTable();
            
            alert('Tabla recargada. Revisa la consola para mÃ¡s detalles.');
        }

        // Actualizar debug info al cargar
        setTimeout(() => {
            if (document.getElementById('debugSupplierCount')) {
                updateDebugInfo();
            }
        }, 1000);

        // ===== FUNCIONES DE CONFIGURACIÃ“N DE EMPRESA =====

        function loadCompanyData() {
            console.log('=== CARGANDO DATOS DE EMPRESA ===');
            
            const saved = localStorage.getItem('companyData');
            if (saved) {
                try {
                    companyData = JSON.parse(saved);
                    console.log('âœ… Datos de empresa cargados:', companyData);
                } catch (e) {
                    console.error('âŒ Error cargando datos de empresa:', e);
                }
            }

            // Actualizar formulario
            document.getElementById('companyName').value = companyData.name || 'BRUZZONE DISTRIBUIDORA';
            document.getElementById('companySlogan').value = companyData.slogan || 'MAYORISTA';
            document.getElementById('companyAddress').value = companyData.address || 'Dr. Carlos Rocha 128 - Alejandro Roca, CÃ³rdoba';
            document.getElementById('companyPhone').value = companyData.phone || '3585142098';
            document.getElementById('companyEmail').value = companyData.email || 'bruzzonedistribuidora@gmail.com';

            // Actualizar logo preview
            if (companyData.logo) {
                document.getElementById('logoPreview').src = companyData.logo;
                document.getElementById('logoPreview').style.display = 'block';
                document.getElementById('noLogoText').style.display = 'none';
            }

            // Actualizar interfaz
            updateCompanyInterface();
        }

        function saveCompanyData() {
            console.log('=== GUARDANDO DATOS DE EMPRESA ===');
            
            companyData.name = document.getElementById('companyName').value.trim();
            companyData.slogan = document.getElementById('companySlogan').value.trim();
            companyData.address = document.getElementById('companyAddress').value.trim();
            companyData.phone = document.getElementById('companyPhone').value.trim();
            companyData.email = document.getElementById('companyEmail').value.trim();

            if (!companyData.name) {
                alert('âš ï¸ El nombre de la empresa no puede estar vacÃ­o');
                return;
            }

            if (!companyData.email) {
                alert('âš ï¸ El email no puede estar vacÃ­o');
                return;
            }

            try {
                localStorage.setItem('companyData', JSON.stringify(companyData));
                console.log('âœ… Datos guardados:', companyData);
                
                // Guardar en Firebase
                saveToFirebase();
                
                updateCompanyInterface();
                
                alert('âœ… Datos de empresa guardados correctamente\n\nLos cambios se aplican en todo el sistema.');
            } catch (e) {
                console.error('âŒ Error guardando:', e);
                alert('Error al guardar: ' + e.message);
            }
        }

        function uploadLogo(event) {
            const file = event.target.files[0];
            if (!file) return;

            console.log('=== SUBIENDO LOGO ===');
            console.log('Archivo:', file.name, 'TamaÃ±o:', file.size);

            // Validar tamaÃ±o (500 KB mÃ¡ximo)
            if (file.size > 500000) {
                alert('âš ï¸ El archivo es muy grande. MÃ¡ximo 500 KB.');
                return;
            }

            // Validar tipo
            const validTypes = ['image/png', 'image/jpeg', 'image/jpg', 'image/svg+xml'];
            if (!validTypes.includes(file.type)) {
                alert('âš ï¸ Formato no vÃ¡lido. UsÃ¡ PNG, JPG o SVG.');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const base64 = e.target.result;
                companyData.logo = base64;
                
                // Mostrar preview
                document.getElementById('logoPreview').src = base64;
                document.getElementById('logoPreview').style.display = 'block';
                document.getElementById('noLogoText').style.display = 'none';
                
                console.log('âœ… Logo cargado en memoria');
                alert('âœ… Logo cargado. RecordÃ¡ hacer clic en "Guardar ConfiguraciÃ³n" para aplicar los cambios.');
            };
            
            reader.onerror = function() {
                alert('âŒ Error al leer el archivo');
            };

            reader.readAsDataURL(file);
        }

        function removeLogo() {
            if (!confirm('Â¿Eliminar el logo actual?')) return;

            companyData.logo = '';
            document.getElementById('logoPreview').style.display = 'none';
            document.getElementById('noLogoText').style.display = 'block';
            document.getElementById('logoFileInput').value = '';

            console.log('ğŸ—‘ï¸ Logo eliminado de memoria');
            alert('âœ… Logo eliminado. RecordÃ¡ hacer clic en "Guardar ConfiguraciÃ³n" para aplicar los cambios.');
        }

        function updateCompanyInterface() {
            console.log('=== ACTUALIZANDO INTERFAZ CON DATOS DE EMPRESA ===');
            
            // Actualizar todos los headers del sistema
            const headerInfos = document.querySelectorAll('.header-info h1');
            headerInfos.forEach(h1 => {
                h1.textContent = `ğŸ› ï¸ ${companyData.name}`;
            });

            const headerSlogans = document.querySelectorAll('.header-info > p:first-of-type');
            headerSlogans.forEach(p => {
                p.textContent = companyData.slogan;
            });

            // Actualizar datos de contacto en headers
            const contactDivs = document.querySelectorAll('.header-contact');
            contactDivs.forEach(div => {
                div.innerHTML = `
                    <p>ğŸ“ ${companyData.address}</p>
                    <p>ğŸ“± ${companyData.phone}</p>
                `;
            });

            // Actualizar logos si existen
            if (companyData.logo) {
                const logos = document.querySelectorAll('.header-logo');
                logos.forEach(logo => {
                    logo.src = companyData.logo;
                    logo.alt = `Logo ${companyData.name}`;
                });
            }

            console.log('âœ… Interfaz actualizada');
        }

        // ===== FUNCIONES DE GESTIÃ“N DE VENDEDORES =====

        function loadUsers() {
            const saved = localStorage.getItem('users');
            if (saved) {
                try {
                    const loadedUsers = JSON.parse(saved);
                    if (loadedUsers && loadedUsers.length > 0) {
                        users = loadedUsers;
                        console.log('âœ… Usuarios cargados:', users.length);
                    } else {
                        console.log('âš ï¸ localStorage vacÃ­o, usando usuarios por defecto');
                        saveUsers(); // Guardar el usuario admin por defecto
                    }
                } catch (e) {
                    console.error('âŒ Error cargando usuarios:', e);
                    saveUsers(); // Guardar el usuario admin por defecto
                }
            } else {
                console.log('âš ï¸ No hay usuarios guardados, usando usuario admin por defecto');
                saveUsers(); // Guardar el usuario admin por defecto
            }
            updateSellersTable();
        }

        function saveUsers() {
            localStorage.setItem('users', JSON.stringify(users));
            console.log('âœ… Usuarios guardados en localStorage');
            // TambiÃ©n guardar en Firebase
            saveToFirebase();
        }

        function addSeller() {
            const name = document.getElementById('newSellerName').value.trim();
            const username = document.getElementById('newSellerUsername').value.trim().toLowerCase();
            const password = document.getElementById('newSellerPassword').value;
            const passwordConfirm = document.getElementById('newSellerPasswordConfirm').value;
            const phone = document.getElementById('newSellerPhone').value.trim();
            const email = document.getElementById('newSellerEmail').value.trim();

            if (!name || !username || !password) {
                alert('âš ï¸ Por favor completÃ¡ nombre, usuario y contraseÃ±a');
                return;
            }

            if (password !== passwordConfirm) {
                alert('âš ï¸ Las contraseÃ±as no coinciden');
                return;
            }

            if (password.length < 4) {
                alert('âš ï¸ La contraseÃ±a debe tener al menos 4 caracteres');
                return;
            }

            if (!/^[a-z0-9]+$/.test(username)) {
                alert('âš ï¸ El usuario solo puede contener letras minÃºsculas y nÃºmeros');
                return;
            }

            if (users.find(u => u.username === username)) {
                alert('âš ï¸ Ya existe un usuario con ese nombre de usuario');
                return;
            }

            const newSeller = {
                username: username,
                password: password,
                role: 'seller',
                name: name,
                phone: phone,
                email: email,
                createdAt: new Date().toISOString()
            };

            users.push(newSeller);
            saveUsers();
            updateSellersTable();

            // Limpiar formulario
            document.getElementById('newSellerName').value = '';
            document.getElementById('newSellerUsername').value = '';
            document.getElementById('newSellerPassword').value = '';
            document.getElementById('newSellerPasswordConfirm').value = '';
            document.getElementById('newSellerPhone').value = '';
            document.getElementById('newSellerEmail').value = '';

            alert(`âœ… Vendedor agregado exitosamente\n\nUsuario: ${username}\nNombre: ${name}`);
        }

        function updateSellersTable() {
            const tbody = document.getElementById('sellersTableBody');
            const sellers = users.filter(u => u.role === 'seller');

            if (sellers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: #999;">No hay vendedores registrados.</td></tr>';
                return;
            }

            tbody.innerHTML = sellers.map((seller, index) => {
                const sellerOrders = ordersData.filter(o => o.salesperson === seller.name).length;
                const createdDate = new Date(seller.createdAt).toLocaleDateString('es-AR');

                return `
                    <tr>
                        <td><strong>${seller.name}</strong></td>
                        <td><code>${seller.username}</code></td>
                        <td>${seller.phone || '-'}</td>
                        <td>${seller.email || '-'}</td>
                        <td><span class="supplier-badge">${sellerOrders} pedidos</span></td>
                        <td>${createdDate}</td>
                        <td>
                            <button class="btn btn-warning btn-small" onclick="resetSellerPassword('${seller.username}')">ğŸ”‘ Resetear Pass</button>
                            <button class="btn btn-danger btn-small" onclick="deleteSeller('${seller.username}')">ğŸ—‘ï¸</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function resetSellerPassword(username) {
            const newPassword = prompt(`IngresÃ¡ la nueva contraseÃ±a para el usuario "${username}"`);
            if (!newPassword) return;

            if (newPassword.length < 4) {
                alert('âš ï¸ La contraseÃ±a debe tener al menos 4 caracteres');
                return;
            }

            const user = users.find(u => u.username === username);
            if (user) {
                user.password = newPassword;
                saveUsers();
                alert(`âœ… ContraseÃ±a actualizada para ${username}`);
            }
        }

        function deleteSeller(username) {
            const seller = users.find(u => u.username === username);
            if (!seller) return;

            const sellerOrders = ordersData.filter(o => o.salesperson === seller.name).length;
            
            if (!confirm(`Â¿Eliminar vendedor "${seller.name}"?\n\nPedidos asociados: ${sellerOrders}\n(Los pedidos NO se eliminarÃ¡n)`)) {
                return;
            }

            users = users.filter(u => u.username !== username);
            saveUsers();
            updateSellersTable();

            alert(`âœ… Vendedor eliminado: ${seller.name}`);
        }

        // ===== FUNCIONES DE GESTIÃ“N DE CLIENTES =====

        function addClient() {
            const name = document.getElementById('newClientName').value.trim();
            const username = document.getElementById('newClientUsername').value.trim().toLowerCase();
            const password = document.getElementById('newClientPassword').value;
            const passwordConfirm = document.getElementById('newClientPasswordConfirm').value;
            const taxId = document.getElementById('newClientTaxId').value.trim();
            const phone = document.getElementById('newClientPhone').value.trim();
            const email = document.getElementById('newClientEmail').value.trim();
            const address = document.getElementById('newClientAddress').value.trim();

            if (!name || !username || !password) {
                alert('âš ï¸ Por favor completÃ¡ nombre, usuario y contraseÃ±a');
                return;
            }

            if (password !== passwordConfirm) {
                alert('âš ï¸ Las contraseÃ±as no coinciden');
                return;
            }

            if (password.length < 4) {
                alert('âš ï¸ La contraseÃ±a debe tener al menos 4 caracteres');
                return;
            }

            if (!/^[a-z0-9]+$/.test(username)) {
                alert('âš ï¸ El usuario solo puede contener letras minÃºsculas y nÃºmeros');
                return;
            }

            if (clientsData.find(c => c.username === username) || users.find(u => u.username === username)) {
                alert('âš ï¸ Ya existe un usuario con ese nombre de usuario');
                return;
            }

            const newClient = {
                username: username,
                password: password,
                name: name,
                taxId: taxId,
                phone: phone,
                email: email,
                address: address,
                active: true,
                createdAt: new Date().toISOString()
            };

            clientsData.push(newClient);
            saveData();
            updateClientsTable();

            // Limpiar formulario
            document.getElementById('newClientName').value = '';
            document.getElementById('newClientUsername').value = '';
            document.getElementById('newClientPassword').value = '';
            document.getElementById('newClientPasswordConfirm').value = '';
            document.getElementById('newClientTaxId').value = '';
            document.getElementById('newClientPhone').value = '';
            document.getElementById('newClientEmail').value = '';
            document.getElementById('newClientAddress').value = '';

            alert(`âœ… Cliente registrado exitosamente\n\nNombre: ${name}\nUsuario: ${username}\nContraseÃ±a: ${password}\n\nÂ¡CompartÃ­ estas credenciales con el cliente!`);
        }

        function copySystemUrl() {
            const url = 'https://bruzzonedistribuidora.github.io/bruzzonedistribuidora';
            navigator.clipboard.writeText(url).then(() => {
                alert('âœ… URL copiada al portapapeles');
            }).catch(() => {
                // Fallback para navegadores que no soportan clipboard
                const textArea = document.createElement('textarea');
                textArea.value = url;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('âœ… URL copiada al portapapeles');
            });
        }

        function updateClientsTable() {
            const tbody = document.getElementById('clientsTableBody');

            if (clientsData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px; color: #999;">No hay clientes registrados aÃºn.</td></tr>';
                return;
            }

            tbody.innerHTML = clientsData.map(client => {
                const clientOrders = ordersData.filter(o => o.clientUsername === client.username).length;
                const createdDate = new Date(client.createdAt).toLocaleDateString('es-AR');
                const statusBadge = client.active ? 
                    '<span style="background: #4caf50; color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.9em;">Activo</span>' :
                    '<span style="background: #f44336; color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.9em;">Inactivo</span>';

                return `
                    <tr>
                        <td><strong>${client.name}</strong></td>
                        <td><code>${client.username}</code></td>
                        <td>${client.taxId || '-'}</td>
                        <td>${client.phone || '-'}</td>
                        <td>${client.email || '-'}</td>
                        <td><span class="supplier-badge">${clientOrders} pedidos</span></td>
                        <td>${statusBadge}</td>
                        <td>
                            <button class="btn btn-warning btn-small" onclick="resetClientPassword('${client.username}')">ğŸ”‘ Pass</button>
                            <button class="btn ${client.active ? 'btn-secondary' : 'btn-success'} btn-small" onclick="toggleClientStatus('${client.username}')">
                                ${client.active ? 'ğŸ”’' : 'âœ“'}
                            </button>
                            <button class="btn btn-danger btn-small" onclick="deleteClient('${client.username}')">ğŸ—‘ï¸</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function resetClientPassword(username) {
            const newPassword = prompt(`IngresÃ¡ la nueva contraseÃ±a para el cliente "${username}"`);
            if (!newPassword) return;

            if (newPassword.length < 4) {
                alert('âš ï¸ La contraseÃ±a debe tener al menos 4 caracteres');
                return;
            }

            const client = clientsData.find(c => c.username === username);
            if (client) {
                client.password = newPassword;
                saveData();
                alert(`âœ… ContraseÃ±a actualizada para ${username}\n\nNueva contraseÃ±a: ${newPassword}\n\nCompartÃ­ esta nueva contraseÃ±a con el cliente.`);
            }
        }

        function toggleClientStatus(username) {
            const client = clientsData.find(c => c.username === username);
            if (!client) return;

            client.active = !client.active;
            saveData();
            updateClientsTable();

            const status = client.active ? 'activado' : 'desactivado';
            alert(`âœ… Cliente ${status}: ${client.name}\n\n${client.active ? 'El cliente puede volver a ingresar al portal.' : 'El cliente no podrÃ¡ ingresar al portal hasta que lo actives nuevamente.'}`);
        }

        function deleteClient(username) {
            const client = clientsData.find(c => c.username === username);
            if (!client) return;

            const clientOrders = ordersData.filter(o => o.clientUsername === username).length;
            
            if (!confirm(`Â¿Eliminar cliente "${client.name}"?\n\nPedidos asociados: ${clientOrders}\n(Los pedidos NO se eliminarÃ¡n)`)) {
                return;
            }

            clientsData = clientsData.filter(c => c.username !== username);
            saveData();
            updateClientsTable();

            alert(`âœ… Cliente eliminado: ${client.name}`);
        }

        // ===== FUNCIONES DE GESTIÃ“N DE PEDIDOS =====

        function showNewOrderForm() {
            if (productsData.length === 0) {
                alert('âš ï¸ No hay productos en el catÃ¡logo. ImportÃ¡ productos primero.');
                return;
            }

            // Resetear pedido actual
            currentOrder = {
                items: [],
                buyer: {},
                delivery: {},
                transport: {}
            };

            // Mostrar formulario
            document.getElementById('ordersList').style.display = 'none';
            document.getElementById('newOrderForm').style.display = 'block';

            // Configurar vendedor y fecha
            document.getElementById('orderSalesperson').value = currentUser.name;
            document.getElementById('orderDate').value = new Date().toLocaleDateString('es-AR');

            // Ocultar secciÃ³n de productos hasta que se agregue alguno
            document.getElementById('orderItemsSection').style.display = 'none';

            console.log('ğŸ“ Formulario de nuevo pedido iniciado');
        }

        function showOrdersList() {
            document.getElementById('newOrderForm').style.display = 'none';
            document.getElementById('ordersList').style.display = 'block';
            updateOrdersTable();
        }

        function searchProductForOrder() {
            const searchTerm = document.getElementById('productSearchInput').value.trim().toLowerCase();
            const resultsDiv = document.getElementById('searchResults');

            if (searchTerm.length < 2) {
                resultsDiv.style.display = 'none';
                return;
            }

            const matches = productsData.filter(p => 
                (p.code && p.code.toString().toLowerCase().includes(searchTerm)) ||
                (p.description && p.description.toString().toLowerCase().includes(searchTerm)) ||
                (p.brand && p.brand.toString().toLowerCase().includes(searchTerm))
            ).slice(0, 10); // MÃ¡ximo 10 resultados

            if (matches.length === 0) {
                resultsDiv.innerHTML = '<div style="text-align: center; padding: 20px; color: #999;">No se encontraron productos</div>';
                resultsDiv.style.display = 'block';
                return;
            }

            const marginWholesale = parseFloat(document.getElementById('marginWholesale').value) / 100;
            const roundingOption = document.getElementById('roundingOption').value;

            resultsDiv.innerHTML = matches.map(p => {
                // Calcular precio mayorista sin IVA
                const precioBase = p.basePrice || (p.purchasePrice / (1 + (p.iva || 21) / 100));
                const precioMayorista = applyRounding(precioBase * (1 + marginWholesale), roundingOption);

                return `
                    <div class="product-card" onclick="selectProductForOrder('${p.code}')" style="cursor: pointer;">
                        <div style="display: grid; grid-template-columns: 100px 1fr 120px; gap: 15px; align-items: center;">
                            <div>
                                <strong style="color: #667eea;">${p.code || ''}</strong>
                            </div>
                            <div>
                                <div style="font-weight: 600;">${p.description || ''}</div>
                                <div style="font-size: 0.85em; color: #666;">
                                    <span class="brand-badge">${p.brand || ''}</span>
                                    <span class="supplier-badge">${p.supplier || ''}</span>
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 1.2em; font-weight: bold; color: #2e7d32;">
                                    $${precioMayorista.toFixed(2)}
                                </div>
                                <div style="font-size: 0.75em; color: #999;">Sin IVA</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            resultsDiv.style.display = 'block';
        }

        function selectProductForOrder(code) {
            const product = productsData.find(p => p.code === code);
            if (!product) return;

            selectedProductForOrder = product;
            document.getElementById('productSearchInput').value = `${product.code} - ${product.description}`;
            document.getElementById('searchResults').style.display = 'none';
            document.getElementById('productQuantityInput').focus();

            console.log('âœ… Producto seleccionado:', product.code);
        }

        function addProductToOrder() {
            if (!selectedProductForOrder) {
                alert('âš ï¸ Por favor seleccionÃ¡ un producto de la bÃºsqueda primero');
                return;
            }

            const quantity = parseInt(document.getElementById('productQuantityInput').value);
            if (!quantity || quantity <= 0) {
                alert('âš ï¸ IngresÃ¡ una cantidad vÃ¡lida');
                return;
            }

            // Verificar si el producto ya estÃ¡ en el pedido
            const existingItem = currentOrder.items.find(i => i.code === selectedProductForOrder.code);
            
            if (existingItem) {
                existingItem.quantity += quantity;
            } else {
                // Calcular precio mayorista sin IVA
                const marginWholesale = parseFloat(document.getElementById('marginWholesale').value) / 100;
                const roundingOption = document.getElementById('roundingOption').value;
                const precioBase = selectedProductForOrder.basePrice || (selectedProductForOrder.purchasePrice / (1 + (selectedProductForOrder.iva || 21) / 100));
                const precioUnitario = applyRounding(precioBase * (1 + marginWholesale), roundingOption);

                currentOrder.items.push({
                    code: selectedProductForOrder.code,
                    description: selectedProductForOrder.description,
                    brand: selectedProductForOrder.brand,
                    quantity: quantity,
                    unitPrice: precioUnitario,
                    subtotal: precioUnitario * quantity
                });
            }

            // Actualizar vista
            updateOrderItemsTable();

            // Limpiar bÃºsqueda
            clearSearch();

            console.log('âœ… Producto agregado al pedido');
        }

        function updateOrderItemsTable() {
            const tbody = document.getElementById('orderItemsTable');
            const section = document.getElementById('orderItemsSection');

            if (currentOrder.items.length === 0) {
                section.style.display = 'none';
                return;
            }

            section.style.display = 'block';

            tbody.innerHTML = currentOrder.items.map((item, index) => `
                <tr>
                    <td><strong>${item.code}</strong></td>
                    <td>${item.description}</td>
                    <td><span class="brand-badge">${item.brand}</span></td>
                    <td>
                        <input type="number" value="${item.quantity}" min="1" 
                               class="quantity-input" 
                               onchange="updateItemQuantity(${index}, this.value)"
                               style="width: 80px; padding: 8px; text-align: center; border: 2px solid #667eea; border-radius: 5px;">
                    </td>
                    <td>$${item.unitPrice.toFixed(2)}</td>
                    <td><strong>$${item.subtotal.toFixed(2)}</strong></td>
                    <td>
                        <button class="btn btn-danger btn-small" onclick="removeItemFromOrder(${index})">ğŸ—‘ï¸</button>
                    </td>
                </tr>
            `).join('');

            updateOrderSummary();
        }

        function updateItemQuantity(index, newQuantity) {
            const qty = parseInt(newQuantity);
            if (!qty || qty <= 0) {
                alert('âš ï¸ Cantidad invÃ¡lida');
                return;
            }

            currentOrder.items[index].quantity = qty;
            currentOrder.items[index].subtotal = currentOrder.items[index].unitPrice * qty;
            
            updateOrderItemsTable();
        }

        function removeItemFromOrder(index) {
            if (confirm('Â¿Eliminar este producto del pedido?')) {
                currentOrder.items.splice(index, 1);
                updateOrderItemsTable();
            }
        }

        function updateOrderSummary() {
            const totalItems = currentOrder.items.length;
            const totalUnits = currentOrder.items.reduce((sum, item) => sum + item.quantity, 0);
            const totalAmount = currentOrder.items.reduce((sum, item) => sum + item.subtotal, 0);

            document.getElementById('orderTotalItems').textContent = totalItems;
            document.getElementById('orderTotalUnits').textContent = totalUnits;
            document.getElementById('orderTotalAmount').textContent = '$' + totalAmount.toFixed(2);
        }

        function clearSearch() {
            document.getElementById('productSearchInput').value = '';
            document.getElementById('productQuantityInput').value = '1';
            document.getElementById('searchResults').style.display = 'none';
            selectedProductForOrder = null;
        }

        function showAllProducts() {
            document.getElementById('productSearchInput').value = 'A';
            searchProductForOrder();
        }

        function saveOrder() {
            // Validar datos del comprador
            const razonSocial = document.getElementById('buyerRazonSocial').value.trim();
            const cuit = document.getElementById('buyerCUIT').value.trim();
            const deliveryAddress = document.getElementById('deliveryAddress').value.trim();
            const deliveryCity = document.getElementById('deliveryCity').value.trim();

            if (!razonSocial || !cuit) {
                alert('âš ï¸ Por favor completÃ¡ RazÃ³n Social y CUIT del comprador');
                return;
            }

            if (!deliveryAddress || !deliveryCity) {
                alert('âš ï¸ Por favor completÃ¡ direcciÃ³n y localidad de entrega');
                return;
            }

            if (currentOrder.items.length === 0) {
                alert('âš ï¸ El pedido no tiene productos. AgregÃ¡ al menos un producto.');
                return;
            }

            // Crear objeto de pedido completo
            const order = {
                orderNumber: ordersData.length + 1,
                date: new Date().toISOString(),
                salesperson: currentUser.name,
                buyer: {
                    razonSocial: razonSocial,
                    cuit: cuit,
                    nombreFantasia: document.getElementById('buyerNombreFantasia').value.trim(),
                    phone: document.getElementById('buyerPhone').value.trim()
                },
                delivery: {
                    address: deliveryAddress,
                    city: deliveryCity,
                    province: document.getElementById('deliveryProvince').value.trim(),
                    zipCode: document.getElementById('deliveryZipCode').value.trim()
                },
                transport: {
                    company: document.getElementById('transportCompany').value.trim(),
                    type: document.getElementById('shippingType').value,
                    notes: document.getElementById('shippingNotes').value.trim()
                },
                items: [...currentOrder.items],
                totalItems: currentOrder.items.length,
                totalUnits: currentOrder.items.reduce((sum, item) => sum + item.quantity, 0),
                totalAmount: currentOrder.items.reduce((sum, item) => sum + item.subtotal, 0),
                status: 'pending'
            };

            ordersData.push(order);
            localStorage.setItem('ordersData', JSON.stringify(ordersData));

            console.log('âœ… Pedido guardado:', order);

            // Generar mensaje del pedido
            const mensaje = generarMensajePedido(order);

            // Mostrar opciones de envÃ­o
            mostrarOpcionesEnvio(order, mensaje);
        }

        function generarMensajePedido(order) {
            const fecha = new Date(order.date).toLocaleDateString('es-AR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });

            let mensaje = `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n`;
            mensaje += `ğŸ› ï¸ ${companyData.name}\n`;
            mensaje += `ğŸ“ NUEVO PEDIDO #${order.orderNumber}\n`;
            mensaje += `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n`;

            mensaje += `ğŸ“… FECHA: ${fecha}\n`;
            mensaje += `ğŸ‘¨â€ğŸ’¼ VENDEDOR: ${order.salesperson}\n\n`;

            mensaje += `ğŸ¢ DATOS DEL CLIENTE\n`;
            mensaje += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
            
            const buyerName = order.buyer?.razonSocial || order.buyer?.name || 'Cliente';
            const buyerCuit = order.buyer?.cuit || '-';
            
            mensaje += `RazÃ³n Social: ${buyerName}\n`;
            mensaje += `CUIT: ${buyerCuit}\n`;
            if (order.buyer?.nombreFantasia) {
                mensaje += `Nombre FantasÃ­a: ${order.buyer.nombreFantasia}\n`;
            }
            if (order.buyer?.phone) {
                mensaje += `TelÃ©fono: ${order.buyer.phone}\n`;
            }
            mensaje += `\n`;

            mensaje += `ğŸ“¦ DATOS DE ENVÃO\n`;
            mensaje += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
            mensaje += `DirecciÃ³n: ${order.delivery.address}\n`;
            mensaje += `Localidad: ${order.delivery.city}\n`;
            if (order.delivery.province) {
                mensaje += `Provincia: ${order.delivery.province}\n`;
            }
            if (order.delivery.zipCode) {
                mensaje += `CP: ${order.delivery.zipCode}\n`;
            }
            mensaje += `\n`;

            if (order.transport.company || order.transport.type) {
                mensaje += `ğŸšš TRANSPORTE\n`;
                mensaje += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
                if (order.transport.type) {
                    const tipoEnvio = {
                        'retira': 'Retira en local',
                        'domicilio': 'EnvÃ­o a domicilio',
                        'transporte': 'Por transporte'
                    }[order.transport.type] || order.transport.type;
                    mensaje += `Tipo: ${tipoEnvio}\n`;
                }
                if (order.transport.company) {
                    mensaje += `Empresa: ${order.transport.company}\n`;
                }
                if (order.transport.notes) {
                    mensaje += `Observaciones: ${order.transport.notes}\n`;
                }
                mensaje += `\n`;
            }

            mensaje += `ğŸ›’ DETALLE DE PRODUCTOS\n`;
            mensaje += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
            
            order.items.forEach((item, index) => {
                mensaje += `${index + 1}. ${item.code} - ${item.description}\n`;
                mensaje += `   Marca: ${item.brand}\n`;
                mensaje += `   Cantidad: ${item.quantity} unidades\n`;
                mensaje += `   Precio Unit: $${item.unitPrice.toFixed(2)}\n`;
                mensaje += `   Subtotal: $${item.subtotal.toFixed(2)}\n`;
                mensaje += `\n`;
            });

            mensaje += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
            mensaje += `ğŸ“Š RESUMEN\n`;
            mensaje += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
            mensaje += `Total Items: ${order.totalItems}\n`;
            mensaje += `Total Unidades: ${order.totalUnits}\n`;
            mensaje += `\n`;
            mensaje += `ğŸ’° TOTAL (Sin IVA): $${order.totalAmount.toFixed(2)}\n`;
            mensaje += `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n`;
            mensaje += `${companyData.name}\n`;
            mensaje += `ğŸ“ ${companyData.address}\n`;
            mensaje += `ğŸ“± ${companyData.phone}\n`;
            mensaje += `âœ‰ï¸ ${companyData.email}`;

            return mensaje;
        }

        function mostrarOpcionesEnvio(order, mensaje) {
            // Crear modal de opciones
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
            `;

            const content = document.createElement('div');
            content.style.cssText = `
                background: white;
                padding: 40px;
                border-radius: 15px;
                max-width: 600px;
                width: 90%;
                max-height: 90vh;
                overflow-y: auto;
            `;

            const buyerName = order.buyer?.razonSocial || order.buyer?.name || 'Cliente';
            
            content.innerHTML = `
                <h2 style="color: #667eea; margin-bottom: 20px; text-align: center;">
                    âœ… Pedido #${order.orderNumber} Guardado
                </h2>
                
                <div style="background: #e8f5e9; padding: 20px; border-radius: 10px; margin-bottom: 20px; text-align: center;">
                    <div style="font-size: 1.1em; margin-bottom: 10px;">
                        <strong>Cliente:</strong> ${buyerName}
                    </div>
                    <div style="font-size: 1.3em; color: #2e7d32; font-weight: bold;">
                        Total: $${order.totalAmount.toFixed(2)}
                    </div>
                    <div style="font-size: 0.9em; color: #666; margin-top: 5px;">
                        ${order.totalItems} productos â€¢ ${order.totalUnits} unidades
                    </div>
                </div>

                <h3 style="color: #333; margin-bottom: 15px; text-align: center;">
                    Â¿CÃ³mo querÃ©s enviar el pedido?
                </h3>

                <div style="display: grid; gap: 15px; margin-bottom: 20px;">
                    <button onclick="enviarPorWhatsApp(${order.orderNumber})" 
                            style="padding: 20px; background: #25D366; color: white; border: none; border-radius: 10px; font-size: 1.1em; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px;"
                            onmouseover="this.style.background='#20BA5A'" 
                            onmouseout="this.style.background='#25D366'">
                        <span style="font-size: 1.5em;">ğŸ“±</span>
                        <span>Enviar por WhatsApp</span>
                    </button>

                    <button onclick="enviarPorEmail(${order.orderNumber})" 
                            style="padding: 20px; background: #667eea; color: white; border: none; border-radius: 10px; font-size: 1.1em; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px;"
                            onmouseover="this.style.background='#5568d3'" 
                            onmouseout="this.style.background='#667eea'">
                        <span style="font-size: 1.5em;">âœ‰ï¸</span>
                        <span>Enviar por Email</span>
                    </button>

                    <button onclick="enviarPorAmbos(${order.orderNumber})" 
                            style="padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 10px; font-size: 1.1em; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px;">
                        <span style="font-size: 1.5em;">ğŸš€</span>
                        <span>Enviar por WhatsApp y Email</span>
                    </button>
                </div>

                <div style="text-align: center; padding-top: 20px; border-top: 2px solid #e0e0e0;">
                    <button onclick="cerrarModalEnvio()" 
                            style="padding: 15px 40px; background: #f5f5f5; color: #333; border: 2px solid #ddd; border-radius: 10px; font-size: 1em; font-weight: 600; cursor: pointer;"
                            onmouseover="this.style.background='#e0e0e0'" 
                            onmouseout="this.style.background='#f5f5f5'">
                        Cerrar (Solo Guardar)
                    </button>
                </div>

                <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-top: 20px; font-size: 0.9em;">
                    <strong>ğŸ’¡ Nota:</strong> El pedido ya estÃ¡ guardado en el sistema. 
                    Los botones de arriba te ayudan a enviar el resumen al contacto de la empresa.
                </div>
            `;

            modal.appendChild(content);
            document.body.appendChild(modal);

            // Guardar referencia al modal y mensaje
            window.currentOrderModal = modal;
            window.currentOrderMessage = mensaje;
        }

        function enviarPorWhatsApp(orderNumber) {
            const order = ordersData.find(o => o.orderNumber === orderNumber);
            if (!order) return;

            // Formatear nÃºmero de telÃ©fono (quitar guiones, espacios, etc)
            const phoneNumber = companyData.phone.replace(/\D/g, '');
            
            // Generar mensaje para WhatsApp
            const mensaje = window.currentOrderMessage;
            const mensajeEncoded = encodeURIComponent(mensaje);

            // Abrir WhatsApp Web con el mensaje
            const whatsappUrl = `https://wa.me/${phoneNumber}?text=${mensajeEncoded}`;
            
            window.open(whatsappUrl, '_blank');
            
            console.log('ğŸ“± Abriendo WhatsApp...');
            
            setTimeout(() => {
                cerrarModalEnvio();
            }, 1000);
        }

        function enviarPorEmail(orderNumber) {
            const order = ordersData.find(o => o.orderNumber === orderNumber);
            if (!order) return;

            const buyerName = order.buyer?.razonSocial || order.buyer?.name || 'Cliente';
            const mensaje = window.currentOrderMessage;
            const subject = `Pedido #${order.orderNumber} - ${buyerName}`;
            
            const mailtoLink = `mailto:${companyData.email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(mensaje)}`;
            
            window.location.href = mailtoLink;
            
            console.log('âœ‰ï¸ Abriendo cliente de email...');
            
            setTimeout(() => {
                cerrarModalEnvio();
            }, 1000);
        }

        function enviarPorAmbos(orderNumber) {
            // Enviar primero por WhatsApp
            enviarPorWhatsApp(orderNumber);
            
            // Esperar un momento y luego abrir email
            setTimeout(() => {
                enviarPorEmail(orderNumber);
            }, 1500);
        }

        function cerrarModalEnvio() {
            if (window.currentOrderModal) {
                document.body.removeChild(window.currentOrderModal);
                window.currentOrderModal = null;
                window.currentOrderMessage = null;
            }
            
            // Volver a la lista de pedidos
            showOrdersList();
        }

        function cancelOrder() {
            if (currentOrder.items.length > 0) {
                if (!confirm('Â¿Cancelar el pedido? Se perderÃ¡n todos los datos ingresados.')) {
                    return;
                }
            }

            showOrdersList();
        }

        function updateOrdersTable() {
            const tbody = document.getElementById('ordersTableBody');

            if (ordersData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px; color: #999;">No hay pedidos registrados.</td></tr>';
                return;
            }

            tbody.innerHTML = ordersData.map((order, index) => {
                const date = new Date(order.date).toLocaleDateString('es-AR');
                const statusClass = `status-${order.status}`;
                const statusText = {
                    'pending': 'Pendiente',
                    'confirmed': 'Confirmado',
                    'delivered': 'Entregado',
                    'cancelled': 'Cancelado'
                }[order.status] || 'Pendiente';

                // Validar que buyer exista
                const buyerName = order.buyer?.razonSocial || order.buyer?.name || 'Cliente';
                const buyerCuit = order.buyer?.cuit || '-';

                return `
                    <tr>
                        <td><strong>#${order.orderNumber}</strong></td>
                        <td>${date}</td>
                        <td>
                            <strong>${buyerName}</strong><br>
                            <small style="color: #666;">CUIT: ${buyerCuit}</small>
                        </td>
                        <td>${order.salesperson}</td>
                        <td>${order.totalItems || 0} items (${order.totalUnits || 0} unidades)</td>
                        <td><strong>$${(order.totalAmount || 0).toFixed(2)}</strong></td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        <td style="white-space: nowrap;">
                            <button class="btn btn-primary btn-small" onclick="viewOrderDetail(${index})" title="Ver detalle">ğŸ‘ï¸</button>
                            <button class="btn btn-warning btn-small" onclick="reenviarPedido(${index})" title="Reenviar">ğŸ“¤</button>
                            <button class="btn btn-danger btn-small" onclick="deleteOrder(${index})" title="Eliminar">ğŸ—‘ï¸</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function viewOrderDetail(index) {
            const order = ordersData[index];
            if (!order) return;

            const buyerName = order.buyer?.razonSocial || order.buyer?.name || 'Cliente';
            const buyerCuit = order.buyer?.cuit || '-';

            let itemsList = order.items.map(item => 
                `${item.code} - ${item.description} | Cant: ${item.quantity} | $${item.unitPrice.toFixed(2)} | Subtotal: $${item.subtotal.toFixed(2)}`
            ).join('\n');

            alert(`PEDIDO #${order.orderNumber}\n\n` +
                  `Cliente: ${buyerName}\n` +
                  `CUIT: ${buyerCuit}\n` +
                  `Vendedor: ${order.salesperson}\n` +
                  `Fecha: ${new Date(order.date).toLocaleDateString('es-AR')}\n\n` +
                  `PRODUCTOS:\n${itemsList}\n\n` +
                  `TOTAL: $${order.totalAmount.toFixed(2)}`);
        }

        function deleteOrder(index) {
            const order = ordersData[index];
            if (!order) return;

            const buyerName = order.buyer?.razonSocial || order.buyer?.name || 'Cliente';
            const confirmMessage = `Â¿ELIMINAR PEDIDO #${order.orderNumber}?\n\n` +
                                  `Cliente: ${buyerName}\n` +
                                  `Total: $${order.totalAmount.toFixed(2)}\n` +
                                  `Vendedor: ${order.salesperson}\n\n` +
                                  `âš ï¸ Esta acciÃ³n NO se puede deshacer`;

            if (!confirm(confirmMessage)) {
                return;
            }

            console.log('ğŸ—‘ï¸ Eliminando pedido:', order.orderNumber);

            // Eliminar del array
            ordersData.splice(index, 1);

            // Guardar en localStorage
            localStorage.setItem('ordersData', JSON.stringify(ordersData));

            // Actualizar stats e interfaz
            updateStats();
            updateOrdersTable();

            alert(`âœ… Pedido #${order.orderNumber} eliminado correctamente`);

            console.log('âœ… Pedido eliminado');
        }

        function reenviarPedido(index) {
            const order = ordersData[index];
            if (!order) return;

            console.log('ğŸ“¤ Reenviando pedido:', order.orderNumber);

            // Generar mensaje
            const mensaje = generarMensajePedido(order);
            const buyerName = order.buyer?.razonSocial || order.buyer?.name || 'Cliente';
            
            // Mostrar opciones de envÃ­o
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
            `;

            const content = document.createElement('div');
            content.style.cssText = `
                background: white;
                padding: 40px;
                border-radius: 15px;
                max-width: 600px;
                width: 90%;
            `;

            content.innerHTML = `
                <h2 style="color: #667eea; margin-bottom: 20px; text-align: center;">
                    ğŸ“¤ Reenviar Pedido #${order.orderNumber}
                </h2>
                
                <div style="background: #e3f2fd; padding: 20px; border-radius: 10px; margin-bottom: 20px; text-align: center;">
                    <div style="font-size: 1.1em; margin-bottom: 10px;">
                        <strong>Cliente:</strong> ${buyerName}
                    </div>
                    <div style="font-size: 1.3em; color: #1976d2; font-weight: bold;">
                        Total: $${order.totalAmount.toFixed(2)}
                    </div>
                </div>

                <div style="display: grid; gap: 15px; margin-bottom: 20px;">
                    <button onclick="enviarPorWhatsApp(${order.orderNumber})" 
                            style="padding: 20px; background: #25D366; color: white; border: none; border-radius: 10px; font-size: 1.1em; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px;">
                        <span style="font-size: 1.5em;">ğŸ“±</span>
                        <span>Enviar por WhatsApp</span>
                    </button>

                    <button onclick="enviarPorEmail(${order.orderNumber})" 
                            style="padding: 20px; background: #667eea; color: white; border: none; border-radius: 10px; font-size: 1.1em; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px;">
                        <span style="font-size: 1.5em;">âœ‰ï¸</span>
                        <span>Enviar por Email</span>
                    </button>

                    <button onclick="enviarPorAmbos(${order.orderNumber})" 
                            style="padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 10px; font-size: 1.1em; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px;">
                        <span style="font-size: 1.5em;">ğŸš€</span>
                        <span>Enviar por Ambos</span>
                    </button>
                </div>

                <div style="text-align: center;">
                    <button onclick="cerrarModalEnvio()" 
                            style="padding: 15px 40px; background: #f5f5f5; color: #333; border: 2px solid #ddd; border-radius: 10px; font-size: 1em; font-weight: 600; cursor: pointer;">
                        Cerrar
                    </button>
                </div>
            `;

            modal.appendChild(content);
            document.body.appendChild(modal);

            // Guardar referencia
            window.currentOrderModal = modal;
            window.currentOrderMessage = mensaje;
        }

        // ========================================
        // FUNCIONES DEL PORTAL DE CLIENTES
        // ========================================

        function showEmployeeLogin() {
            document.getElementById('employeeLoginBox').style.display = 'block';
            document.getElementById('clientLoginBox').style.display = 'none';
            document.getElementById('btnEmployeeLogin').classList.add('btn-primary');
            document.getElementById('btnEmployeeLogin').classList.remove('btn-secondary');
            document.getElementById('btnClientLogin').classList.remove('btn-success');
            document.getElementById('btnClientLogin').classList.add('btn-secondary');
        }

        function showClientLogin() {
            document.getElementById('employeeLoginBox').style.display = 'none';
            document.getElementById('clientLoginBox').style.display = 'block';
            document.getElementById('btnEmployeeLogin').classList.remove('btn-primary');
            document.getElementById('btnEmployeeLogin').classList.add('btn-secondary');
            document.getElementById('btnClientLogin').classList.add('btn-success');
            document.getElementById('btnClientLogin').classList.remove('btn-secondary');
        }

        async function clientLogin() {
            const username = document.getElementById('clientLoginUsername').value.trim();
            const password = document.getElementById('clientLoginPassword').value;
            const errorDiv = document.getElementById('clientLoginError');

            if (!username || !password) {
                errorDiv.textContent = 'âš ï¸ CompletÃ¡ todos los campos';
                return;
            }

            // Primero cargar datos de Firebase para tener la lista de clientes actualizada
            console.log('ğŸ”„ Cargando datos para verificar cliente...');
            await loadFromFirebase();

            const client = clientsData.find(c => c.username === username && c.password === password && c.active);

            if (client) {
                currentUser = { ...client, role: 'client' };
                sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
                
                // Ocultar login y mainSystem, mostrar clientPortal
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('mainSystem').style.display = 'none';
                document.getElementById('clientPortal').style.display = 'block';
                document.getElementById('clientUsername').textContent = client.name;
                
                loadClientData();
                loadClientCatalog();
                updateCartDisplay();
                loadClientOrders();
                loadClientBanners();
                
                // Mostrar la pestaÃ±a de catÃ¡logo por defecto
                showClientTab('clientCatalog', null);
                
                console.log('âœ… Cliente autenticado:', client.name);
            } else {
                errorDiv.textContent = 'âŒ Usuario o contraseÃ±a incorrectos';
            }
        }

        function showClientTab(tabName, evt) {
            console.log('ğŸ”„ Cambiando a pestaÃ±a:', tabName);
            
            document.querySelectorAll('#clientPortal .tab-content').forEach(tab => {
                tab.style.display = 'none';
            });
            
            document.querySelectorAll('#clientPortal .tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            const tabElement = document.getElementById(tabName);
            if (tabElement) {
                tabElement.style.display = 'block';
                console.log('âœ… PestaÃ±a', tabName, 'mostrada');
            } else {
                console.error('âŒ No se encontrÃ³ la pestaÃ±a:', tabName);
            }
            
            // Marcar el botÃ³n activo
            if (evt && evt.target) {
                evt.target.classList.add('active');
            } else {
                // Buscar el botÃ³n correspondiente y activarlo
                document.querySelectorAll('#clientPortal .tab-btn').forEach(btn => {
                    if (btn.textContent.toLowerCase().includes(tabName.replace('client', '').toLowerCase())) {
                        btn.classList.add('active');
                    }
                });
            }
        }

        function loadClientData() {
            if (!currentUser || currentUser.role !== 'client') return;

            const client = clientsData.find(c => c.username === currentUser.username);
            if (!client) return;

            document.getElementById('clientName').value = client.name || '';
            document.getElementById('clientTaxId').value = client.taxId || '';
            document.getElementById('clientPhone').value = client.phone || '';
            document.getElementById('clientEmail').value = client.email || '';
            document.getElementById('clientAddress').value = client.address || '';
        }

        function saveClientData() {
            if (!currentUser || currentUser.role !== 'client') return;

            const clientIndex = clientsData.findIndex(c => c.username === currentUser.username);
            if (clientIndex === -1) return;

            clientsData[clientIndex].name = document.getElementById('clientName').value.trim();
            clientsData[clientIndex].taxId = document.getElementById('clientTaxId').value.trim();
            clientsData[clientIndex].phone = document.getElementById('clientPhone').value.trim();
            clientsData[clientIndex].email = document.getElementById('clientEmail').value.trim();
            clientsData[clientIndex].address = document.getElementById('clientAddress').value.trim();

            saveData();
            alert('âœ… Datos guardados correctamente');
        }

        function loadClientCatalog() {
            console.log('ğŸ“‹ EJECUTANDO loadClientCatalog...');
            console.log('ğŸ“‹ Productos disponibles:', productsData.length);
            console.log('ğŸ“‹ MÃ¡rgenes:', marginSettingsMemory);
            
            const container = document.getElementById('clientCatalogContainer');
            console.log('ğŸ“‹ Container encontrado:', container ? 'SÃ' : 'NO');
            
            if (!container) {
                console.error('âŒ No se encontrÃ³ clientCatalogContainer');
                return;
            }
            
            if (productsData.length === 0) {
                console.log('âš ï¸ No hay productos en productsData');
                container.innerHTML = '<div style="text-align: center; padding: 60px; color: #999;"><h3>No hay productos disponibles</h3><p>El catÃ¡logo se estÃ¡ cargando...</p></div>';
                return;
            }

            // Usar mÃ¡rgenes de memoria (ya cargados de Firebase)
            const marginWholesale = parseFloat(marginSettingsMemory.marginWholesale || 20) / 100;
            const roundingOption = marginSettingsMemory.roundingOption || 'normal';
            
            console.log('ğŸ“‹ Margen mayorista:', marginWholesale);
            console.log('ğŸ“‹ Redondeo:', roundingOption);

            const porMarca = {};
            productsData.forEach(product => {
                const marca = product.brand || 'Sin Marca';
                if (!porMarca[marca]) porMarca[marca] = [];
                porMarca[marca].push(product);
            });

            const marcas = Object.keys(porMarca).sort();
            console.log('ğŸ“‹ Marcas encontradas:', marcas.length);

            try {
                container.innerHTML = marcas.map(marca => {
                    const productos = porMarca[marca];
                    
                    const productosHTML = productos.map(product => {
                        // Obtener cantidad por bulto
                        const cantidadBulto = product.cantidadBulto || product['Cantidad por Bulto'] || product['cantidad por bulto'] || 1;
                        
                        // Calcular precio por unidad
                        const precioCompra = parseFloat(product.purchasePrice) || 0;
                        const precioUnitario = precioCompra / cantidadBulto;
                        const precioMayoristaUnidad = applyRounding(precioUnitario * (1 + marginWholesale), roundingOption);

                        return `
                            <div class="product-card" style="display: grid; grid-template-columns: 100px 1fr 150px 100px; gap: 15px; align-items: center; padding: 15px; background: white; border: 2px solid #e0e0e0; border-radius: 10px; margin-bottom: 10px;">
                                <div><strong style="color: #667eea; font-size: 1.1em;">${product.code}</strong></div>
                                <div>
                                    <div style="font-weight: 600; margin-bottom: 5px;">${product.description}</div>
                                    <div style="font-size: 0.85em; color: #666;">
                                        <span class="supplier-badge">${product.supplier}</span>
                                        ${cantidadBulto > 1 ? `<span style="background: #ff9800; color: white; padding: 2px 8px; border-radius: 5px; margin-left: 5px;">ğŸ“¦ ${cantidadBulto} u/bulto</span>` : ''}
                                    </div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-size: 1.3em; font-weight: 700; color: #4caf50;">$${precioMayoristaUnidad.toFixed(2)}</div>
                                    <div style="font-size: 0.75em; color: #999;">Precio x unidad</div>
                                </div>
                                <div><button class="btn btn-success" onclick="addToCart('${product.code}', event)" style="width: 100%; padding: 12px 20px; font-size: 1.1em; font-weight: 600;">â• AGREGAR</button></div>
                            </div>
                        `;
                    }).join('');

                    return `
                        <div style="margin-bottom: 30px;">
                            <div style="background: #667eea; color: white; padding: 12px 20px; border-radius: 10px; margin-bottom: 15px;">
                                <h3 style="margin: 0; font-size: 1.2em;">â•â•â• ${marca.toUpperCase()} â•â•â•</h3>
                            </div>
                            ${productosHTML}
                        </div>
                    `;
                }).join('');
                
                console.log('âœ… CatÃ¡logo renderizado correctamente');
            } catch (error) {
                console.error('âŒ Error renderizando catÃ¡logo:', error);
                container.innerHTML = '<div style="text-align: center; padding: 60px; color: red;"><h3>Error cargando catÃ¡logo</h3><p>' + error.message + '</p></div>';
            }
        }

        function filterClientCatalog() {
            const searchTerm = document.getElementById('clientCatalogSearch').value.trim().toLowerCase();
            if (!searchTerm) {
                loadClientCatalog();
                return;
            }

            const filtered = productsData.filter(p => 
                (p.code && p.code.toString().toLowerCase().includes(searchTerm)) ||
                (p.description && p.description.toString().toLowerCase().includes(searchTerm)) ||
                (p.brand && p.brand.toString().toLowerCase().includes(searchTerm))
            );

            const container = document.getElementById('clientCatalogContainer');
            const marginWholesale = parseFloat(marginSettingsMemory.marginWholesale || 20) / 100;
            const roundingOption = marginSettingsMemory.roundingOption || 'normal';

            if (filtered.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;"><h3>No se encontraron productos</h3></div>';
                return;
            }

            container.innerHTML = filtered.map(product => {
                // Obtener cantidad por bulto
                const cantidadBulto = product.cantidadBulto || product['Cantidad por Bulto'] || product['cantidad por bulto'] || 1;
                
                // Calcular precio por unidad
                const precioCompra = parseFloat(product.purchasePrice) || 0;
                const precioUnitario = precioCompra / cantidadBulto;
                const precioMayoristaUnidad = applyRounding(precioUnitario * (1 + marginWholesale), roundingOption);

                return `
                    <div class="product-card" style="display: grid; grid-template-columns: 100px 1fr 150px 100px; gap: 15px; align-items: center; padding: 15px; background: white; border: 2px solid #e0e0e0; border-radius: 10px; margin-bottom: 10px;">
                        <div><strong style="color: #667eea; font-size: 1.1em;">${product.code}</strong></div>
                        <div>
                            <div style="font-weight: 600; margin-bottom: 5px;">${product.description}</div>
                            <div style="font-size: 0.85em; color: #666;">
                                <span class="brand-badge">${product.brand}</span>
                                ${cantidadBulto > 1 ? `<span style="background: #ff9800; color: white; padding: 2px 8px; border-radius: 5px; margin-left: 5px;">ğŸ“¦ ${cantidadBulto} u/bulto</span>` : ''}
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 1.3em; font-weight: 700; color: #4caf50;">$${precioMayoristaUnidad.toFixed(2)}</div>
                            <div style="font-size: 0.75em; color: #999;">Precio x unidad</div>
                        </div>
                        <div><button class="btn btn-success" onclick="addToCart('${product.code}')" style="width: 100%; padding: 12px 20px; font-size: 1.1em; font-weight: 600;">â• AGREGAR</button></div>
                    </div>
                `;
            }).join('');
        }

        function addToCart(productCode) {
            const product = productsData.find(p => p.code === productCode);
            if (!product) return;

            const existingItem = clientCart.find(item => item.code === productCode);
            
            if (existingItem) {
                existingItem.quantity++;
            } else {
                const marginWholesale = parseFloat(marginSettingsMemory.marginWholesale || 20) / 100;
                const roundingOption = marginSettingsMemory.roundingOption || 'normal';
                
                // Obtener cantidad por bulto
                const cantidadBulto = product.cantidadBulto || product['Cantidad por Bulto'] || product['cantidad por bulto'] || 1;
                
                // Calcular precio por unidad
                const precioCompra = parseFloat(product.purchasePrice) || 0;
                const precioUnitario = precioCompra / cantidadBulto;
                const precio = applyRounding(precioUnitario * (1 + marginWholesale), roundingOption);

                clientCart.push({
                    code: product.code,
                    description: product.description,
                    brand: product.brand,
                    price: precio,
                    quantity: 1,
                    cantidadBulto: cantidadBulto
                });
            }

            updateCartDisplay();
            
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = 'âœ“ Agregado';
            btn.style.background = '#4caf50';
            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.style.background = '';
            }, 1000);
        }

        function updateCartDisplay() {
            const cartItemsDiv = document.getElementById('cartItems');
            const cartSummary = document.getElementById('cartSummary');
            const cartCount = document.getElementById('cartCount');

            cartCount.textContent = clientCart.reduce((sum, item) => sum + item.quantity, 0);

            if (clientCart.length === 0) {
                cartItemsDiv.innerHTML = '<div style="text-align: center; padding: 60px; color: #999;"><div style="font-size: 4em; margin-bottom: 20px;">ğŸ›’</div><h3>Tu carrito estÃ¡ vacÃ­o</h3><p>AgregÃ¡ productos desde el catÃ¡logo</p></div>';
                cartSummary.style.display = 'none';
                return;
            }

            cartItemsDiv.innerHTML = clientCart.map((item, index) => `
                <div style="background: white; padding: 20px; border-radius: 10px; border: 2px solid #e0e0e0; margin-bottom: 15px;">
                    <div style="display: grid; grid-template-columns: 1fr auto; gap: 20px; align-items: center;">
                        <div>
                            <div style="font-weight: 600; font-size: 1.1em; margin-bottom: 5px;">${item.description}</div>
                            <div style="color: #666; font-size: 0.9em;">CÃ³digo: ${item.code} â€¢ <span class="brand-badge">${item.brand}</span></div>
                            <div style="margin-top: 10px; font-size: 1.1em; color: #4caf50;"><strong>$${item.price.toFixed(2)}</strong> <span style="font-size: 0.85em; color: #999;">c/u sin IVA</span></div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <div style="display: flex; align-items: center; gap: 10px; background: #f5f5f5; padding: 8px 15px; border-radius: 8px;">
                                <button onclick="updateCartQuantity(${index}, -1)" class="btn btn-small" style="padding: 5px 12px; background: #ff9800;">â–</button>
                                <strong style="font-size: 1.3em; min-width: 40px; text-align: center;">${item.quantity}</strong>
                                <button onclick="updateCartQuantity(${index}, 1)" class="btn btn-small" style="padding: 5px 12px; background: #4caf50;">â•</button>
                            </div>
                            <div style="text-align: right; min-width: 100px;"><div style="font-size: 1.3em; font-weight: 700; color: #667eea;">$${(item.price * item.quantity).toFixed(2)}</div></div>
                            <button onclick="removeFromCart(${index})" class="btn btn-danger btn-small">ğŸ—‘ï¸</button>
                        </div>
                    </div>
                </div>
            `).join('');

            const subtotal = clientCart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            document.getElementById('cartSubtotal').textContent = '$' + subtotal.toFixed(2);
            document.getElementById('cartTotal').textContent = '$' + subtotal.toFixed(2);
            cartSummary.style.display = 'block';
        }

        function updateCartQuantity(index, change) {
            if (index < 0 || index >= clientCart.length) return;
            clientCart[index].quantity += change;
            if (clientCart[index].quantity <= 0) clientCart.splice(index, 1);
            updateCartDisplay();
        }

        function removeFromCart(index) {
            if (confirm('Â¿Eliminar este producto del carrito?')) {
                clientCart.splice(index, 1);
                updateCartDisplay();
            }
        }

        function clearCart() {
            if (confirm('Â¿Vaciar todo el carrito?')) {
                clientCart = [];
                document.getElementById('orderNotes').value = '';
                updateCartDisplay();
            }
        }

        function submitClientOrder() {
            if (clientCart.length === 0) {
                alert('âš ï¸ El carrito estÃ¡ vacÃ­o');
                return;
            }

            const client = clientsData.find(c => c.username === currentUser.username);
            if (!client) {
                alert('âš ï¸ Error al obtener datos del cliente');
                return;
            }

            const order = {
                id: 'ORD-' + Date.now(),
                clientUsername: client.username,
                clientName: client.name,
                clientPhone: client.phone,
                clientEmail: client.email,
                clientAddress: client.address,
                items: clientCart.map(item => ({...item})),
                subtotal: clientCart.reduce((sum, item) => sum + (item.price * item.quantity), 0),
                notes: document.getElementById('orderNotes').value.trim(),
                status: 'Pendiente',
                createdAt: new Date().toISOString(),
                createdBy: 'client'
            };

            ordersData.push(order);
            saveData();

            alert(`âœ… Pedido enviado correctamente!\n\nNÃºmero de pedido: ${order.id}\n\nNos pondremos en contacto contigo pronto.`);

            clientCart = [];
            document.getElementById('orderNotes').value = '';
            updateCartDisplay();
            loadClientOrders();
            showClientTab('clientOrders', null);
        }

        // =============================================
        // FUNCIONES DE PUBLICIDADES/BANNERS
        // =============================================
        
        function addBanner() {
            const title = document.getElementById('newBannerTitle').value.trim();
            const message = document.getElementById('newBannerMessage').value.trim();
            const image = document.getElementById('newBannerImage').value.trim();
            const color = document.getElementById('newBannerColor').value;
            const expiry = document.getElementById('newBannerExpiry').value;
            const active = document.getElementById('newBannerActive').checked;
            
            if (!title || !message) {
                alert('âš ï¸ Por favor completÃ¡ el tÃ­tulo y el mensaje');
                return;
            }
            
            const banner = {
                id: 'BAN-' + Date.now(),
                title: title,
                message: message,
                image: image || null,
                color: color,
                expiry: expiry || null,
                active: active,
                createdAt: new Date().toISOString()
            };
            
            announcementsData.push(banner);
            saveData();
            updateBannersDisplay();
            
            // Limpiar formulario
            document.getElementById('newBannerTitle').value = '';
            document.getElementById('newBannerMessage').value = '';
            document.getElementById('newBannerImage').value = '';
            document.getElementById('newBannerColor').value = 'blue';
            document.getElementById('newBannerExpiry').value = '';
            document.getElementById('newBannerActive').checked = true;
            
            alert('âœ… Publicidad creada correctamente');
        }
        
        function updateBannersDisplay() {
            const container = document.getElementById('bannersContainer');
            if (!container) return;
            
            if (announcementsData.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;">No hay publicidades creadas aÃºn.</div>';
                return;
            }
            
            const colorStyles = {
                blue: { bg: '#e3f2fd', border: '#2196f3', text: '#1565c0' },
                green: { bg: '#e8f5e9', border: '#4caf50', text: '#2e7d32' },
                orange: { bg: '#fff3e0', border: '#ff9800', text: '#e65100' },
                red: { bg: '#ffebee', border: '#f44336', text: '#c62828' },
                purple: { bg: '#f3e5f5', border: '#9c27b0', text: '#7b1fa2' }
            };
            
            container.innerHTML = announcementsData.map(banner => {
                const style = colorStyles[banner.color] || colorStyles.blue;
                const statusBadge = banner.active 
                    ? '<span style="background: #4caf50; color: white; padding: 3px 10px; border-radius: 15px; font-size: 0.8em;">âœ… Activo</span>'
                    : '<span style="background: #9e9e9e; color: white; padding: 3px 10px; border-radius: 15px; font-size: 0.8em;">â¸ï¸ Pausado</span>';
                
                const expiryInfo = banner.expiry 
                    ? `<span style="color: #666; font-size: 0.85em;">ğŸ“… VÃ¡lido hasta: ${new Date(banner.expiry).toLocaleDateString()}</span>` 
                    : '';
                
                const imageHTML = banner.image 
                    ? `<img src="${banner.image}" alt="${banner.title}" style="max-width: 100%; max-height: 150px; border-radius: 8px; margin: 10px 0; object-fit: cover;">` 
                    : '';
                
                return `
                    <div style="background: ${style.bg}; border-left: 5px solid ${style.border}; padding: 20px; border-radius: 10px; margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                            <h4 style="color: ${style.text}; margin: 0;">${banner.title}</h4>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                ${statusBadge}
                                <button onclick="toggleBanner('${banner.id}')" class="btn" style="padding: 5px 10px; font-size: 0.85em; background: #607d8b; color: white;">
                                    ${banner.active ? 'â¸ï¸ Pausar' : 'â–¶ï¸ Activar'}
                                </button>
                                <button onclick="deleteBanner('${banner.id}')" class="btn btn-danger" style="padding: 5px 10px; font-size: 0.85em;">
                                    ğŸ—‘ï¸ Eliminar
                                </button>
                            </div>
                        </div>
                        ${imageHTML}
                        <p style="color: #333; margin: 0 0 10px 0;">${banner.message}</p>
                        ${expiryInfo}
                    </div>
                `;
            }).join('');
        }
        
        function toggleBanner(id) {
            const banner = announcementsData.find(b => b.id === id);
            if (banner) {
                banner.active = !banner.active;
                saveData();
                updateBannersDisplay();
            }
        }
        
        function deleteBanner(id) {
            if (!confirm('Â¿Eliminar esta publicidad?')) return;
            
            announcementsData = announcementsData.filter(b => b.id !== id);
            saveData();
            updateBannersDisplay();
            alert('âœ… Publicidad eliminada');
        }
        
        function loadClientBanners() {
            // Cargar banners activos en el portal de cliente
            const bannersSection = document.getElementById('clientBannersSection');
            const offersContainer = document.getElementById('clientOffersContainer');
            
            const activeBanners = announcementsData.filter(b => {
                if (!b.active) return false;
                if (b.expiry && new Date(b.expiry) < new Date()) return false;
                return true;
            });
            
            if (activeBanners.length === 0) {
                if (bannersSection) bannersSection.innerHTML = '';
                if (offersContainer) {
                    offersContainer.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;"><h3>No hay ofertas disponibles</h3><p>Pronto tendremos novedades para vos</p></div>';
                }
                return;
            }
            
            const colorStyles = {
                blue: { bg: '#e3f2fd', border: '#2196f3', text: '#1565c0' },
                green: { bg: '#e8f5e9', border: '#4caf50', text: '#2e7d32' },
                orange: { bg: '#fff3e0', border: '#ff9800', text: '#e65100' },
                red: { bg: '#ffebee', border: '#f44336', text: '#c62828' },
                purple: { bg: '#f3e5f5', border: '#9c27b0', text: '#7b1fa2' }
            };
            
            const bannersHTML = activeBanners.map(banner => {
                const style = colorStyles[banner.color] || colorStyles.blue;
                const imageHTML = banner.image 
                    ? `<img src="${banner.image}" alt="${banner.title}" style="width: 100%; max-height: 300px; border-radius: 10px; margin-bottom: 15px; object-fit: cover;">` 
                    : '';
                
                return `
                    <div style="background: ${style.bg}; border-left: 5px solid ${style.border}; padding: 20px; border-radius: 10px; margin-bottom: 15px;">
                        ${imageHTML}
                        <h4 style="color: ${style.text}; margin: 0 0 10px 0;">ğŸ ${banner.title}</h4>
                        <p style="color: #333; margin: 0;">${banner.message}</p>
                    </div>
                `;
            }).join('');
            
            if (bannersSection) bannersSection.innerHTML = bannersHTML;
            if (offersContainer) offersContainer.innerHTML = bannersHTML;
        }

        // =============================================
        // FUNCIONES DE PEDIDOS A FÃBRICA / PROVEEDORES
        // =============================================
        
        function showFactoryTab(tabName) {
            // Ocultar todos los tabs
            document.querySelectorAll('.factory-tab-content').forEach(tab => tab.style.display = 'none');
            
            // Resetear botones
            document.querySelectorAll('#factory-orders .btn').forEach(btn => {
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-secondary');
            });
            
            // Mostrar tab seleccionado
            const tab = document.getElementById('factory-' + tabName);
            if (tab) tab.style.display = 'block';
            
            // Activar botÃ³n correspondiente
            const btnMap = {
                'new-order': 'btnNewOrder',
                'stock-entry': 'btnStockEntry',
                'stock-control': 'btnStockControl',
                'order-history': 'btnOrderHistory',
                'low-stock': 'btnLowStock'
            };
            const activeBtn = document.getElementById(btnMap[tabName]);
            if (activeBtn) {
                activeBtn.classList.remove('btn-secondary');
                activeBtn.classList.add('btn-primary');
            }
            
            // Cargar datos segÃºn la pestaÃ±a
            if (tabName === 'new-order') {
                loadFactorySuppliers();
                document.getElementById('factoryOrderDate').value = new Date().toISOString().split('T')[0];
            } else if (tabName === 'stock-entry') {
                loadEntrySuppliers();
                document.getElementById('entryDate').value = new Date().toISOString().split('T')[0];
                loadStockEntriesHistory();
            } else if (tabName === 'stock-control') {
                loadStockControl();
            } else if (tabName === 'order-history') {
                loadFactoryOrderHistory();
            } else if (tabName === 'low-stock') {
                loadLowStockProducts();
            }
        }
        
        function loadFactorySuppliers() {
            const select = document.getElementById('factoryOrderSupplier');
            const historyFilter = document.getElementById('historySupplierFilter');
            const stockFilter = document.getElementById('stockSupplierFilter');
            
            const options = '<option value="">-- Seleccionar Proveedor --</option>' + 
                suppliersData.map(s => `<option value="${s.name}">${s.name}</option>`).join('');
            
            if (select) select.innerHTML = options;
            if (historyFilter) historyFilter.innerHTML = '<option value="">Todos los Proveedores</option>' + 
                suppliersData.map(s => `<option value="${s.name}">${s.name}</option>`).join('');
            if (stockFilter) stockFilter.innerHTML = '<option value="">Todos los Proveedores</option>' + 
                suppliersData.map(s => `<option value="${s.name}">${s.name}</option>`).join('');
        }
        
        function loadSupplierProducts() {
            const supplier = document.getElementById('factoryOrderSupplier').value;
            const container = document.getElementById('supplierProductsContainer');
            const tbody = document.getElementById('factoryProductsBody');
            const nameSpan = document.getElementById('selectedSupplierName');
            
            if (!supplier) {
                container.style.display = 'none';
                return;
            }
            
            container.style.display = 'block';
            nameSpan.textContent = supplier;
            currentFactoryOrder = { items: [], supplier: supplier, notes: '' };
            
            const products = productsData.filter(p => p.supplier === supplier);
            
            tbody.innerHTML = products.map(p => {
                const stock = stockData[p.code] || { current: 0, minimum: 0 };
                const basePrice = p.basePrice || p.purchasePrice || 0;
                const stockClass = stock.current <= stock.minimum ? 'color: #f44336; font-weight: bold;' : '';
                
                return `
                    <tr>
                        <td><strong>${p.code}</strong></td>
                        <td>${p.description}</td>
                        <td style="${stockClass}">${stock.current}</td>
                        <td>${stock.minimum}</td>
                        <td>$${parseFloat(basePrice).toFixed(2)}</td>
                        <td>
                            <input type="number" min="0" value="0" 
                                   id="qty-${p.code}" 
                                   onchange="updateFactoryOrderItem('${p.code}', this.value, ${basePrice})"
                                   style="width: 80px; padding: 8px; border-radius: 5px; border: 2px solid #e0e0e0; text-align: center;">
                        </td>
                        <td id="subtotal-${p.code}">$0.00</td>
                    </tr>
                `;
            }).join('');
            
            if (products.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px; color: #999;">No hay productos para este proveedor</td></tr>';
            }
            
            updateFactoryOrderTotal();
        }
        
        function updateFactoryOrderItem(code, qty, price) {
            const quantity = parseInt(qty) || 0;
            const subtotal = quantity * price;
            
            document.getElementById(`subtotal-${code}`).textContent = '$' + subtotal.toFixed(2);
            
            // Actualizar item en el pedido
            const existingIndex = currentFactoryOrder.items.findIndex(i => i.code === code);
            if (quantity > 0) {
                const product = productsData.find(p => p.code === code);
                const item = {
                    code: code,
                    description: product ? product.description : '',
                    quantity: quantity,
                    price: price,
                    subtotal: subtotal
                };
                if (existingIndex >= 0) {
                    currentFactoryOrder.items[existingIndex] = item;
                } else {
                    currentFactoryOrder.items.push(item);
                }
            } else if (existingIndex >= 0) {
                currentFactoryOrder.items.splice(existingIndex, 1);
            }
            
            updateFactoryOrderTotal();
        }
        
        function updateFactoryOrderTotal() {
            const total = currentFactoryOrder.items.reduce((sum, item) => sum + item.subtotal, 0);
            document.getElementById('factoryOrderTotal').textContent = '$' + total.toFixed(2);
        }
        
        function filterFactoryProducts() {
            const search = document.getElementById('factoryProductSearch').value.toLowerCase();
            const rows = document.querySelectorAll('#factoryProductsBody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(search) ? '' : 'none';
            });
        }
        
        function saveFactoryOrder() {
            if (!currentFactoryOrder.supplier) {
                alert('âŒ SeleccionÃ¡ un proveedor');
                return;
            }
            
            if (currentFactoryOrder.items.length === 0) {
                alert('âŒ AgregÃ¡ al menos un producto al pedido');
                return;
            }
            
            const order = {
                id: 'PF-' + Date.now(),
                supplier: currentFactoryOrder.supplier,
                items: [...currentFactoryOrder.items],
                total: currentFactoryOrder.items.reduce((sum, i) => sum + i.subtotal, 0),
                notes: document.getElementById('factoryOrderNotes').value,
                date: document.getElementById('factoryOrderDate').value,
                status: 'pendiente',
                createdAt: new Date().toISOString(),
                receivedItems: [] // Para control de recepciÃ³n
            };
            
            factoryOrdersData.push(order);
            saveToFirebase();
            
            alert(`âœ… Pedido ${order.id} guardado correctamente\n\nProveedor: ${order.supplier}\nProductos: ${order.items.length}\nTotal: $${order.total.toFixed(2)}`);
            
            // Limpiar formulario
            document.getElementById('factoryOrderSupplier').value = '';
            document.getElementById('factoryOrderNotes').value = '';
            document.getElementById('supplierProductsContainer').style.display = 'none';
            currentFactoryOrder = { items: [], supplier: '', notes: '' };
            
            updateFactoryStats();
        }
        
        function sendFactoryOrderWhatsApp() {
            if (!currentFactoryOrder.supplier || currentFactoryOrder.items.length === 0) {
                alert('âŒ Primero completÃ¡ el pedido');
                return;
            }
            
            const supplier = suppliersData.find(s => s.name === currentFactoryOrder.supplier);
            const phone = supplier && supplier.phone ? supplier.phone.replace(/\D/g, '') : '';
            
            let message = `*PEDIDO - ${companyData.name || 'BRUZZONE DISTRIBUIDORA'}*\n\n`;
            message += `ğŸ“… Fecha: ${document.getElementById('factoryOrderDate').value}\n`;
            message += `ğŸ­ Proveedor: ${currentFactoryOrder.supplier}\n\n`;
            message += `*PRODUCTOS:*\n`;
            
            currentFactoryOrder.items.forEach(item => {
                message += `â€¢ ${item.code} - ${item.description}\n`;
                message += `  Cantidad: ${item.quantity} | $${item.subtotal.toFixed(2)}\n`;
            });
            
            const total = currentFactoryOrder.items.reduce((sum, i) => sum + i.subtotal, 0);
            message += `\n*TOTAL: $${total.toFixed(2)}*\n`;
            
            const notes = document.getElementById('factoryOrderNotes').value;
            if (notes) message += `\nğŸ“ Notas: ${notes}`;
            
            const url = phone 
                ? `https://wa.me/${phone}?text=${encodeURIComponent(message)}`
                : `https://wa.me/?text=${encodeURIComponent(message)}`;
            
            window.open(url, '_blank');
        }
        
        function loadStockControl() {
            const tbody = document.getElementById('stockControlBody');
            loadFactorySuppliers();
            
            tbody.innerHTML = productsData.map(p => {
                const stock = stockData[p.code] || { current: 0, minimum: 0 };
                const status = stock.current <= stock.minimum 
                    ? '<span style="background: #f44336; color: white; padding: 4px 10px; border-radius: 10px;">âš ï¸ Bajo</span>'
                    : '<span style="background: #4caf50; color: white; padding: 4px 10px; border-radius: 10px;">âœ… OK</span>';
                
                return `
                    <tr data-supplier="${p.supplier}" data-search="${p.code} ${p.description}".toLowerCase()>
                        <td><strong>${p.code}</strong></td>
                        <td>${p.description}</td>
                        <td><span class="supplier-badge">${p.supplier}</span></td>
                        <td>
                            <input type="number" min="0" value="${stock.current}" 
                                   id="stock-current-${p.code}"
                                   style="width: 70px; padding: 5px; border-radius: 5px; border: 2px solid #e0e0e0; text-align: center;">
                        </td>
                        <td>
                            <input type="number" min="0" value="${stock.minimum}" 
                                   id="stock-min-${p.code}"
                                   style="width: 70px; padding: 5px; border-radius: 5px; border: 2px solid #e0e0e0; text-align: center;">
                        </td>
                        <td>${status}</td>
                        <td>
                            <button class="btn btn-primary btn-small" onclick="saveProductStock('${p.code}')">ğŸ’¾</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        function saveProductStock(code) {
            const current = parseInt(document.getElementById(`stock-current-${code}`).value) || 0;
            const minimum = parseInt(document.getElementById(`stock-min-${code}`).value) || 0;
            
            stockData[code] = { current, minimum };
            saveToFirebase();
            
            loadStockControl();
            updateFactoryStats();
        }
        
        function saveAllStock() {
            productsData.forEach(p => {
                const currentEl = document.getElementById(`stock-current-${p.code}`);
                const minEl = document.getElementById(`stock-min-${p.code}`);
                
                if (currentEl && minEl) {
                    stockData[p.code] = {
                        current: parseInt(currentEl.value) || 0,
                        minimum: parseInt(minEl.value) || 0
                    };
                }
            });
            
            saveToFirebase();
            alert('âœ… Stock guardado correctamente');
            loadStockControl();
            updateFactoryStats();
        }
        
        function filterStockBySupplier() {
            const supplier = document.getElementById('stockSupplierFilter').value;
            const rows = document.querySelectorAll('#stockControlBody tr');
            
            rows.forEach(row => {
                if (!supplier || row.dataset.supplier === supplier) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }
        
        function filterStockProducts() {
            const search = document.getElementById('stockProductSearch').value.toLowerCase();
            const rows = document.querySelectorAll('#stockControlBody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(search) ? '' : 'none';
            });
        }
        
        function loadFactoryOrderHistory() {
            const tbody = document.getElementById('factoryOrdersHistoryBody');
            loadFactorySuppliers();
            
            if (factoryOrdersData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: #999;">No hay pedidos registrados</td></tr>';
                return;
            }
            
            const statusColors = {
                pendiente: { bg: '#fff3e0', color: '#ff9800', text: 'Pendiente' },
                enviado: { bg: '#e3f2fd', color: '#2196f3', text: 'Enviado' },
                recibido: { bg: '#e8f5e9', color: '#4caf50', text: 'Recibido' },
                parcial: { bg: '#fff3e0', color: '#ff9800', text: 'Parcial' }
            };
            
            tbody.innerHTML = factoryOrdersData.slice().reverse().map(order => {
                const status = statusColors[order.status] || statusColors.pendiente;
                const fecha = new Date(order.date || order.createdAt).toLocaleDateString('es-AR');
                
                return `
                    <tr data-supplier="${order.supplier}" data-status="${order.status}">
                        <td><strong>${order.id}</strong></td>
                        <td>${fecha}</td>
                        <td><span class="supplier-badge">${order.supplier}</span></td>
                        <td>${order.items.length} productos</td>
                        <td><strong>$${order.total.toFixed(2)}</strong></td>
                        <td>
                            <span style="background: ${status.bg}; color: ${status.color}; padding: 5px 12px; border-radius: 15px; font-weight: 600;">
                                ${status.text}
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-primary btn-small" onclick="viewFactoryOrder('${order.id}')" title="Ver detalle">ğŸ‘ï¸</button>
                            ${order.status === 'pendiente' ? `<button class="btn btn-success btn-small" onclick="markOrderSent('${order.id}')" title="Marcar enviado">ğŸ“¤</button>` : ''}
                            ${order.status === 'enviado' ? `<button class="btn btn-success btn-small" onclick="receiveOrder('${order.id}')" title="Recibir pedido">ğŸ“¦</button>` : ''}
                            <button class="btn btn-danger btn-small" onclick="deleteFactoryOrder('${order.id}')" title="Eliminar">ğŸ—‘ï¸</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        function filterOrderHistory() {
            const supplier = document.getElementById('historySupplierFilter').value;
            const status = document.getElementById('historyStatusFilter').value;
            const rows = document.querySelectorAll('#factoryOrdersHistoryBody tr');
            
            rows.forEach(row => {
                const matchSupplier = !supplier || row.dataset.supplier === supplier;
                const matchStatus = !status || row.dataset.status === status;
                row.style.display = matchSupplier && matchStatus ? '' : 'none';
            });
        }
        
        function viewFactoryOrder(orderId) {
            const order = factoryOrdersData.find(o => o.id === orderId);
            if (!order) return;
            
            let details = `ğŸ“‹ PEDIDO ${order.id}\n\n`;
            details += `ğŸ“… Fecha: ${new Date(order.date || order.createdAt).toLocaleDateString('es-AR')}\n`;
            details += `ğŸ­ Proveedor: ${order.supplier}\n`;
            details += `ğŸ“Š Estado: ${order.status.toUpperCase()}\n\n`;
            details += `PRODUCTOS:\n`;
            
            order.items.forEach(item => {
                const received = order.receivedItems?.find(r => r.code === item.code);
                const receivedQty = received ? received.quantity : 0;
                details += `â€¢ ${item.code} - ${item.description}\n`;
                details += `  Pedido: ${item.quantity} | Recibido: ${receivedQty} | $${item.subtotal.toFixed(2)}\n`;
            });
            
            details += `\nTOTAL: $${order.total.toFixed(2)}`;
            if (order.notes) details += `\n\nğŸ“ Notas: ${order.notes}`;
            
            alert(details);
        }
        
        function markOrderSent(orderId) {
            const order = factoryOrdersData.find(o => o.id === orderId);
            if (!order) return;
            
            if (confirm(`Â¿Marcar pedido ${orderId} como ENVIADO?`)) {
                order.status = 'enviado';
                order.sentAt = new Date().toISOString();
                saveToFirebase();
                loadFactoryOrderHistory();
                updateFactoryStats();
            }
        }
        
        function receiveOrder(orderId) {
            const order = factoryOrdersData.find(o => o.id === orderId);
            if (!order) return;
            
            let html = `<h3>ğŸ“¦ Recibir Pedido ${orderId}</h3>`;
            html += `<p>IngresÃ¡ la cantidad recibida de cada producto:</p>`;
            html += `<div style="max-height: 300px; overflow-y: auto;">`;
            
            order.items.forEach(item => {
                html += `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee;">
                        <div>
                            <strong>${item.code}</strong> - ${item.description}<br>
                            <small>Pedido: ${item.quantity}</small>
                        </div>
                        <input type="number" min="0" max="${item.quantity}" value="${item.quantity}" 
                               id="receive-${item.code}" 
                               style="width: 80px; padding: 8px; border-radius: 5px; border: 2px solid #e0e0e0;">
                    </div>
                `;
            });
            
            html += `</div>`;
            
            // Crear modal simple
            const modal = document.createElement('div');
            modal.id = 'receiveModal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 10000;';
            modal.innerHTML = `
                <div style="background: white; padding: 25px; border-radius: 15px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;">
                    ${html}
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button class="btn btn-success" onclick="confirmReceiveOrder('${orderId}')" style="flex: 1;">âœ… Confirmar RecepciÃ³n</button>
                        <button class="btn btn-danger" onclick="document.getElementById('receiveModal').remove()" style="flex: 1;">âŒ Cancelar</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function confirmReceiveOrder(orderId) {
            const order = factoryOrdersData.find(o => o.id === orderId);
            if (!order) return;
            
            order.receivedItems = [];
            let allReceived = true;
            
            order.items.forEach(item => {
                const receivedQty = parseInt(document.getElementById(`receive-${item.code}`).value) || 0;
                order.receivedItems.push({
                    code: item.code,
                    quantity: receivedQty
                });
                
                if (receivedQty < item.quantity) allReceived = false;
                
                // Actualizar stock
                if (!stockData[item.code]) stockData[item.code] = { current: 0, minimum: 0 };
                stockData[item.code].current += receivedQty;
            });
            
            order.status = allReceived ? 'recibido' : 'parcial';
            order.receivedAt = new Date().toISOString();
            
            document.getElementById('receiveModal').remove();
            saveToFirebase();
            loadFactoryOrderHistory();
            updateFactoryStats();
            
            alert(`âœ… Pedido ${orderId} marcado como ${allReceived ? 'RECIBIDO' : 'RECIBIDO PARCIALMENTE'}\n\nEl stock ha sido actualizado.`);
        }
        
        function deleteFactoryOrder(orderId) {
            if (confirm(`Â¿Eliminar pedido ${orderId}? Esta acciÃ³n no se puede deshacer.`)) {
                factoryOrdersData = factoryOrdersData.filter(o => o.id !== orderId);
                saveToFirebase();
                loadFactoryOrderHistory();
                updateFactoryStats();
            }
        }
        
        function loadLowStockProducts() {
            const tbody = document.getElementById('lowStockBody');
            
            const lowStock = productsData.filter(p => {
                const stock = stockData[p.code] || { current: 0, minimum: 0 };
                return stock.minimum > 0 && stock.current <= stock.minimum;
            });
            
            if (lowStock.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: #4caf50;"><h3>âœ… Todo el stock estÃ¡ en niveles normales</h3></td></tr>';
                return;
            }
            
            tbody.innerHTML = lowStock.map(p => {
                const stock = stockData[p.code] || { current: 0, minimum: 0 };
                const faltan = stock.minimum - stock.current;
                
                return `
                    <tr>
                        <td><strong>${p.code}</strong></td>
                        <td>${p.description}</td>
                        <td><span class="supplier-badge">${p.supplier}</span></td>
                        <td style="color: #f44336; font-weight: bold;">${stock.current}</td>
                        <td>${stock.minimum}</td>
                        <td style="color: #f44336; font-weight: bold;">âš ï¸ ${faltan}</td>
                        <td>
                            <button class="btn btn-warning btn-small" onclick="quickAddToOrder('${p.code}', ${faltan})">â• Agregar a Pedido</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        function quickAddToOrder(code, suggestedQty) {
            const product = productsData.find(p => p.code === code);
            if (!product) return;
            
            // Cambiar a pestaÃ±a nuevo pedido
            showFactoryTab('new-order');
            
            // Seleccionar proveedor
            document.getElementById('factoryOrderSupplier').value = product.supplier;
            loadSupplierProducts();
            
            // Esperar a que se carguen los productos y establecer cantidad
            setTimeout(() => {
                const qtyInput = document.getElementById(`qty-${code}`);
                if (qtyInput) {
                    qtyInput.value = suggestedQty;
                    updateFactoryOrderItem(code, suggestedQty, product.basePrice || product.purchasePrice || 0);
                }
            }, 100);
        }
        
        function generateLowStockOrders() {
            const lowStock = productsData.filter(p => {
                const stock = stockData[p.code] || { current: 0, minimum: 0 };
                return stock.minimum > 0 && stock.current <= stock.minimum;
            });
            
            if (lowStock.length === 0) {
                alert('âœ… No hay productos con stock bajo');
                return;
            }
            
            // Agrupar por proveedor
            const bySupplier = {};
            lowStock.forEach(p => {
                if (!bySupplier[p.supplier]) bySupplier[p.supplier] = [];
                const stock = stockData[p.code] || { current: 0, minimum: 0 };
                bySupplier[p.supplier].push({
                    ...p,
                    suggestedQty: stock.minimum - stock.current
                });
            });
            
            let message = 'ğŸ“‹ PEDIDOS SUGERIDOS:\n\n';
            Object.keys(bySupplier).forEach(supplier => {
                message += `ğŸ­ ${supplier}:\n`;
                bySupplier[supplier].forEach(p => {
                    message += `  â€¢ ${p.code} - ${p.description}: ${p.suggestedQty} unidades\n`;
                });
                message += '\n';
            });
            
            alert(message + '\nÂ¿QuerÃ©s crear estos pedidos? AndÃ¡ a "Nuevo Pedido" y seleccionÃ¡ cada proveedor.');
        }
        
        function updateFactoryStats() {
            const pending = factoryOrdersData.filter(o => o.status === 'pendiente').length;
            const sent = factoryOrdersData.filter(o => o.status === 'enviado').length;
            const received = factoryOrdersData.filter(o => o.status === 'recibido').length;
            
            const lowStock = productsData.filter(p => {
                const stock = stockData[p.code] || { current: 0, minimum: 0 };
                return stock.minimum > 0 && stock.current <= stock.minimum;
            }).length;
            
            const pendingEl = document.getElementById('factoryOrdersPending');
            const sentEl = document.getElementById('factoryOrdersSent');
            const receivedEl = document.getElementById('factoryOrdersReceived');
            const lowStockEl = document.getElementById('lowStockCount');
            
            if (pendingEl) pendingEl.textContent = pending;
            if (sentEl) sentEl.textContent = sent;
            if (receivedEl) receivedEl.textContent = received;
            if (lowStockEl) lowStockEl.textContent = lowStock;
        }

        // =============================================
        // FUNCIONES DE ENTRADA DE MERCADERÃA
        // =============================================
        
        let stockEntriesData = []; // Historial de entradas de mercaderÃ­a
        let currentStockEntry = { items: [], supplier: '' };
        
        function loadEntryProducts() {
            const supplier = document.getElementById('entrySupplier').value;
            const container = document.getElementById('entryProductsContainer');
            const tbody = document.getElementById('entryProductsBody');
            const nameSpan = document.getElementById('entrySupplierName');
            
            if (!supplier) {
                container.style.display = 'none';
                return;
            }
            
            container.style.display = 'block';
            nameSpan.textContent = supplier;
            currentStockEntry = { items: [], supplier: supplier };
            
            const products = productsData.filter(p => p.supplier === supplier);
            
            tbody.innerHTML = products.map(p => {
                const stock = stockData[p.code] || { current: 0, minimum: 0 };
                
                return `
                    <tr>
                        <td><strong>${p.code}</strong></td>
                        <td>${p.description}</td>
                        <td id="entry-stock-${p.code}">${stock.current}</td>
                        <td>
                            <input type="number" min="0" value="0" 
                                   id="entry-qty-${p.code}" 
                                   onchange="updateEntryItem('${p.code}', this.value)"
                                   style="width: 100px; padding: 8px; border-radius: 5px; border: 2px solid #e0e0e0; text-align: center; font-size: 1.1em;">
                        </td>
                        <td id="entry-new-${p.code}" style="font-weight: bold; color: #4caf50;">${stock.current}</td>
                    </tr>
                `;
            }).join('');
            
            if (products.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px; color: #999;">No hay productos para este proveedor</td></tr>';
            }
            
            updateEntryTotal();
        }
        
        function updateEntryItem(code, qty) {
            const quantity = parseInt(qty) || 0;
            const stock = stockData[code] || { current: 0, minimum: 0 };
            const newStock = stock.current + quantity;
            
            document.getElementById(`entry-new-${code}`).textContent = newStock;
            
            // Actualizar item en la entrada
            const existingIndex = currentStockEntry.items.findIndex(i => i.code === code);
            if (quantity > 0) {
                const product = productsData.find(p => p.code === code);
                const item = {
                    code: code,
                    description: product ? product.description : '',
                    quantity: quantity,
                    previousStock: stock.current,
                    newStock: newStock
                };
                if (existingIndex >= 0) {
                    currentStockEntry.items[existingIndex] = item;
                } else {
                    currentStockEntry.items.push(item);
                }
            } else if (existingIndex >= 0) {
                currentStockEntry.items.splice(existingIndex, 1);
            }
            
            updateEntryTotal();
        }
        
        function updateEntryTotal() {
            const total = currentStockEntry.items.reduce((sum, item) => sum + item.quantity, 0);
            const count = currentStockEntry.items.length;
            document.getElementById('entryTotalProducts').textContent = `${count} productos (${total} unidades)`;
        }
        
        function filterEntryProducts() {
            const search = document.getElementById('entryProductSearch').value.toLowerCase();
            const rows = document.querySelectorAll('#entryProductsBody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(search) ? '' : 'none';
            });
        }
        
        function saveStockEntry() {
            if (!currentStockEntry.supplier) {
                alert('âŒ SeleccionÃ¡ un proveedor');
                return;
            }
            
            if (currentStockEntry.items.length === 0) {
                alert('âŒ IngresÃ¡ la cantidad recibida de al menos un producto');
                return;
            }
            
            const entry = {
                id: 'ENT-' + Date.now(),
                supplier: currentStockEntry.supplier,
                items: [...currentStockEntry.items],
                totalProducts: currentStockEntry.items.length,
                totalUnits: currentStockEntry.items.reduce((sum, i) => sum + i.quantity, 0),
                date: document.getElementById('entryDate').value || new Date().toISOString().split('T')[0],
                invoice: document.getElementById('entryInvoice').value,
                notes: document.getElementById('entryNotes').value,
                createdAt: new Date().toISOString()
            };
            
            // Actualizar stock de cada producto
            currentStockEntry.items.forEach(item => {
                if (!stockData[item.code]) {
                    stockData[item.code] = { current: 0, minimum: 0 };
                }
                stockData[item.code].current += item.quantity;
            });
            
            // Guardar en historial
            stockEntriesData.push(entry);
            
            // Guardar en Firebase
            saveToFirebase();
            
            alert(`âœ… Entrada de mercaderÃ­a registrada\n\nProveedor: ${entry.supplier}\nProductos: ${entry.totalProducts}\nUnidades totales: ${entry.totalUnits}\nRemito: ${entry.invoice || 'N/A'}`);
            
            // Limpiar formulario
            document.getElementById('entrySupplier').value = '';
            document.getElementById('entryInvoice').value = '';
            document.getElementById('entryNotes').value = '';
            document.getElementById('entryProductsContainer').style.display = 'none';
            currentStockEntry = { items: [], supplier: '' };
            
            // Actualizar historial y estadÃ­sticas
            loadStockEntriesHistory();
            updateFactoryStats();
        }
        
        function loadStockEntriesHistory() {
            const tbody = document.getElementById('stockEntriesHistoryBody');
            
            if (!stockEntriesData || stockEntriesData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 30px; color: #999;">No hay entradas registradas</td></tr>';
                return;
            }
            
            tbody.innerHTML = stockEntriesData.slice().reverse().slice(0, 20).map(entry => {
                const fecha = new Date(entry.date || entry.createdAt).toLocaleDateString('es-AR');
                
                return `
                    <tr>
                        <td>${fecha}</td>
                        <td><span class="supplier-badge">${entry.supplier}</span></td>
                        <td>${entry.invoice || '-'}</td>
                        <td>${entry.totalProducts}</td>
                        <td><strong>${entry.totalUnits}</strong></td>
                        <td>
                            <button class="btn btn-primary btn-small" onclick="viewStockEntry('${entry.id}')" title="Ver detalle">ğŸ‘ï¸</button>
                            <button class="btn btn-danger btn-small" onclick="deleteStockEntry('${entry.id}')" title="Eliminar">ğŸ—‘ï¸</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        function viewStockEntry(entryId) {
            const entry = stockEntriesData.find(e => e.id === entryId);
            if (!entry) return;
            
            let details = `ğŸ“¥ ENTRADA DE MERCADERÃA\n\n`;
            details += `ğŸ“… Fecha: ${new Date(entry.date || entry.createdAt).toLocaleDateString('es-AR')}\n`;
            details += `ğŸ­ Proveedor: ${entry.supplier}\n`;
            details += `ğŸ“„ Remito/Factura: ${entry.invoice || 'N/A'}\n\n`;
            details += `PRODUCTOS RECIBIDOS:\n`;
            
            entry.items.forEach(item => {
                details += `â€¢ ${item.code} - ${item.description}\n`;
                details += `  Cantidad: ${item.quantity} (${item.previousStock} â†’ ${item.newStock})\n`;
            });
            
            details += `\nTOTAL: ${entry.totalProducts} productos, ${entry.totalUnits} unidades`;
            if (entry.notes) details += `\n\nğŸ“ Notas: ${entry.notes}`;
            
            alert(details);
        }
        
        function deleteStockEntry(entryId) {
            const entry = stockEntriesData.find(e => e.id === entryId);
            if (!entry) return;
            
            if (confirm(`Â¿Eliminar esta entrada de mercaderÃ­a?\n\nNOTA: Esto NO revertirÃ¡ el stock. Si necesitÃ¡s corregir el stock, hacelo manualmente en "Control de Stock".`)) {
                stockEntriesData = stockEntriesData.filter(e => e.id !== entryId);
                saveToFirebase();
                loadStockEntriesHistory();
            }
        }
        
        function loadEntrySuppliers() {
            const select = document.getElementById('entrySupplier');
            if (!select) return;
            
            select.innerHTML = '<option value="">-- Seleccionar Proveedor --</option>' + 
                suppliersData.map(s => `<option value="${s.name}">${s.name}</option>`).join('');
        }

        function loadClientOrders() {
            if (!currentUser || currentUser.role !== 'client') return;

            const clientOrders = ordersData.filter(o => o.clientUsername === currentUser.username);
            const container = document.getElementById('clientOrdersList');

            if (clientOrders.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 60px; color: #999;"><div style="font-size: 4em; margin-bottom: 20px;">ğŸ“‹</div><h3>No tenÃ©s pedidos aÃºn</h3><p>Tus pedidos aparecerÃ¡n aquÃ­</p></div>';
                return;
            }

            container.innerHTML = clientOrders.reverse().map(order => {
                const fecha = new Date(order.createdAt).toLocaleDateString('es-AR');
                const statusColor = order.status === 'Pendiente' ? '#ff9800' : '#4caf50';
                
                return `
                    <div style="background: white; padding: 25px; border-radius: 15px; border: 2px solid #e0e0e0; margin-bottom: 20px;">
                        <div style="display: grid; grid-template-columns: 1fr auto; gap: 20px; margin-bottom: 20px;">
                            <div><h3 style="margin: 0; color: #667eea;">Pedido #${order.id}</h3><p style="margin: 5px 0 0 0; color: #666;">ğŸ“… ${fecha}</p></div>
                            <div><span style="display: inline-block; padding: 8px 20px; background: ${statusColor}; color: white; border-radius: 20px; font-weight: 600;">${order.status}</span></div>
                        </div>
                        <div style="background: #f5f5f5; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                            <h4 style="margin: 0 0 10px 0; color: #667eea;">Productos:</h4>
                            ${order.items.map(item => `
                                <div style="display: grid; grid-template-columns: 1fr auto auto; gap: 15px; padding: 8px 0; border-bottom: 1px solid #ddd;">
                                    <div><strong>${item.description}</strong></div>
                                    <div>${item.quantity} unid.</div>
                                    <div style="font-weight: 600;">$${(item.price * item.quantity).toFixed(2)}</div>
                                </div>
                            `).join('')}
                        </div>
                        <div style="text-align: right; font-size: 1.3em; font-weight: 700; color: #667eea; padding-top: 15px; border-top: 2px solid #ddd;">TOTAL: $${order.subtotal.toFixed(2)}</div>
                    </div>
                `;
            }).join('');
        }

        updateStats();
    
        // ===== CATÃLOGO VISUAL =====
        
        function updateVisualCatalog() {
            console.log('ğŸ¨ Actualizando CatÃ¡logo Visual');
            console.log('ğŸ“¦ Productos en array:', productsData.length);
            
            const content = document.getElementById('visualCatalogContent');
            const searchInput = document.getElementById('searchVisualCatalog');
            const brandFilter = document.getElementById('filterBrandVisual');
            
            if (!content || !searchInput || !brandFilter) {
                console.error('âŒ No se encontraron elementos necesarios');
                return;
            }
            
            const searchTerm = searchInput.value.toLowerCase();
            const brandFilterValue = brandFilter.value;
            
            // Ocultar paginaciÃ³n por defecto
            document.getElementById('visualPaginationTop').style.display = 'none';
            document.getElementById('visualPaginationBottom').style.display = 'none';
            
            if (productsData.length === 0) {
                console.log('âš ï¸ No hay productos para mostrar');
                content.innerHTML = `
                    <div style="text-align: center; padding: 40px 20px; color: #999;">
                        <div style="font-size: 3em; margin-bottom: 15px;">ğŸ“¦</div>
                        <h3 style="font-size: 1.3em;">No hay productos para mostrar</h3>
                        <p style="margin-top: 10px;">ImportÃ¡ productos desde la pestaÃ±a "ğŸ“¥ Importar Precios"</p>
                    </div>
                `;
                return;
            }

            console.log('âœ… Productos disponibles:', productsData.length);

            // Filtrar productos
            let filteredProducts = productsData.filter(p => {
                const matchesSearch = !searchTerm || 
                    (p.code && p.code.toLowerCase().includes(searchTerm)) || 
                    (p.description && p.description.toLowerCase().includes(searchTerm));
                const matchesBrand = !brandFilterValue || p.brand === brandFilterValue;
                return matchesSearch && matchesBrand;
            });

            console.log('ğŸ” Productos filtrados:', filteredProducts.length);

            if (filteredProducts.length === 0) {
                content.innerHTML = `
                    <div style="text-align: center; padding: 40px 20px; color: #999;">
                        <div style="font-size: 3em; margin-bottom: 15px;">ğŸ”</div>
                        <h3 style="font-size: 1.3em;">No se encontraron productos</h3>
                        <p style="margin-top: 10px;">ProbÃ¡ con otros tÃ©rminos de bÃºsqueda</p>
                    </div>
                `;
                return;
            }

            // PAGINACIÃ“N
            const totalItems = filteredProducts.length;
            const totalPages = Math.ceil(totalItems / itemsPerPageVisual);
            
            // Ajustar pÃ¡gina actual si es necesaria
            if (currentPageVisual > totalPages) {
                currentPageVisual = totalPages;
            }
            if (currentPageVisual < 1) {
                currentPageVisual = 1;
            }

            const startIndex = (currentPageVisual - 1) * itemsPerPageVisual;
            const endIndex = Math.min(startIndex + itemsPerPageVisual, totalItems);
            const productsToShow = filteredProducts.slice(startIndex, endIndex);

            console.log(`ğŸ“„ Mostrando pÃ¡gina ${currentPageVisual} de ${totalPages} (${productsToShow.length} productos)`);

            // Actualizar controles de paginaciÃ³n
            updatePaginationControls(currentPageVisual, totalPages, startIndex + 1, endIndex, totalItems);

            // Generar HTML (sin agrupar por marca para mejor performance)
            let html = '<div class="catalog-visual-grid">';
            
            productsToShow.forEach(product => {
                const imageUrl = product.imageUrl || '';
                const hasImage = imageUrl && imageUrl.trim() !== '';
                const price = product.purchasePrice || product.finalPrice || product.basePrice || 0;
                
                html += `
                    <div class="product-card" onclick="viewProductDetails('${(product.code || '').replace(/'/g, "\\'")}')">
                        <div class="product-card-image">
                            ${hasImage ? 
                                `<img src="${imageUrl}" alt="${product.description || 'Producto'}" style="width: 100%; height: 100%; object-fit: cover;" onerror="this.style.display='none'; this.parentElement.innerHTML='ğŸ“¦';">` : 
                                'ğŸ“¦'
                            }
                        </div>
                        <div class="product-card-body">
                            <div class="product-card-code">#${product.code || 'N/A'}</div>
                            <div class="product-card-title">${product.description || 'Sin descripciÃ³n'}</div>
                            <div class="brand-badge" style="display: inline-block; margin: 5px 0;">${product.brand || 'N/A'}</div>
                            <div class="product-card-price">$${price.toFixed(2)}</div>
                            <div style="margin-top: 8px; font-size: 0.85em; color: #666;">
                                <span class="supplier-badge">${product.supplier || 'N/A'}</span>
                            </div>
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            content.innerHTML = html;
            
            // Mostrar paginaciÃ³n si hay mÃ¡s de una pÃ¡gina
            if (totalPages > 1) {
                document.getElementById('visualPaginationTop').style.display = 'block';
                document.getElementById('visualPaginationBottom').style.display = 'block';
            }
            
            updateVisualBrandFilter();
        }

        function updatePaginationControls(currentPage, totalPages, showingFrom, showingTo, totalItems) {
            // Top pagination
            document.getElementById('visualShowingFrom').textContent = showingFrom;
            document.getElementById('visualShowingTo').textContent = showingTo;
            document.getElementById('visualTotalProducts').textContent = totalItems;
            document.getElementById('currentPageNumTop').textContent = currentPage;
            document.getElementById('totalPagesTop').textContent = totalPages;
            
            // Bottom pagination
            document.getElementById('visualShowingFrom2').textContent = showingFrom;
            document.getElementById('visualShowingTo2').textContent = showingTo;
            document.getElementById('visualTotalProducts2').textContent = totalItems;
            
            // Deshabilitar botones segÃºn la pÃ¡gina
            const btnPrevTop = document.getElementById('btnPrevTop');
            const btnNextTop = document.getElementById('btnNextTop');
            
            if (btnPrevTop) {
                btnPrevTop.disabled = currentPage === 1;
                btnPrevTop.style.opacity = currentPage === 1 ? '0.5' : '1';
            }
            
            if (btnNextTop) {
                btnNextTop.disabled = currentPage === totalPages;
                btnNextTop.style.opacity = currentPage === totalPages ? '0.5' : '1';
            }
        }

        function previousPageVisual() {
            if (currentPageVisual > 1) {
                currentPageVisual--;
                updateVisualCatalog();
                // Scroll al top del catÃ¡logo
                document.getElementById('visual-catalog').scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        function nextPageVisual() {
            currentPageVisual++;
            updateVisualCatalog();
            // Scroll al top del catÃ¡logo
            document.getElementById('visual-catalog').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function viewProductDetails(code) {
            const product = productsData.find(p => p.code === code);
            if (!product) return;

            const hasImage = product.imageUrl && product.imageUrl.trim() !== '';
            
            // Obtener los precios correctos
            const basePrice = product.basePrice || 0;
            const finalPrice = product.purchasePrice || 0;
            const cantidadBulto = product['Cantidad por Bulto'] || 1;
            
            const modal = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 20px;" onclick="closeProductModal(event)">
                    <div style="background: white; border-radius: 15px; max-width: 900px; width: 100%; max-height: 90vh; overflow-y: auto; padding: 30px;" onclick="event.stopPropagation()">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 2px solid #e0e0e0; padding-bottom: 15px;">
                            <h2 style="color: #667eea; margin: 0;">Detalles del Producto</h2>
                            <button onclick="closeProductModal()" style="background: #f44336; color: white; border: none; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; font-size: 1.2em;">âœ•</button>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                            <div>
                                <div style="width: 100%; height: 300px; background: #f5f5f5; border-radius: 10px; display: flex; align-items: center; justify-content: center; margin-bottom: 20px;">
                                    ${hasImage ? 
                                        `<img src="${product.imageUrl}" alt="${product.description || 'Producto'}" style="max-width: 100%; max-height: 100%; object-fit: contain;" onerror="this.parentElement.innerHTML='<div style=\\"font-size: 4em;\\">ğŸ“¦</div><small>Imagen no disponible</small>';">` : 
                                        '<div style="font-size: 4em;">ğŸ“¦</div>'
                                    }
                                </div>
                                
                                <div class="image-upload-section">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Agregar/Cambiar Imagen:</label>
                                    <input type="text" id="productImageUrl" value="${product.imageUrl || ''}" placeholder="URL de la imagen (https://...)" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; margin-bottom: 10px;">
                                    <small style="color: #666; display: block; margin-bottom: 10px;">PegÃ¡ la URL de la imagen del producto</small>
                                    <button onclick="updateProductImage('${(product.code || '').replace(/'/g, "\\'")}'))" class="btn btn-success" style="width: 100%;">ğŸ’¾ Guardar Imagen</button>
                                </div>
                            </div>
                            
                            <div>
                                <div style="margin-bottom: 15px;">
                                    <label style="color: #999; font-size: 0.9em;">CÃ³digo:</label>
                                    <div style="font-size: 1.2em; font-weight: 600; color: #667eea;">${product.code || 'N/A'}</div>
                                </div>
                                
                                <div style="margin-bottom: 15px;">
                                    <label style="color: #999; font-size: 0.9em;">DescripciÃ³n:</label>
                                    <div style="font-size: 1.1em;">${product.description || 'Sin descripciÃ³n'}</div>
                                </div>
                                
                                <div style="margin-bottom: 15px;">
                                    <label style="color: #999; font-size: 0.9em;">Marca:</label>
                                    <div><span class="brand-badge">${product.brand || 'N/A'}</span></div>
                                </div>
                                
                                <div style="margin-bottom: 15px;">
                                    <label style="color: #999; font-size: 0.9em;">Proveedor:</label>
                                    <div><span class="supplier-badge">${product.supplier || 'N/A'}</span></div>
                                </div>
                                
                                <div style="margin-bottom: 15px;">
                                    <label style="color: #999; font-size: 0.9em;">Precio Base (lista proveedor):</label>
                                    <div style="font-size: 1.1em;">$${basePrice.toFixed(2)}</div>
                                </div>
                                
                                <div style="margin-bottom: 15px;">
                                    <label style="color: #999; font-size: 0.9em;">Precio de Compra (con descuentos e IVA):</label>
                                    <div style="font-size: 1.8em; color: #4caf50; font-weight: bold;">$${finalPrice.toFixed(2)}</div>
                                </div>
                                
                                ${cantidadBulto > 1 ? `
                                <div style="margin-bottom: 15px;">
                                    <label style="color: #999; font-size: 0.9em;">Cantidad por Bulto:</label>
                                    <div style="font-size: 1.1em;">${cantidadBulto} unidades</div>
                                </div>
                                ` : ''}
                                
                                <div style="margin-bottom: 15px;">
                                    <label style="color: #999; font-size: 0.9em;">IVA aplicado:</label>
                                    <div style="font-size: 1em;">${product.iva || 21}%</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            const modalDiv = document.createElement('div');
            modalDiv.id = 'productModal';
            modalDiv.innerHTML = modal;
            document.body.appendChild(modalDiv);
        }

        function closeProductModal(event) {
            if (event && event.target !== event.currentTarget) return;
            const modal = document.getElementById('productModal');
            if (modal) modal.remove();
        }

        function updateProductImage(code) {
            const imageUrl = document.getElementById('productImageUrl').value.trim();
            const product = productsData.find(p => p.code === code);
            
            if (product) {
                product.imageUrl = imageUrl;
                saveData();
                alert('âœ… Imagen actualizada correctamente');
                closeProductModal();
                updateVisualCatalog();
            }
        }

        function updateVisualBrandFilter() {
            const select = document.getElementById('filterBrandVisual');
            if (!select) return;
            
            const brands = [...new Set(productsData.map(p => p.brand))].sort();
            
            const currentValue = select.value;
            select.innerHTML = '<option value="">Todas las Marcas</option>';
            brands.forEach(brand => {
                select.innerHTML += `<option value="${brand}">${brand}</option>`;
            });
            select.value = currentValue;
        }

        // Agregar event listener para bÃºsqueda en tiempo real
        setTimeout(function() {
            const searchInput = document.getElementById('searchVisualCatalog');
            if (searchInput) {
                searchInput.addEventListener('input', updateVisualCatalog);
            }
        }, 500);

        // INICIALIZAR DRAG-AND-DROP PARA CATÃLOGOS
        setTimeout(function() {
            const catalogUploadZone = document.getElementById('catalogUploadZone');
            const catalogFileInput = document.getElementById('catalogFileInput');

            if (catalogUploadZone && catalogFileInput) {
                // Click en el Ã¡rea para abrir selector de archivos
                catalogUploadZone.addEventListener('click', () => {
                    catalogFileInput.click();
                });

                // Drag and drop
                catalogUploadZone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    catalogUploadZone.style.borderColor = '#764ba2';
                    catalogUploadZone.style.background = '#f0f2ff';
                });

                catalogUploadZone.addEventListener('dragleave', () => {
                    catalogUploadZone.style.borderColor = '#667eea';
                    catalogUploadZone.style.background = '#f8f9ff';
                });

                catalogUploadZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    catalogUploadZone.style.borderColor = '#667eea';
                    catalogUploadZone.style.background = '#f8f9ff';
                    
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        catalogFileInput.files = files;
                        uploadCatalogFile();
                    }
                });

                // Cuando se selecciona archivo desde el input
                catalogFileInput.addEventListener('change', () => {
                    if (catalogFileInput.files.length > 0) {
                        uploadCatalogFile();
                    }
                });
            }
        }, 500);

        // =============================================
        // FUNCIONES DE ACTUALIZACIÃ“N DE PRECIOS
        // =============================================
        
        // Historial de aumentos
        let priceUpdateHistoryData = [];
        
        // Inicializar el select de proveedores para actualizaciÃ³n de precios
        function initPriceUpdateSupplierSelect() {
            const select = document.getElementById('priceUpdateSupplier');
            if (!select) return;
            
            select.innerHTML = '<option value="">-- Seleccionar proveedor --</option>';
            suppliersData.forEach((supplier, index) => {
                const productCount = productsData.filter(p => p.supplier === supplier.name).length;
                select.innerHTML += `<option value="${supplier.name}">${supplier.name} (${productCount} productos)</option>`;
            });
        }
        
        // Vista previa del aumento
        function previewPriceUpdate() {
            const supplierName = document.getElementById('priceUpdateSupplier').value;
            const percent = parseFloat(document.getElementById('priceUpdatePercent').value);
            
            if (!supplierName) {
                alert('âš ï¸ SeleccionÃ¡ un proveedor primero');
                return;
            }
            
            if (isNaN(percent)) {
                alert('âš ï¸ IngresÃ¡ un porcentaje vÃ¡lido');
                return;
            }
            
            const affectedProducts = productsData.filter(p => p.supplier === supplierName);
            
            if (affectedProducts.length === 0) {
                alert('âš ï¸ No hay productos de este proveedor');
                return;
            }
            
            // Mostrar vista previa
            const previewDiv = document.getElementById('priceUpdatePreview');
            const contentDiv = document.getElementById('priceUpdatePreviewContent');
            
            // Calcular algunos ejemplos
            const examples = affectedProducts.slice(0, 3).map(p => {
                const oldPrice = parseFloat(p.basePrice) || 0;
                const newPrice = oldPrice * (1 + percent / 100);
                return `â€¢ ${p.description?.substring(0, 30) || p.code}: $${oldPrice.toFixed(2)} â†’ $${newPrice.toFixed(2)}`;
            }).join('<br>');
            
            const totalProducts = affectedProducts.length;
            const action = percent >= 0 ? 'aumentar' : 'reducir';
            const absPercent = Math.abs(percent);
            
            contentDiv.innerHTML = `
                <strong>Proveedor:</strong> ${supplierName}<br>
                <strong>Productos afectados:</strong> ${totalProducts}<br>
                <strong>AcciÃ³n:</strong> ${action} ${absPercent}%<br>
                <br>
                <strong>Ejemplos:</strong><br>
                ${examples}
                ${totalProducts > 3 ? `<br><em>... y ${totalProducts - 3} productos mÃ¡s</em>` : ''}
            `;
            
            previewDiv.style.display = 'block';
        }
        
        // Aplicar el aumento de precios
        function applyPriceUpdate() {
            const supplierName = document.getElementById('priceUpdateSupplier').value;
            const percent = parseFloat(document.getElementById('priceUpdatePercent').value);
            
            if (!supplierName) {
                alert('âš ï¸ SeleccionÃ¡ un proveedor primero');
                return;
            }
            
            if (isNaN(percent)) {
                alert('âš ï¸ IngresÃ¡ un porcentaje vÃ¡lido');
                return;
            }
            
            const affectedProducts = productsData.filter(p => p.supplier === supplierName);
            
            if (affectedProducts.length === 0) {
                alert('âš ï¸ No hay productos de este proveedor');
                return;
            }
            
            const action = percent >= 0 ? 'AUMENTAR' : 'REDUCIR';
            const absPercent = Math.abs(percent);
            
            if (!confirm(`Â¿EstÃ¡s seguro de ${action} ${absPercent}% los precios de ${affectedProducts.length} productos de "${supplierName}"?\n\nEsta acciÃ³n modificarÃ¡ los precios base de todos los productos.`)) {
                return;
            }
            
            // Aplicar el aumento
            let updatedCount = 0;
            const multiplier = 1 + percent / 100;
            
            productsData.forEach(product => {
                if (product.supplier === supplierName) {
                    const oldBasePrice = parseFloat(product.basePrice) || 0;
                    product.basePrice = oldBasePrice * multiplier;
                    
                    // Recalcular el precio de compra con descuentos
                    const supplier = suppliersData.find(s => s.name === supplierName);
                    if (supplier) {
                        let price = product.basePrice;
                        price = price * (1 - (supplier.discount1 || 0) / 100);
                        price = price * (1 - (supplier.discount2 || 0) / 100);
                        price = price * (1 - (supplier.discount3 || 0) / 100);
                        price = price * (1 + (supplier.iva || 21) / 100);
                        product.purchasePrice = price;
                    }
                    
                    updatedCount++;
                }
            });
            
            // Registrar en historial
            const historyEntry = {
                date: new Date().toLocaleString('es-AR'),
                supplier: supplierName,
                percent: percent,
                productsAffected: updatedCount
            };
            
            priceUpdateHistoryData.unshift(historyEntry);
            if (priceUpdateHistoryData.length > 10) priceUpdateHistoryData.pop(); // Mantener Ãºltimos 10
            
            // Guardar
            saveData();
            updatePriceUpdateHistory();
            
            // Actualizar interfaces
            updateCatalog();
            updateVisualCatalog();
            
            // Limpiar formulario
            document.getElementById('priceUpdateSupplier').value = '';
            document.getElementById('priceUpdatePercent').value = '';
            document.getElementById('priceUpdatePreview').style.display = 'none';
            
            alert(`âœ… ${action.toLowerCase() === 'aumentar' ? 'Aumento' : 'ReducciÃ³n'} aplicado correctamente!\n\nâ€¢ Proveedor: ${supplierName}\nâ€¢ Porcentaje: ${percent > 0 ? '+' : ''}${percent}%\nâ€¢ Productos actualizados: ${updatedCount}`);
        }
        
        // Actualizar historial de aumentos
        function updatePriceUpdateHistory() {
            const container = document.getElementById('priceUpdateHistory');
            if (!container) return;
            
            if (priceUpdateHistoryData.length === 0) {
                container.innerHTML = '<p style="color: #999; font-size: 0.9em;">No hay aumentos registrados aÃºn.</p>';
                return;
            }
            
            container.innerHTML = priceUpdateHistoryData.map(entry => {
                const color = entry.percent >= 0 ? '#4caf50' : '#f44336';
                const icon = entry.percent >= 0 ? 'ğŸ“ˆ' : 'ğŸ“‰';
                return `
                    <div style="padding: 8px; border-bottom: 1px solid #e0e0e0; font-size: 0.9em;">
                        ${icon} <strong>${entry.supplier}</strong>: 
                        <span style="color: ${color}; font-weight: 600;">${entry.percent > 0 ? '+' : ''}${entry.percent}%</span>
                        (${entry.productsAffected} productos) - 
                        <span style="color: #999;">${entry.date}</span>
                    </div>
                `;
            }).join('');
        }
        
        // Buscar productos para ediciÃ³n manual
        function searchProductForPriceEdit() {
            const searchTerm = document.getElementById('manualPriceSearch').value.trim().toLowerCase();
            const resultsDiv = document.getElementById('manualPriceResults');
            
            if (searchTerm.length < 2) {
                resultsDiv.innerHTML = '<p style="padding: 20px; text-align: center; color: #999;">EscribÃ­ al menos 2 caracteres...</p>';
                return;
            }
            
            const results = productsData.filter(p => {
                const code = (p.code || '').toString().toLowerCase();
                const description = (p.description || '').toString().toLowerCase();
                const brand = (p.brand || '').toString().toLowerCase();
                return code.includes(searchTerm) || description.includes(searchTerm) || brand.includes(searchTerm);
            }).slice(0, 20); // Limitar a 20 resultados
            
            if (results.length === 0) {
                resultsDiv.innerHTML = '<p style="padding: 20px; text-align: center; color: #999;">No se encontraron productos</p>';
                return;
            }
            
            resultsDiv.innerHTML = results.map((p, idx) => `
                <div style="padding: 10px; border-bottom: 1px solid #e0e0e0; cursor: pointer; transition: background 0.2s;" 
                     onmouseover="this.style.background='#e3f2fd'" 
                     onmouseout="this.style.background='white'"
                     onclick="openEditPriceModal('${(p.code || '').replace(/'/g, "\\'")}')">
                    <div style="font-weight: 600; color: #333;">${p.code || 'S/C'}</div>
                    <div style="font-size: 0.85em; color: #666;">${p.description || 'Sin descripciÃ³n'}</div>
                    <div style="display: flex; justify-content: space-between; margin-top: 5px;">
                        <span style="color: #999; font-size: 0.8em;">${p.supplier || 'Sin proveedor'}</span>
                        <span style="color: #4caf50; font-weight: 600;">$${(parseFloat(p.basePrice) || 0).toFixed(2)}</span>
                    </div>
                </div>
            `).join('');
        }
        
        // Abrir modal para editar precio individual
        function openEditPriceModal(code) {
            const product = productsData.find(p => p.code === code);
            if (!product) {
                alert('Producto no encontrado');
                return;
            }
            
            const basePrice = parseFloat(product.basePrice) || 0;
            const purchasePrice = parseFloat(product.purchasePrice) || 0;
            
            const modal = `
                <div id="editPriceModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 20px;" onclick="closeEditPriceModal(event)">
                    <div style="background: white; border-radius: 15px; max-width: 500px; width: 100%; padding: 30px; box-shadow: 0 10px 40px rgba(0,0,0,0.3);" onclick="event.stopPropagation()">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #e0e0e0; padding-bottom: 15px;">
                            <h3 style="color: #667eea; margin: 0;">âœï¸ Editar Precio</h3>
                            <button onclick="closeEditPriceModal()" style="background: #f44336; color: white; border: none; width: 35px; height: 35px; border-radius: 50%; cursor: pointer; font-size: 1.1em;">âœ•</button>
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                            <div style="font-weight: 600; color: #667eea; margin-bottom: 5px;">${product.code || 'S/C'}</div>
                            <div style="color: #333;">${product.description || 'Sin descripciÃ³n'}</div>
                            <div style="color: #999; font-size: 0.85em; margin-top: 5px;">Proveedor: ${product.supplier || 'N/A'} | Marca: ${product.brand || 'N/A'}</div>
                        </div>
                        
                        <div class="input-group" style="margin-bottom: 15px;">
                            <label style="font-weight: 600; display: block; margin-bottom: 8px;">ğŸ’° Precio Base (Lista Proveedor)</label>
                            <input type="number" id="editProductBasePrice" value="${basePrice.toFixed(2)}" step="0.01" min="0" 
                                   style="width: 100%; padding: 12px; border: 2px solid #667eea; border-radius: 8px; font-size: 1.2em;"
                                   oninput="previewNewPurchasePrice('${code.replace(/'/g, "\\'")}')">
                            <small style="color: #666;">Este es el precio de lista del proveedor (sin descuentos ni IVA)</small>
                        </div>
                        
                        <div style="background: #e8f5e9; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span style="color: #666;">Precio actual de compra:</span>
                                <span style="font-weight: 600;">$${purchasePrice.toFixed(2)}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: #666;">Nuevo precio de compra:</span>
                                <span id="newPurchasePricePreview" style="font-weight: 600; color: #4caf50;">$${purchasePrice.toFixed(2)}</span>
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-secondary" onclick="closeEditPriceModal()" style="flex: 1; padding: 12px;">
                                Cancelar
                            </button>
                            <button class="btn btn-success" onclick="saveProductPrice('${code.replace(/'/g, "\\'")}')" style="flex: 1; padding: 12px;">
                                ğŸ’¾ Guardar Precio
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            const modalDiv = document.createElement('div');
            modalDiv.innerHTML = modal;
            document.body.appendChild(modalDiv.firstElementChild);
        }
        
        // Vista previa del nuevo precio de compra
        function previewNewPurchasePrice(code) {
            const product = productsData.find(p => p.code === code);
            if (!product) return;
            
            const newBasePrice = parseFloat(document.getElementById('editProductBasePrice').value) || 0;
            const supplier = suppliersData.find(s => s.name === product.supplier);
            
            let newPurchasePrice = newBasePrice;
            if (supplier) {
                newPurchasePrice = newPurchasePrice * (1 - (supplier.discount1 || 0) / 100);
                newPurchasePrice = newPurchasePrice * (1 - (supplier.discount2 || 0) / 100);
                newPurchasePrice = newPurchasePrice * (1 - (supplier.discount3 || 0) / 100);
                newPurchasePrice = newPurchasePrice * (1 + (supplier.iva || 21) / 100);
            }
            
            const previewEl = document.getElementById('newPurchasePricePreview');
            if (previewEl) {
                previewEl.textContent = `$${newPurchasePrice.toFixed(2)}`;
            }
        }
        
        // Guardar precio individual
        function saveProductPrice(code) {
            const product = productsData.find(p => p.code === code);
            if (!product) {
                alert('Producto no encontrado');
                return;
            }
            
            const newBasePrice = parseFloat(document.getElementById('editProductBasePrice').value);
            
            if (isNaN(newBasePrice) || newBasePrice < 0) {
                alert('âš ï¸ IngresÃ¡ un precio vÃ¡lido');
                return;
            }
            
            const oldPrice = parseFloat(product.basePrice) || 0;
            product.basePrice = newBasePrice;
            
            // Recalcular precio de compra
            const supplier = suppliersData.find(s => s.name === product.supplier);
            if (supplier) {
                let price = newBasePrice;
                price = price * (1 - (supplier.discount1 || 0) / 100);
                price = price * (1 - (supplier.discount2 || 0) / 100);
                price = price * (1 - (supplier.discount3 || 0) / 100);
                price = price * (1 + (supplier.iva || 21) / 100);
                product.purchasePrice = price;
            }
            
            // Guardar
            saveData();
            
            // Actualizar interfaces
            updateCatalog();
            updateVisualCatalog();
            
            // Cerrar modal
            closeEditPriceModal();
            
            // Limpiar bÃºsqueda
            document.getElementById('manualPriceSearch').value = '';
            document.getElementById('manualPriceResults').innerHTML = '<p style="padding: 20px; text-align: center; color: #999;">EscribÃ­ para buscar productos...</p>';
            
            alert(`âœ… Precio actualizado!\n\nâ€¢ Producto: ${product.code}\nâ€¢ Precio anterior: $${oldPrice.toFixed(2)}\nâ€¢ Nuevo precio: $${newBasePrice.toFixed(2)}`);
        }
        
        // Cerrar modal de ediciÃ³n de precio
        function closeEditPriceModal(event) {
            if (event && event.target !== event.currentTarget) return;
            const modal = document.getElementById('editPriceModal');
            if (modal) modal.remove();
        }
        
        // Inicializar select al cargar
        setTimeout(function() {
            initPriceUpdateSupplierSelect();
        }, 1000);

</script>

</body></html>
